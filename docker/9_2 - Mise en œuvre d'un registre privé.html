<kendo-pdf-export _ngcontent-uvf-c168="" papersize="A4" margin="2cm" id="div-book-content" class="col-12 col-sm-10 offset-0 div-book-content" uipath_custom_id="10"><div><app-page-content _ngcontent-uvf-c168="" _nghost-uvf-c166="" class="font-size-14 font-size-sm-20"><div _ngcontent-uvf-c166="" class="mainContent mt-4"><div _ngcontent-uvf-c166="" id="bookContent" class="bookContent"><div _ngcontent-uvf-c166="" id="content"><div class="sect1" style="abcpdf-tag-visible: true" id="AU_29cea9e2-4f25-4da3-adb3-a7a7a0566a7b" uri="ImagesUri_../download/5c180f28-f752-47db-98e8-8656c84b148d/images/">
      <h1 class="title">Mise en œuvre d’un registre privé<var style="display:none"> Registre</var></h1>
      <div class="sect2" id="refTitle0">
        <h2 class="title">1. Objectifs</h2>
        <p class="defaut">Dans le chapitre sur les images Docker, nous
avons longuement exploré les bonnes pratiques pour créer
une image, mais finalement peu parlé de comment stocker
et mettre à disposition le résultat, hormis une
explication de l’importance de Docker Hub dans l’écosystème
Docker ainsi qu’une démonstration de sauvegarde d’une pile
d’images en un fichier unique d’archive. Dans un contexte un peu
plus industriel (ce qui est l’objet du présent chapitre),
la manipulation de fichiers d’archive reste une approche&nbsp;un
peu simpliste et générant de gros volumes à transporter.
D’un autre côté, l’utilisation d’un registre,
même aussi sophistiqué que Docker Hub, peut être
rédhibitoire pour des raisons de confidentialité.
Heureusement, il existe une solution idéale cumulant les
avantages des deux solutions, à savoir le registre privé.</p>
        <p class="defaut">Nous avons vu précédemment
qu’il était possible de bénéficier dans
l’offre gratuite d’un dépôt privé pour
une image sur le registre Docker Hub, mais nous parlons ici de créer
notre propre registre, et donc de lever cette limitation. Les outils
nécessaires sont eux-mêmes gratuits, les coûts
résidant dans l’exploitation et l’hébergement éventuel
du serveur (ce qui ne veut pas dire qu’ils sont négligeables,
loin de là).</p>
        <p class="defaut">Il existe de nombreuses façons de
mettre en œuvre un registre privé Docker. Dans
les éditions précédentes, nous avons
montré comment mettre en œuvre un registre entièrement&nbsp;par
nos soins, en utilisant l’application <span class="courier11">registry</span> fournie
par Docker (sous forme, bien évidemment, d’une image Docker),
en la sécurisant, en gérant correctement les volumes
et en lui adjoignant un frontal d’authentification pour obtenir
une installation à peu près industrielle. Bien que
ces commandes aient un intérêt pédagogique,&nbsp;il
est apparu lors de l’écriture de la présente édition
que l’utilité réelle de ce mode de fonctionnement était
limitée, car des registres privés sont accessibles
en tant que services en ligne à des prix très
limités et avec des niveaux de sécurité bien
meilleurs que ce qu’on peut mettre en place en tant qu’équipe
indépendante.</p>
        <p class="defaut">L’utilisation de l’image <span class="courier11">registry</span> sera
donc montrée très rapidement, pour que les personnes
en ayant un besoin dans un périmètre restreint
comprennent comment la démarrer et quelles sont ses caractéristiques.
Par contre, nous ne parlerons pas de sécurisation&nbsp;ou
d’industrialisation de cette image, considérant que si
un vrai registre de production est nécessaire, il est beaucoup plus
sage de se tourner vers un fournisseur professionnel. Nous montrerons alors
une des options disponibles, à savoir Azure Container Registry.</p>
      </div>
      <div class="sect2" id="refTitle1">
        <h2 class="title">2. Votre registre en complète autonomie</h2>
        <div class="sect3" id="refTitle2">
          <h3 class="title">a. Image à utiliser</h3>
          <p class="defaut">Dans un premier temps, nous allons installer
nous-mêmes un registre sur une infrastructure&nbsp;que
nous maîtrisons, en commençant par le plus simple, à savoir
la machine&nbsp;locale qui a servi pour les exercices jusque-là.
Bien que ce ne soit pas obligatoire, car un registre d’images Docker
n’est qu’un serveur web comme un autre, exposant une API pour qu’on
consomme son service, quoi de plus logique qu’utiliser Docker justement
pour démarrer cette application serveur&nbsp;?</p>
          <p class="defaut">L’image correspondante est disponible sur
Docker Hub, où il suffit de la chercher par le mot-clé <span class="courier11">registry</span>. Aucune confusion n’est possible
avec une autre, car il s’agit d’une image officielle Docker, qui
de plus a été téléchargée plus
d’un milliard de fois, comme on peut le voir sur la capture ci-dessous.</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP01.png" title="images/08EP01.png" src="IMAGES/08EP01.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La capture montre que la version actuellement
recommandée est la 2.7.1.</p>
        </div>
        <div class="sect3" id="refTitle3">
          <h3 class="title">b. Lancement du registre</h3>
          <p class="defaut">Pour démarrer le conteneur avec l’application
registre, la commande suivante est utilisée&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">docker run -d <span class="hljs-comment">--name registrelocal -p 88:5000 -v &nbsp;</span>
/home/azureuser/registrelocal:/var/lib/registry <span class="hljs-comment">--restart always &nbsp;</span>
registry:2.7.1</code></pre>
          <p class="defaut">Les options utilisées sont les suivantes&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1"><span class="courier11">-d</span> permet
de lancer le conteneur en arrière-plan, ce qui est l’option
logique au vu du fonctionnement du registre en tant que serveur.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">--name</span> permet
de nommer le conteneur lancé, une bonne pratique pour pouvoir
facilement visionner les logs, entre autres.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">-p</span> permet
de rediriger le port 5000 exposé par l’image vers un port
local, en l’occurrence le port 88.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">-v</span> permet
de mettre en correspondance le volume exposé par l’image
avec un répertoire local&nbsp;; là encore,
il s’agit d’une bonne pratique logique, car, pour un système
qui permet de persister des images, il est important que ces images
ne soient surtout pas perdues en cas de mauvaise manipulation du conteneur.
Nous montrerons plus bas les effets de cette option plus en détail.
Bien sûr, le répertoire choisi pour le volume&nbsp;doit
avoir été créé auparavant (commande
Linux <span class="courier11">mkdir</span>).</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">--restart
always</span> force Docker à relancer automatiquement le
conteneur en cas de panne de l’applicatif, ce qui renforce la robustesse
du service, certains plantages n’étant pas toujours graves
ni reproductibles.</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Le lecteur se posera certainement la question
d’où trouver les informations comme quoi le port 5000 est
celui exposé, ainsi que le choix du répertoire
exact pour la redirection de volume. Ces informations peuvent être
retrouvées dans la page explicative du Docker Hub sur l’image <span class="courier11">registry</span>, et en particulier en analysant
le fichier <span class="courier11">Dockerfile</span>&nbsp;associé.
Pour cela, il suffit de cliquer sur le numéro de la version
ciblé dans la section nommée <b>Supported tags and respective Dockerfile links</b>.
Dans notre exemple sur la version 2.7.1, on voit aisément
dans le <span class="courier11">Dockerfile</span> les valeurs recherchées&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql"><span class="hljs-comment"># Build a minimal distribution container&nbsp;</span>
&nbsp;
FROM alpine:3.11&nbsp;
&nbsp;
RUN <span class="hljs-keyword">set</span> -ex \&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; apk <span class="hljs-keyword">add</span> <span class="hljs-comment">--no-cache ca-certificates&nbsp;</span>
&nbsp;
COPY ./registry /<span class="hljs-keyword">bin</span>/registry&nbsp;
COPY ./config-example.yml /etc/docker/registry/config.yml<b>&nbsp;
&nbsp;
VOLUME [<span class="hljs-string">"/var/lib/registry"</span>]&nbsp;
EXPOSE <span class="hljs-number">5000</span></b>&nbsp;
&nbsp;
COPY docker-entrypoint.sh /entrypoint.sh&nbsp;
ENTRYPOINT [<span class="hljs-string">"/entrypoint.sh"</span>]&nbsp;
&nbsp;
CMD [<span class="hljs-string">"/etc/docker/registry/config.yml"</span>]</code></pre>
          <p class="defaut">L’exécution de cette commande, après
un temps de téléchargement, rend la main et le
serveur est alors prêt pour utilisation.</p>
        </div>
        <div class="sect3" id="refTitle4">
          <h3 class="title">c. Utilisation du registre</h3>
          <p class="defaut">Comme expliqué précédemment,
un nom d’image simple, sans préfixe, correspond à l’utilisation
du dépôt par défaut de Docker dans Docker
Hub. Lorsqu’on souhaite utiliser un dépôt personnel
dans Docker Hub, il est nécessaire de préfixer
les images, d’où l’utilisation du préfixe <span class="courier11">jpgouigoux</span> dans les exemples précédents.</p>
          <p class="defaut">Pour utiliser un registre privé,
un autre niveau de préfixe est nécessaire, car
le dépôt est alors en dehors du Docker Hub lui-même.
Ainsi, dans notre cas, il sera nécessaire de préfixer
le nom complet de l’image par <span class="courier11">localhost:88</span> pour
pointer sur le bon serveur. Il serait bien sûr possible
de recompiler une image avec la bonne étiquette, mais comme
cela devrait normalement être bien acquis désormais,
une image n’est que le contenu binaire, et quitte à reproduire
le même contenu, autant directement placer la nouvelle étiquette
sur le contenu existant, ce que nous pouvons faire à l’aide
de la commande suivante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">docker tag jpgouigoux/repeater:1.0 &nbsp;
localhost:88/jpgouigoux/repeater:1.0</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que nous aurions
tout à fait pu changer radicalement le nom de l’étiquette
et que rien ne nous oblige, à part la consistance dans
les conventions de nommage, à reproduire le nom de l’étiquette
et sa version dans le second registre. De la même manière,&nbsp;utiliser
un identifiant de compte est indispensable dans le Docker Hub qui
est un registre public, mais vu que le registre mis en place sur
localhost:88 ne sert qu’à l’administrateur&nbsp;local,
une dénomination <span class="courier11">localhost:88/repeater:1.0</span> aurait
suffi. En fait, il est possible d’utiliser n’importe quelle combinaison
de noms, et la seule contrainte est que, dans le cas de Docker Hub,
seul l’utilisateur connecté avec un identifiant a les droits
d’écriture sur les images commençant par cet identifiant.</p>
            </div>
          </div>
          <p class="defaut">Une fois cette manipulation réalisée,
la commande <span class="courier11">docker push</span> est utilisable
pour déposer l’image et toutes ses couches sur le registre&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP02.png" title="images/08EP02.png" src="IMAGES/08EP02.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Une commande <span class="courier11">tree</span> dans
le répertoire <span class="courier11">registrelocal</span> qui
avait été créé pour l’occasion&nbsp;montre
non seulement que la commande s’est bien passée, mais aussi
le niveau&nbsp;de détail nécessaire pour la
gestion correcte de la persistance interne du registre&nbsp;:</p>
          <pre class="programlisting"><code class="hljs perl">azureuser@ClearDockerENI~ $ tree registrelocal/&nbsp;
registrelocal/&nbsp;
└── docker&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;└── registry&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└── v2&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├── blobs&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; └── sha256&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">2</span>d&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">2</span>d019dccbde5e29ffd1cd8c2b59a6dd799bb14e16cb610096763738163f98498&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">53</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">534</span>a5505201da9ddb334b5b2fcb3cec45fcafccd8e91b93ad4852e1a1bb318c1&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">61</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">6188</span>b5dd85a561897ea7d6b8e9b209e832e1e4dda95bf03691b33dec2d094319&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">74</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">741</span>ab223576c7691b3503deeb2fa2000d82ac70ba604dde6d69d9713d92a29a<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">84</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">84</span>d4b7a72cbb29054020dcf89bb0bceca666981471d2f749ffdc6a3ed7186e2e&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── <span class="hljs-number">99</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">990916</span>bd23bbbf9c30d202dad557e813562d028f3076bf57904830c69d4cde83&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── e6&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &nbsp;
e6ca3592b14484be6a9719617680e0c810e0107d89c437162c75d2401637c72c&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── data<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└── repositories&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└── jpgouigoux&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└── repeater</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├── _layers&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; └── sha256&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &nbsp;
<span class="hljs-number">2</span>d019dccbde5e29ffd1cd8c2b59a6dd799bb14e16cb610096763738163f98498&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &nbsp;
<span class="hljs-number">534</span>a5505201da9ddb334b5b2fcb3cec45fcafccd8e91b93ad4852e1a1bb318c1&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &nbsp;
<span class="hljs-number">6188</span>b5dd85a561897ea7d6b8e9b209e832e1e4dda95bf03691b33dec2d094319&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &nbsp;
<span class="hljs-number">741</span>ab223576c7691b3503deeb2fa2000d82ac70ba604dde6d69d9713d92a29a<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── &nbsp;
<span class="hljs-number">990916</span>bd23bbbf9c30d202dad557e813562d028f3076bf57904830c69d4cde83&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &nbsp;
e6ca3592b14484be6a9719617680e0c810e0107d89c437162c75d2401637c72c&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├── _manifests&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; ├── revisions&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; │&nbsp;&nbsp; └── sha256&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">84</span>d4b7a72cbb29054020dcf89bb0bceca666981471d2f749ffdc6a3ed7186e2e&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; │&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── <span class="hljs-keyword">link</span><b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp; └── tags&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── <span class="hljs-number">1.0</span></b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── current&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; │&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── <span class="hljs-keyword">index</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── sha256&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── &nbsp;
<span class="hljs-number">84</span>d4b7a72cbb29054020dcf89bb0bceca666981471d2f749ffdc6a3ed7186e2e&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── <span class="hljs-keyword">link</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;└── _uploads&nbsp;
&nbsp;
<span class="hljs-number">41</span> directories, <span class="hljs-number">16</span> files</code></pre>
        </div>
      </div>
      <div class="sect2" id="refTitle5">
        <h2 class="title">3. Les limites du mode autonome</h2>
        <p class="defaut">Mettre en place un registre complètement
autonome sur une architecture locale peut sembler simple si on se
cantonne à la précédente section. En
pratique, cette approche est extrêmement limitée
pour tout un tas de raisons que nous allons exposer ci-dessous.
Dans les précédentes éditions du présent
ouvrage, ces limites étaient patiemment levées
une par une en montrant comment améliorer la performance,
la sécurité, l’utilisabilité, etc. Mais
avec l’augmentation des exigences en termes de coût et
de confidentialité, il est apparu clairement que cette
approche de gestion en complète autonomie&nbsp;ne faisait
plus sens alors qu’on peut bénéficier d’un service
de très haute qualité à un prix réduit
sur n’importe quel cloud.</p>
        <p class="defaut">Il a donc été décidé de
continuer à exposer les limitations et les méthodes
pour les lever,&nbsp;mais sans décrire le détail
de leur mise en œuvre comme c’était le cas dans
les éditions précédentes. Le but des
sections ci-dessous est donc strictement pédagogique, l’usage
d’un registre géré entièrement par son
propriétaire semblant désormais en voie de disparition.</p>
        <div class="sect3" id="refTitle6">
          <h3 class="title">a. Limites en termes d’utilisation</h3>
          <p class="defaut">Une des premières limites de la section
précédente était que le registre était utilisable
sur la machine locale uniquement, ce qui est évidemment
peu utile, étant donné que celle-ci possède
déjà les images. Le registre ayant pour but de favoriser
le partage, son emplacement est logiquement sur un serveur accessible,
sinon au public (car dans ce cas, autant utiliser le registre public
Docker Hub), du moins à toutes les personnes auxquelles
le préparateur souhaite mettre à disposition ses
images, donc typiquement sur un réseau local.</p>
          <p class="defaut">On pourrait se dire que la modification par
rapport à la section précédente est très
simple et qu’il suffit de remplacer <span class="courier11">localhost</span> par
le nom ou l’IP de la machine choisie sur le réseau pour être
le serveur de registre d’images Docker. Pourtant, si nous avions
appliqué simplement cette modification, nous aurions été confrontés à un
message d’erreur de type <span class="courier11">server
gave HTTP response to HTTPS client</span>. Cela est dû au
fait que, par défaut, le démon Docker n’accepte
de parler avec un registre non sécurisé&nbsp;que
localement. Pour contrer ceci, une approche rapide mais moins sécurisée
consiste à ajouter dans les options du démon le
registre à autoriser. Par exemple&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sur la machine depuis laquelle vous souhaitez
accéder au registre, éditez le fichier <span class="courier11">/etc/docker/daemon.json</span>.
Il sera certainement nécessaire de préfixer la
commande par <span class="courier11">sudo</span>, des droits élevés étant
requis pour modifier ce fichier.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Ajoutez la ligne <span class="courier11">{ "insecure-registries":["machine:88"] }</span> en remplaçant
bien sûr <span class="courier11">machine</span> par le
nom DNS ou l’IP de celle que vous aurez utilisée comme
support de votre registre.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sauvegardez le fichier.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande <span class="courier11">sudo
systemctl restart docker</span> pour redémarrer le démon
Docker de façon qu’il prenne en compte le changement
de configuration.</p>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Bien que cela paraisse évident,
attention au fait qu’arrêter le démon
aboutira à l’arrêt de tous les conteneurs
lancés dessus. Ce rappel est juste dû au fait que
l’auteur, pour simuler un registre distant, utilisait en
fait une adresse DNS qui pointait par retour sur la machine locale.
Du coup, lors du changement de configuration sur le client, le serveur
qui était en pratique la même machine était également
remis à zéro, et le registre ne répondait
naturellement plus après, gratifiant logiquement l’appelant
d’un message <span class="courier11">getsockopt connection
refused</span>.</p>
            </div>
          </div>
          <p class="defaut">Ce type d’approche suffit dans un premier
temps pour mettre en place le genre d’échange ci-dessous,
où une machine dans un réseau sert de registre
(0), une autre pousse une image (1) et une troisième la
récupère (2), comme schématisé ci-dessous&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP03.png" title="images/08EP03.png" src="IMAGES/08EP03.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Comme le schéma le montre, il est
bien sûr important que les trois machines fassent partie
du même réseau (ici, 10.0.1.*) et que
les ports d’exposition du registre soient bien ouverts.</p>
        </div>
        <div class="sect3" id="refTitle7">
          <h3 class="title">b. Limites en termes de sécurité<var style="display:none"> Sécurité</var></h3>
          <p class="defaut">La façon de faire proposée
ci-dessus peut à la rigueur faire sens dans un environnement
très contraint de réseau fermé, mais
avec les approches de type "Zero Trust" consistant à traiter
tout réseau comme peu sûr pour ajouter des rideaux
défensifs de sécurité, elle n’est pas
recommandée. Plutôt que de débrayer un
système de sécurité et accepter des échanges
non chiffrés, la bonne pratique est donc de mettre en place
la cryptographie au niveau du démon Docker à l’aide
de certificats.</p>
          <p class="defaut">Toutes les options nécessaires sont
disponibles sur le paramétrage de Docker pour utiliser
le protocole de chiffrage TLS, mais les manipulations, parmi lesquelles
la génération d’un certificat et d’une paire de
clés par <span class="courier11">openssl</span>, dépassent
le cadre de la présente édition. Le lecteur intéressé est
invité à se documenter sur Internet ou à se
procurer la version précédente du présent
ouvrage.</p>
          <p class="defaut">Attention, lors de ces manipulations, il est
essentiel d’associer le certificat avec le FQDN (<span class="italic">Fully Qualified Domain Name</span>) d’exposition
de la machine de registre, sans quoi le client Docker considérera
que le protocole de sécurité n’est pas sûr et
refusera logiquement de se connecter au registre pour échanger
des images Docker.</p>
          <p class="defaut">Une autre limite importante en termes de sécurité est
que dans son installation standard, le registre fourni par Docker
ne gère pas d’autorisation et laisse n’importe qui l’utiliser.
Le paramétrage du fichier de configuration permet de remédier à ceci
en mettant en place une autorisation basée sur des jetons (token).
La méthode est particulièrement adaptée
si vous souhaitez déléguer l’authentification à un
tiers extérieur.</p>
          <p class="defaut">Toutefois, dans l’approche qui est la nôtre
d’un registre privé, il peut sembler plus logique&nbsp;d’utiliser
une méthode alternative, à savoir confier l’authentification à un
serveur web placé en frontal du registre. Cette méthode
a également l’avantage de permettre&nbsp;de tirer parti
de toute la richesse fonctionnelle d’un vrai serveur web (redirection,
filtrage, routage, sécurité, etc.), et c’est donc celle-ci
qui est recommandée. Là encore, nous renvoyons
le lecteur à l’édition précédente
qui entrait dans le détail&nbsp;de la mise en œuvre
d’un serveur Nginx comme frontal du registre.</p>
          <p class="defaut">Toujours sur le domaine de la sécurité,
il convient de prendre en compte les fonctionnalités de
sécurité avancées du système
d’exploitation, qui peuvent interagir avec le registre. En fonction
de votre configuration, SELinux peut par exemple bloquer l’écriture
par le processus du registre sur le répertoire fourni par
le mécanisme des volumes, en dehors de tout problème
de droits d’écriture sur le répertoire lui-même.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">SELinux, pour Security Enhanced Linux,
est un module de sécurité intégré à Linux,&nbsp;et
qui permet de définir des politiques de droits d’accès
aux différentes ressources du système de manière
très fine.</p>
            </div>
          </div>
          <p class="defaut">Vous obtiendrez alors sur la machine hébergeant
le conteneur registre un avertissement SELinux lorsque vous lancerez
la commande <span class="courier11">push</span> depuis une autre machine.
Sur cette machine, l’erreur sera remontée sous la forme
suivante, ou approchant&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-number">989122</span>ba5665: Image push failed&nbsp;
FATA[<span class="hljs-number">0000</span>] <span class="hljs-keyword">Error</span> pushing <span class="hljs-keyword">to</span> registry: Server <span class="hljs-keyword">error</span>: unexpected&nbsp;
<span class="hljs-number">500</span> response status trying <span class="hljs-keyword">to</span> initiate upload <span class="hljs-keyword">of</span> repetiteur</code></pre>
          <p class="defaut">Quant à la machine appelante, elle
obtiendra un message comme suit&nbsp;:</p>
          <pre class="programlisting"><code class="hljs perl">jpg@Ubuntu-VirtualBox:~$ sudo docker <span class="hljs-keyword">push</span>&nbsp;
monregistre:<span class="hljs-number">5000</span>/repetiteur&nbsp;
The <span class="hljs-keyword">push</span> refers to a repository [monregistre:<span class="hljs-number">5000</span>/repetiteur]&nbsp;
(len: <span class="hljs-number">1</span>)&nbsp;
<span class="hljs-number">989122</span>ba5665: Image <span class="hljs-keyword">push</span> failed</code></pre>
          <p class="defaut">Pour une approche d’apprentissage, nous pouvons
nous contenter de passer SELinux en mode permissif (voir la documentation
de votre distribution pour la façon de procéder)
ou de le désactiver temporairement. Cela permet de vérifier
que la configuration fonctionne en dehors de toute surcouche de
protection, puis de régler les paramètres pour
qu’elle continue à fonctionner une fois les sécurités
remises en place, sans risquer de confusion en essayant de traiter les
deux en même temps.</p>
          <p class="defaut">Évidemment, dans un contexte de production,
vous demanderiez plutôt à votre administrateur&nbsp;de
paramétrer correctement le SELinux pour laisser passer
ce type d’appels, et celui-là seulement, en plus des autorisations
existantes. Nous ne développerons pas ici les différentes
méthodes possibles, le sujet étant connexe et
nécessitant potentiellement un traitement long si l’on
souhaitait atteindre le niveau de compréhension nécessaire
pour ne pas mettre en danger la sécurité du système.</p>
        </div>
        <div class="sect3" id="refTitle8">
          <h3 class="title">c. Limites en termes de performance</h3>
          <p class="defaut">Même si la sécurité est
prise en compte comme indiqué juste avant, nous ne sommes
pas au bout de nos peines, comme peut l’indiquer un coup d’œil
sur les logs du registre&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">azureuser@ClearDockerENI~ $ docker logs registrelocal&nbsp;
time="2020-09-27T09:18:22.833604322Z" level=warning msg="<b>No HTTP &nbsp;
secret provided - generated random secret. This may cause &nbsp;
problems <span class="hljs-keyword">with</span> uploads <span class="hljs-keyword">if</span> multiple registries <span class="hljs-keyword">are</span> behind a <span class="hljs-keyword">load</span>-&nbsp;
balancer. <span class="hljs-keyword">To</span> provide a <span class="hljs-keyword">shared</span> secret, fill <span class="hljs-keyword">in</span> http.secret <span class="hljs-keyword">in</span> the &nbsp;
configuration <span class="hljs-keyword">file</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">set</span> the REGISTRY_HTTP_SECRET environment &nbsp;
variable.</b><span class="hljs-string">" go.version=go1.11.2 instance.id=8f552523-1e68-400b-&nbsp;
a33b-e78df0c35545 service=registry version=v2.7.1&nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-09</span><span class="hljs-number">-27</span>T09:<span class="hljs-number">18</span>:<span class="hljs-number">22.833652922</span>Z<span class="hljs-string">" level=info msg="</span><b>redis <span class="hljs-keyword">not</span> &nbsp;
configured</b><span class="hljs-string">" go.version=go1.11.2 instance.id=8f552523-1e68-400b-&nbsp;
a33b-e78df0c35545 service=registry version=v2.7.1&nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-09</span><span class="hljs-number">-27</span>T09:<span class="hljs-number">18</span>:<span class="hljs-number">22.842914355</span>Z<span class="hljs-string">" level=info msg="</span><span class="hljs-keyword">using</span> &nbsp;
<span class="hljs-keyword">inmemory</span> <span class="hljs-built_in">blob</span> <span class="hljs-keyword">descriptor</span> <span class="hljs-keyword">cache</span><span class="hljs-string">" go.version=go1.11.2 &nbsp;
instance.id=8f552523-1e68-400b-a33b-e78df0c35545 service=registry &nbsp;
version=v2.7.1&nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-09</span><span class="hljs-number">-27</span>T09:<span class="hljs-number">18</span>:<span class="hljs-number">22.844945063</span>Z<span class="hljs-string">" level=info msg="</span><b>listening &nbsp;
<span class="hljs-keyword">on</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">5000</span></b><span class="hljs-string">" go.version=go1.11.2 instance.id=8f552523-1e68-&nbsp;
400b-a33b-e78df0c35545 service=registry version=v2.7.1</span></code></pre>
          <p class="defaut">On y retrouve un avertissement lié au
fait que, si plusieurs instances de registre sont placées
derrière un équilibreur de charge, il faut mettre
en place un secret partagé pour que le système
fonctionne correctement, mais aussi une indication comme quoi le
registre&nbsp;peut être appelé par défaut
depuis n’importe quelle adresse IP (<span class="courier11">0.0.0.0</span>).
Là encore, il s’agirait d’une manipulation nécessaire
pour la mise en œuvre industrielle du registre, avec une étape
de filtrage d’IP en amont.</p>
          <p class="defaut">Un troisième message rappelle également
qu’aucun niveau de cache n’est prévu pour le registre.
Son comportement par défaut est de mettre en place un léger
cache en mémoire,&nbsp;mais ce qui est recommandé pour
une installation plus professionnelle est la mise en œuvre
d’un cache de type Redis. Encore une action qu’il conviendrait de
réaliser&nbsp;pour être complet, et surtout
un serveur de plus à gérer pour assurer le maintien&nbsp;en
conditions opérationnelles de l’ensemble.</p>
        </div>
        <div class="sect3" id="refTitle9">
          <h3 class="title">d. Limites en termes de stockage</h3>
          <p class="defaut">Il conviendrait également, sur un
registre vraiment industriel, de mieux gérer la persistance
des contenus binaires. Une première approche, un peu simpliste certes
mais fonctionnelle, consistait à utiliser les volumes pour
rediriger l’endroit où le conteneur du registre stocke
les images qui lui sont envoyées vers un emplacement un
peu plus pérenne, par exemple un dossier de la machine hôte
qui sera régulièrement sauvegardé, voire
synchronisé en continu sur une machine distante. Mais dans
un contexte plus professionnel, la cible pourrait être
une baie SAN, un partage NFS, voire même un espace de stockage
dans le cloud comme un bucket Amazon S3 ou une ressource Azure Storage.</p>
          <p class="defaut">Docker faisant bien les choses, le registre
fourni est aisément paramétrable par un fichier&nbsp;au
format YAML, qui permet une grande latitude sur les options, et en
particulier la gestion de la persistance des images qui nous intéresse
dans cette section. À titre purement informatif, car le
but n’est pas de rentrer dans les détails, la forme par
défaut de ce fichier est reproduite ci-dessous, avec des marques
en gras pour la section qui nous intéresse&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">version: 0.1&nbsp;
log:&nbsp;
&nbsp;&nbsp;level: debug&nbsp;
&nbsp;&nbsp;fields:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;service: registry&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment: development<b>&nbsp;
storage:&nbsp;
&nbsp;&nbsp;<span class="hljs-keyword">cache</span>:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;layerinfo: <span class="hljs-keyword">inmemory</span>&nbsp;
&nbsp;&nbsp;filesystem:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rootdirectory: /tmp/registry-dev</b>&nbsp;
<span class="hljs-keyword">http</span>:&nbsp;
&nbsp;&nbsp;addr:&nbsp;:<span class="hljs-number">5000</span>&nbsp;
&nbsp;&nbsp;secret: asecretforlocaldevelopment&nbsp;
&nbsp;&nbsp;debug:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addr: localhost:<span class="hljs-number">5001</span>&nbsp;
redis:&nbsp;
&nbsp;&nbsp;addr: localhost:<span class="hljs-number">6379</span>&nbsp;
&nbsp;&nbsp;pool:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;maxidle: <span class="hljs-number">16</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;maxactive: <span class="hljs-number">64</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;idletimeout: <span class="hljs-number">300</span>s&nbsp;
&nbsp;&nbsp;dialtimeout: <span class="hljs-number">10</span>ms&nbsp;
&nbsp;&nbsp;readtimeout: <span class="hljs-number">10</span>ms&nbsp;
&nbsp;&nbsp;writetimeout: <span class="hljs-number">10</span>ms&nbsp;
notifications:&nbsp;
&nbsp;&nbsp;endpoints:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-keyword">name</span>: <span class="hljs-keyword">local</span><span class="hljs-number">-8082</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">url</span>: <span class="hljs-keyword">http</span>://localhost:<span class="hljs-number">5003</span>/callback&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Authorization: [Bearer &lt;an example token&gt;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">timeout</span>: <span class="hljs-number">1</span>s&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threshold: <span class="hljs-number">10</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;backoff: <span class="hljs-number">1</span>s&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;disabled: <span class="hljs-literal">true</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-keyword">name</span>: <span class="hljs-keyword">local</span><span class="hljs-number">-8083</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">url</span>: <span class="hljs-keyword">http</span>://localhost:<span class="hljs-number">8083</span>/callback&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">timeout</span>: <span class="hljs-number">1</span>s&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;threshold: <span class="hljs-number">10</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;backoff: <span class="hljs-number">1</span>s&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;disabled: <span class="hljs-literal">true</span></code></pre>
          <p class="defaut">La section <span class="courier11">storage</span> est
celle permettant de jouer sur la persistance du registre, c’est-à-dire
la façon dont il gère le stockage à long
terme des couches et étiquettes d’images Docker qui lui
sont confiées. Un coup d’œil dans une page de
documentation liée (<a class="url" href="https://docs.docker.com/registry/configuration/" target="_blank">https://docs.docker.com/registry/configuration/</a>) montrera
comment le comportement de stockage peut être ajusté de
manière à pointer sur un compte de stockage Azure,
un bucket Amazon S3, etc.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le choix de la localisation de stockage
est bien sûr important, car des frais s’appliquent sur
la bande passante entre les clouds, alors que - généralement - les
déplacements à l’intérieur d’une même
zone ne sont pas facturés par les opérateurs de
cloud.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle10">
          <h3 class="title">e. Et toutes les autres limitations d’un registre autogéré</h3>
          <p class="defaut">Comme on l’a vu, de nombreuses étapes
sont nécessaires pour régler les principaux problèmes
d’utilisabilité, de sécurité et de performance
par rapport au simple démarrage d’un conteneur Docker embarquant
le serveur de registre. Mais malgré ces nombreuses manipulations,
il reste encore beaucoup de travail pour obtenir un résultat
utilisable en production, et nous sommes loin d’avoir épuisé dans
les pages précédentes toutes les options du fichier
de configuration du registre. Le but ici n’est pas d’explorer en
détail toutes les subtilités de l’applicatif,
mais de montrer l’effort nécessaire pour prendre tout ce
qu’il faut en compte. Nous listons donc simplement ci-dessous&nbsp;les
principales possibilités offertes&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">gestion des logs&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">support des notifications d’événements&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">utilisation d’un Content Delivery
Network au travers d’un mécanisme de middleware (par exemple
Amazon Cloudfront)&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">reporting automatique des métriques,
supportant par exemple l’envoi dans des logiciels&nbsp;tiers
comme New Relic ou Bugsnag.</p>
              </li>
            </ul>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le dernier point de la liste est assez
révélateur de la philosophie de fonctionnement
des nouvelles applications sur le Web et de ce qu’on appelle les
Web-Oriented Architectures&nbsp;: au lieu d’inclure un système
de reporting, Docker préfère s’appuyer sur des
services externes spécialisés dans cette fonctionnalité. Cette
approche saine et découplée permet d’obtenir des
systèmes bien plus évolutifs dans le temps et
participe fortement à l’urbanisation des systèmes d’information.
Il s’agit d’une orientation extrêmement forte des architectures informatiques
dans le cadre de la transformation digitale, et qui permet de gagner
drastiquement en souplesse en découpant les responsabilités
de manière stricte (urbanisation du SI) et en les confiant
chacune au module le plus adapté pour cette tâche
(approche best of breed).</p>
            </div>
          </div>
          <p class="defaut">Et encore toutes ces fonctionnalités
ne sont-elles que des possibilités de paramétrage
du registre lui-même. Comme nous l’avons vu, il faudrait également prendre
en compte les capacités du serveur web servant de reverse
proxy, voire étendre encore en supportant derrière
ce frontal plusieurs versions du registre, comme la documentation
Docker le suggère (<a class="url" href="https://docs.docker.com/registry/deploying/#configure-nginx-with-a-v1-and-v2-registry" target="_blank">https://docs.docker.com/registry/deploying/#configure-nginx-with-a-v1-and-v2-registry</a>),
de façon à faciliter la compatibilité avec
les clients Docker précédant la version 1.6, la première à être
compatible avec l’API V2.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Cette solution utilise d’ailleurs
la technologie Docker Compose pour simplifier sa mise en œuvre.</p>
            </div>
          </div>
          <p class="defaut">Enfin, en plus de tout cet aspect paramétrage,
la mise en œuvre en production d’un registre nécessitera
aussi la supervision des machines, la gestion de la montée
en charge, etc. Le lecteur l’aura compris, monter et entretenir
un registre privé est donc une tâche lourde, et
il convient de bien y réfléchir avant de choisir
cette voie plutôt que de payer un compte privé sur
Docker Hub ou un autre service cloud avec un rapport qualité/prix équivalent,
et incomparable avec celui atteignable en gérant soi-même
le registre. Seuls des besoins de confidentialité extrêmes
peuvent justifier le surcoût énorme de l’entretien par
ses soins d’une telle architecture.</p>
          <p class="defaut">Une approche médiane peut aussi consister à séparer
l’hébergement et le garder sous votre maîtrise,
tout en laissant le paramétrage complexe être
réalisé pour vous, justement en utilisant des
conteneurs de reverse proxy Nginx pour un registre sécurisé,
et déjà préparé par d’autres.
Citons parmi d’autres&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1"><a class="url" href="https://registry.hub.docker.com/u/marvambass/nginx-registry-proxy/" target="_blank">https://registry.hub.docker.com/u/marvambass/nginx-registry-proxy/</a></p>
              </li>
              <li class="liste1">
                <p class="liste1"><a class="url" href="https://registry.hub.docker.com/u/containersol/docker-registry-proxy/" target="_blank">https://registry.hub.docker.com/u/containersol/docker-registry-proxy/</a></p>
              </li>
            </ul>
          </div>
          <p class="defaut">Il conviendra bien sûr de valider
le niveau de confiance qu’on peut avoir en ces images. Les deux
citées ci-dessus sont issues de builds automatisés
sur Docker Hub, et les <span class="courier11">Dockerfile</span> ainsi
que les fichiers de configuration sont accessibles pour valider
le contenu, ce qui constitue un bon point.</p>
          <p class="defaut">Mais, en tout état de cause, il faut
dorénavant d’excellentes raisons pour ne pas utiliser des
services cloud de registre Docker, car le coût de maintenance par
ses propres moyens est extrêmement élevé pour
arriver à un niveau pourtant inférieur en termes
de sécurité et de robustesse à celui
fourni à un prix inférieur par les alternatives
en ligne que nous allons maintenant montrer.</p>
        </div>
      </div>
      <div class="sect2" id="refTitle11">
        <h2 class="title">4. Utilisation d’un service cloud déjà préparé</h2>
        <p class="defaut">Les services de registre en ligne sont désormais
foisonnants et les coûts tirés vers le bas par
la concurrence ainsi que l’effet de volume dont bénéficient
les approches cloud. Bien sûr, le choix le plus basique
est d’utiliser les offres commerciales de Docker Hub.</p>
        <p class="defaut">À titre de pure information, nous
recopions ci-dessous un extrait des offres proposées à ce
jour par Docker (source&nbsp;: <a class="url" href="https://www.docker.com/pricing" target="_blank">https://www.docker.com/pricing</a>)&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP04.png" title="images/08EP04.png" src="IMAGES/08EP04.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Mais en fonction du positionnement de ses
conteneurs, il peut se révéler plus avantageux
de disposer d’un registre sur le même cloud, et nous allons
pour cela montrer comment se passe en général
cette alternative.</p>
        <div class="sect3" id="refTitle12">
          <h3 class="title">a. Azure Container Registry</h3>
          <p class="defaut">Nous utiliserons la fonctionnalité Container
Registry du cloud Azure, porté par Microsoft.&nbsp;Une
simple recherche de cette expression dans le portail Azure permet
de localiser&nbsp;rapidement le service à utiliser&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP05.png" title="images/08EP05.png" src="IMAGES/08EP05.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Dans l’interface qui apparaît après
que l’utilisateur a cliqué sur <b>Créer</b>,
les choix principaux sont très légers&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP06.png" title="images/08EP06.png" src="IMAGES/08EP06.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">L’abonnement, l’emplacement par défaut
des machines et le niveau de service étant proposés
automatiquement, il n’y a guère à spécifier
que les trois choix suivants pour continuer&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">Le groupe de ressources
qui contiendra le service de registre créé (pratique pour
supprimer en une seule étape toutes les ressources liées à un
projet temporaire).</p>
              </li>
              <li class="liste1">
                <p class="liste1">Le nom du registre, c’est-à-dire
l’identifiant qui précédera .<span class="courier11">azurecr.io</span> dans
l’URL qui sera exposée aux clients du registre.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Le niveau de service requis (de
base, standard ou premium sont les trois offres proposées à ce
jour par Microsoft).</p>
              </li>
            </ul>
          </div>
          <p class="defaut">À titre d’information, les trois
niveaux de service possibles et les tarifs associés au
moment&nbsp;de l’écriture de la présente édition étaient
les suivants&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP07.png" title="images/08EP07.png" src="IMAGES/08EP07.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Le coût d’une offre Standard (suffisante
pour de nombreuses entreprises, y compris de taille intermédiaire)
s’établit autour de 200 euros par an. Ce coût est à mettre
en regard&nbsp;de celui de la maintenance d’un registre autonome
avec toutes les opérations de gestion de la performance
et de la sécurité, qu’aucun professionnel ne ferait
pour moins de 1&nbsp;000 euros environ, ainsi que le monitoring,
la robustesse et le maintien en condition opérationnelle
qui serait du même ordre de grandeur pour une année,
dans le meilleur des cas. Quant à l’offre Basic, elle permet à un
particulier de réaliser quelques essais pour comprendre
le fonctionnement du registre pour moins d’un euro. On le voit,
le prix n’est donc plus aucunement un facteur encourageant à la
gestion d’un registre par ses propres moyens, si tant est qu’il
l’a été un jour.</p>
          <p class="defaut">Les autres onglets de l’assistant de création
du service de registre permettent de jouer sur des options particulières
de réseau et de chiffrement qui ne sont accessibles que
sur l’offre Premium.</p>
          <p class="defaut">On peut donc en général
cliquer directement sur <b>Vérifier + créer</b>,
puis confirmer par le bouton <b>Créer</b> sur
la page de résumé des options, pour obtenir&nbsp;en
quelques secondes un registre prêt à l’emploi&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP08.png" title="images/08EP08.png" src="IMAGES/08EP08.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Pour tester rapidement sans s’embarquer à créer
un ensemble d’utilisateurs autorisés et gérer
les différents niveaux de droits, nous allons simplement
activer l’utilisateur administrateur dans la section <b>Clés d’accès</b> de la
ressource&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP09.png" title="images/08EP09.png" src="IMAGES/08EP09.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">L’utilisation du registre est alors exactement
la même que ce qui a été montré sur
un registre différent du Docker Hub public, à savoir
qu’il convient de se connecter à l’aide de la commande <span class="courier11">docker login</span> et des informations récupérées
ci-dessus, puis de réaliser&nbsp;un <span class="courier11">docker push</span> de l’image en utilisant
une étiquette créée spécifiquement
pour le registre ciblé en utilisant par exemple la commande <span class="courier11">docker tag</span>&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP10.png" title="images/08EP10.png" src="IMAGES/08EP10.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Une fois l’opération réalisée,
on peut retourner constater ses effets sur l’interface de gestion
dans le portail Azure, en accédant à la section <b>Dépôts</b>, qui montre
la présence du dépôt <span class="courier11">repeater</span> juste
réceptionné et désormais stocké dans
le registre&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP11.png" title="images/08EP11.png" src="IMAGES/08EP11.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Un clic sur ce dépôt permet,
logiquement, de retrouver les étiquettes associées ainsi
que différentes informations sur le dépôt
lui-même&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP12.png" title="images/08EP12.png" src="IMAGES/08EP12.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">À part spécifier qu’en cas
de compromission des clés, celles-ci peuvent être
régénérées depuis l’interface
montrée plus haut, il n’y a pas grand-chose d’autre à dire
quant à l’usage basique du registre. Les paramètres
plus complexes comme la gestion des utilisateurs&nbsp;et des
autorisations, en lien par exemple avec un annuaire Azure ActiveDirectory,
ne relèvent pas du périmètre du présent
ouvrage.</p>
        </div>
        <div class="sect3" id="refTitle13">
          <h3 class="title">b. Notes finales</h3>
          <p class="defaut">Bien sûr, on peut trouver ce même
service sur Amazon (service nommé <span class="italic">Elastic Container Registry</span>)
ou Google (service nommé <span class="italic">Container Registry</span>).
Encore une fois, il convient également de ne pas oublier
que Docker Hub lui aussi, en plus du registre public utilisé par
défaut par le démon Docker, propose des offres professionnelles
permettant d’obtenir un registre privé.</p>
          <p class="defaut">Un comparatif sera intéressant pour
trouver le service au meilleur rapport qualité/prix.
Les tarifs sont (à dessein) difficiles à comparer
car ils n’utilisent pas les mêmes critères, mais
certaines fonctionnalités peuvent être de vrais facteurs
de différenciation.</p>
          <p class="defaut">Par exemple, Amazon met en avant dès
l’interface de création d’un service de registre sa capacité à empêcher
le remplacement d’une balise existante par un contenu différent,
mais aussi la possibilité d’analyser le contenu des images dès
leur envoi&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP13.png" title="images/08EP13.png" src="IMAGES/08EP13.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Comme expliqué plus haut comme raison
d’utiliser un service cloud pour le registre, il est logique que
le registre soit disposé sur un réseau proche
des machines l’utilisant, pour des raisons de performance. La meilleure
approche pour cela est d’utiliser le même cloud, le cas échéant.
Toutefois, il y a un risque, ce faisant, de générer
un couplage entre les nœuds de travail et le registre si
ce lien ne passe pas par le mécanisme standard recommandé par
Docker. Mettre tous ses œufs dans le même panier
ne pose pas de problème du moment qu’il est facile de les
faire changer rapidement. Afin de ne pas se retrouver dans une situation
délicate en cas d’augmentation brutale des tarifs par un
des prestataires, il est intéressant de tester dès
la mise en place qu’il est simple de basculer sur un autre registre.
Pour cela, une bonne pratique est de mettre en place une redirection
sur l’adresse du registre à partir de votre nom de domaine,&nbsp;en gérant évidemment
les options de sécurisation par certificat pour ne pas
que cette redirection apparaisse comme illégitime.</p>
          <p class="defaut">Pour reprendre l’exemple plus haut avez Azure,
une redirection de <span class="courier11">registre.gouigoux.com</span> sur <span class="courier11">jpgouigoux.azurecr.io</span> aurait été une bonne
façon de sécuriser le changement de fournisseur
de registre.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Cette approche relève également
d’une bonne pratique du point de vue de la sécurité.
En effet, les ressources fournies par un cloud ne le sont pas de
manière éternelle, et lorsque la ressource est
relâchée, la plateforme peut alors la mettre à disposition
d’une autre entité légale ou d’un autre individu,
qui peut se prévaloir de sa propriété.
Si, pendant le temps qu’elle possédait l’URL, l’entité l’a
massivement diffusée à des utilisateurs, clients
ou partenaires, elle se retrouve plus ou moins obligée
de continuer à payer pour le service, même si elle
l’a déplacée ailleurs, au moins dans l’intervalle
de temps nécessaire pour être sûr que
tous les consommateurs sont bien prévenus du changement. Dans
l’exemple ci-dessus, où l’adresse <span class="courier11">jpgouigoux.azurecr.io</span> a été relâchée
après écriture du livre, n’importe qui peut s’approprier
ce nom de registre et essayer de jouer sur le nom pour faire croire à des
clients qu’il agit en tant que l’auteur de ce livre. La seule sécurité est
que les clients soient suffisamment éduqués pour
se rendre compte que le nom de domaine <span class="courier11">azurecr.io</span> correspond à un
cloud (et donc pas à un propriétaire unique, mais à n’importe quelle
personne ayant un compte sur Azure) et suffisamment alertés
sur les problèmes de sécurité pour ne
pas se connecter à un service sans avoir vérifié auprès
du propriétaire attendu que celui-ci était légitime.
Mais ces problèmes de relâchement de ressources
sont une réelle menace en termes de cybersécurité,
au même titre que l’usurpation d’identité liée à la
récupération d’un nom de domaine pour lequel le
propriétaire légitime n’a pas renouvelé l’abonnement
assez vite et qui s’est retrouvé sur le marché,
attirant des personnes malintentionnées à la hauteur
de sa réputation.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect2" id="refTitle14">
        <h2 class="title">5. Approches complémentaires</h2>
        <div class="sect3" id="refTitle15">
          <h3 class="title">a. L’API du registre<var style="display:none"> API</var></h3>
          <p class="defaut">À titre de remarque, tout registre
qui souhaite être conforme au mode de fonctionnement de
Docker se doit d’implémenter une API telle que spécifiée
sur <a class="url" href="https://docs.docker.com/registry/spec/api/" target="_blank">https://docs.docker.com/registry/spec/api/</a></p>
          <p class="defaut">De manière générale,
nous nous connectons à un registre par le client Docker qui
transforme les commandes transmises en appels d’API, de sorte qu’il
nous épargne cette complexité. Mais pour certaines
opérations très spécifiques (émission
en masse d’images, diagnostic, etc.), il peut être utile
de savoir que cette API existe et qu’elle expose&nbsp;toutes
les commandes utilisables par le client Docker de manière
standard (REST/JSON).</p>
          <p class="defaut">Dans l’exemple de mise en place d’un registre
autonome réalisé plus haut, nous aurions&nbsp;par
exemple pu utiliser l’API pour montrer une interrogation du registre
alors vide&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP14.png" title="images/08EP14.png" src="IMAGES/08EP14.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Les caractères <span class="courier11">{}</span> correspondent à un
contenu JSON vide. Une fois un premier dépôt créé,
un appel d’API un peu plus représentatif serait le suivant&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP15.png" title="images/08EP15.png" src="IMAGES/08EP15.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">En fonction de l’infrastructure utilisée
pour porter la machine sur laquelle vous réalisez les tests,
il sera potentiellement nécessaire d’ouvrir le port 88.
Dans le cas de l’auteur, la machine Clear Linux étant portée
par le cloud Azure, il a fallu rajouter une règle entrante&nbsp;sur
le pare-feu (section <span class="courier11">network security group</span>)
pour autoriser l’accès depuis&nbsp;un navigateur graphique
externe.</p>
            </div>
          </div>
          <p class="defaut">Bien que rarement utilisée, il est
utile de se rappeler que l’API est présente. C’est d’ailleurs
aussi le cas pour le démon Docker lui-même, qui
peut être piloté par n’importe quelle interface
de programmation par ce biais.</p>
        </div>
        <div class="sect3" id="refTitle16">
          <h3 class="title">b. Mise en place d’un miroir<var style="display:none"> Miroir</var></h3>
          <p class="defaut">Les sections précédentes
du présent chapitre ont abondamment détaillé le fonctionnement
du cache local d’images. Nous avons montré comment les images étaient
stockées sur une machine hôte lors de la compilation,
ou par l’utilisation d’une commande <span class="courier11">pull</span> qui
les ramenait pour utilisation depuis le registre Docker Hub ou un
autre registre du réseau si besoin. La grande utilité de
ce cache local a été expliquée comme étant
le fait que, si plusieurs images utilisent la même image
de base (<span class="courier11">ubuntu</span> ou <span class="courier11">debian</span>, dans nos exemples) sur la
même machine hôte, seul le premier démarrage
entraînera le téléchargement effectif
de ces images depuis le registre distant, qu’il s’agisse de Docker Hub
ou de n’importe quel autre service.</p>
          <p class="defaut">Tous les lancements suivants d’une image utilisant
ces images comme base à un niveau&nbsp;quelconque seront
beaucoup plus rapides.</p>
          <p class="defaut">Ce mécanisme de cache est un des
grands progrès de Docker par rapport à un système
de virtualisation, où les machines complètes devaient être
téléchargées, avec au final des redondances
et un gaspillage énorme de bande passante. Seulement, il
ne passe pas naturellement à l’échelle. Imaginons
en effet un cluster de machines hôtes pour héberger
de nombreux conteneurs Docker&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP16.png" title="images/08EP16.png" src="IMAGES/08EP16.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Chacune des machines du cluster va avoir le
même comportement avec un cache local,&nbsp;mais chacune
devra tout de même télécharger sur Internet
l’image de base lors du premier lancement. Si on ajoute que dans
un cluster il n’est pas rare de réinstaller des machines
de zéro dès qu’elles présentent un problème, on
comprend qu’un niveau supplémentaire de cache, sur le réseau
local, serait un avantage.</p>
          <p class="defaut">Il est heureusement possible de mettre en
place un registre de type cache, qui va servir de miroir au registre
distant. Ainsi, seul le premier téléchargement nécessitera
de passer par Internet, et toutes les autres machines se serviront dans
le cache sur le réseau local (et donc avec un coût
de bande passante réduit et des performances bien meilleures)
pour enrichir leur propre cache local&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/08EP17.png" title="images/08EP17.png" src="IMAGES/08EP17.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmP4bVjNy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Pour mettre en place cette infrastructure,
nous allons nous servir à nouveau de l’image <span class="courier11">registry</span>, mais en la déclarant
comme non autonome (c’est-à-dire qu’il ne s’agit pas d’un
registre de stockage de référence des images)
et en lui passant des paramètres supplémentaires.
La documentation de Docker recommande de pointer sur <span class="courier11">https://registry-1.docker.io</span> pour
les images et <span class="courier11">https://index.docker.io</span> pour
l’index.</p>
          <pre class="programlisting"><code class="hljs javascript">docker run -e STANDALONE=<span class="hljs-literal">false</span> -e &nbsp;
MIRROR_SOURCE=https:<span class="hljs-comment">//registry-&nbsp;</span>
<span class="hljs-number">1.</span>docker.io -e MIRROR_SOURCE_INDEX=https:<span class="hljs-comment">//index.docker.io -p&nbsp;</span>
<span class="hljs-number">5000</span>:<span class="hljs-number">5000</span> registry</code></pre>
          <p class="defaut">Le reste est très simple&nbsp;:
il suffit de passer l’adresse du conteneur ainsi exposé comme
valeur de l’option de démarrage <span class="courier11">--registry-mirror</span> de
Docker. Cette option peut être passée sur la ligne
de commande lorsque vous lancez le démon Docker manuellement,
ce qui est généralement réservé pour
les lancements en mode débogage&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">docker --registry-mirror=http:<span class="hljs-comment">//IP_MACHINE_CHOISIE:5000 -d -D</span></code></pre>
          <p class="defaut">Son emplacement préférentiel
est dans le fichier <span class="courier11">/etc/default/docker</span>, sur
la variable&nbsp;<span class="courier11">DOCKER_OPTS</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php"><span class="hljs-comment"># Docker Upstart and SysVinit configuration file&nbsp;</span>
&nbsp;
<span class="hljs-comment"># Customize location of Docker binary (especially for development &nbsp;</span>
testing).&nbsp;
<span class="hljs-comment">#DOCKER="/usr/local/bin/docker"&nbsp;</span>
&nbsp;
<span class="hljs-comment"># Use DOCKER_OPTS to modify the daemon startup options.&nbsp;</span>
DOCKER_OPTS=<span class="hljs-string">"--insecure-registry=monregistre:5000 </span><b><span class="hljs-string">--registry-&nbsp;
mirror=192.168.1.0.13:5000</span></b><span class="hljs-string">"</span>&nbsp;
&nbsp;
<span class="hljs-comment"># If you need Docker to use an HTTP proxy, it can also be &nbsp;</span>
specified here.&nbsp;
<span class="hljs-comment">#export http_proxy="http://127.0.0.1:3128/"&nbsp;</span>
&nbsp;
<span class="hljs-comment"># This is also a handy place to tweak where Docker’s temporary &nbsp;</span>
files go.&nbsp;
<span class="hljs-comment">#export TMPDIR="/mnt/bigdrive/docker-tmp"</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Ne pas oublier de relancer Docker
pour voir ces modifications prises en compte.</p>
            </div>
          </div>
          <p class="defaut">Lors de la mise en place d’un cluster à grande échelle,
cette bonne pratique est quasiment une obligation, en partie pour
ne pas consommer trop de bande passante, mais surtout pour assurer
un temps de démarrage rapide des conteneurs sur les nouvelles
machines s’intégrant dans le cluster. C’est une raison supplémentaire
pour utiliser un service de registre dans le même cloud
que les machines exécutant les charges de travail à l’aide
de conteneurs. Nous reviendrons dans un prochain chapitre sur la
mise en place effective d’un cluster de machines hôtes
Docker.</p>
        </div>
      </div>
    </div></div></div></div></app-page-content><!----><!----><!----></div></kendo-pdf-export>