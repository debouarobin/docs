<kendo-pdf-export _ngcontent-uvf-c168="" papersize="A4" margin="2cm" id="div-book-content" class="col-12 col-sm-10 offset-0 div-book-content" uipath_custom_id="10"><div><app-page-content _ngcontent-uvf-c168="" _nghost-uvf-c166="" class="font-size-14 font-size-sm-20"><div _ngcontent-uvf-c166="" class="mainContent mt-4"><div _ngcontent-uvf-c166="" id="bookContent" class="bookContent"><div _ngcontent-uvf-c166="" id="content"><div class="sect1" style="abcpdf-tag-visible: true" id="AU_28d57b6e-c93f-4f42-b7bc-b28a17781721" uri="ImagesUri_../download/5c180f28-f752-47db-98e8-8656c84b148d/images/">
      <h1 class="title">Présentation de l’application exemple</h1>
      <p class="defaut">Jusqu’à maintenant, les usages démontrés
de Docker l’ont été à l’aide d’exercices
simples, mais pour les fonctionnalités dont l’usage est à détailler
dans le reste du livre, il convient désormais d’utiliser
une application un peu plus complexe. Nous allons donc commencer
par expliquer cette application exemple.</p>
      <div class="sect2" id="refTitle0">
        <h2 class="title">1. Principes à l’œuvre </h2>
        <div class="sect3" id="refTitle1">
          <h3 class="title">a. Utilité</h3>
          <p class="defaut">L’application qui servira d’exemple ne peut
pas être considérée comme autre chose
qu’une simple preuve de concept d’une architecture microservices
utilisant des conteneurs. Elle est composée de huit modules
indépendants qui, bien qu’inutilisables dans un milieu
industriel, sont assez proches techniquement de ce que pourrait être
une architecture&nbsp;de référence. Cette
application a été utilisée pour le livre
sur Kubernetes aux Éditions ENI mais aussi pour de nombreux
cours en universités ou écoles d’ingénieurs
que l’auteur a donnés.</p>
          <p class="defaut">Dans une précédente édition
du présent ouvrage, l’application exemple avait été composée
de microservices écrits dans de nombreux langages de programmation
différents, à la fois pour illustrer l’indépendance
profonde des microservices les uns par rapport aux autres, mais
aussi pour que chaque lecteur trouve son compte par rapport à son
langage ou sa plateforme de prédilection.</p>
          <p class="defaut">Comme il était toutefois impossible
de satisfaire tout le monde et que la multiplicité des
plateformes rendait finalement plus difficile pour les lecteurs
de comprendre l’exemple, il a été décidé pour
la présente édition de se cantonner à une
architecture de référence en .NET Core.</p>
          <p class="defaut">Pour compenser cette perte de richesse, une
section dans le présent chapitre montrera quelques Dockerfile
pour différentes plateformes, en expliquant les spécificités
de chacune.</p>
        </div>
        <div class="sect3" id="refTitle2">
          <h3 class="title">b. Architecture de microservices<var style="display:none"> Microservices</var></h3>
          <p class="defaut">Docker est souvent utilisé comme
une brique fondamentale des architectures à microservices,
car il permet de réaliser des séparations de code
porteuses de découplage fonctionnel tout en limitant le
surcoût en termes de ressources.</p>
          <p class="defaut">De la même manière que les
applications utilisant la programmation orientée objet
bénéficient du respect des principes SOLID (responsabilité unique,
ouverture à l’évolution / fermeture à la
modification, substitution de Liskov, séparation des interfaces
et inversion de dépendances), les architectures orientées
services bénéficient des principes portés
par les microservices (indépendance des cycles de vie,
autonomie de développement et de déploiement, périmètre
restreint, exposition normalisée et découvrable,
etc.).</p>
          <p class="defaut">Docker s’inscrit pleinement dans le mouvement
des microservices et d’aucuns diraient même qu’il l’a rendu
techniquement possible. L’architecture, les méthodes et
les techniques se mélangeant, on peut dire que les microservices,
DevOps et Docker se sont rencontrés pour faire émerger
une nouvelle façon de créer des applications industrielles à large
périmètre. On pourrait même ajouter à cet
ensemble la technologie de déploiement Kubernetes, tant
elle est désormais imbriquée avec ces approches.</p>
        </div>
      </div>
      <div class="sect2" id="refTitle3">
        <h2 class="title">2. Description de l’application</h2>
        <div class="sect3" id="refTitle4">
          <h3 class="title">a. Présentation des fonctionnalités</h3>
          <p class="defaut">L’application utilisée dans les exemples
de manipulation ci-dessous s’appelle Middle Office. Il s’agit, comme
son nom l’indique, d’une application s’interfaçant entre
un Front Office (qui permet de déposer des demandes, typiquement
sur un site web) et un Back Office (l’application côté entreprise
qui va permettre de traiter ces demandes).&nbsp;Le Middle Office
est en général géré par des
gestionnaires qui vont qualifier les demandes et accepter qu’elles
entrent dans le périmètre du traitement par l’entreprise
sur le Back Office.</p>
          <p class="defaut">Il y a une part de tampon de sécurité dans
le rôle du Middle Office, car il sert de sas pour faire
entrer des informations dans une zone moins fortement sécurisée
du périmètre étendu de l’entreprise.
Ainsi, c’est typiquement sur un Middle Office qu’on opérera
les contrôles antivirus, pour ne pas faire perdre de temps à un
usager ou un client lors de son dépôt, mais pour
ne pas non plus accepter de faire entrer un document dangereux dans
le périmètre interne de l’entreprise.</p>
          <p class="defaut">Le Middle Office est également un
moyen de filtrer les demandes d’un point de vue fonctionnel, en
faisant en sorte que les gestionnaires du Back Office ne soient
pas gênés&nbsp;par des demandes incomplètes,
farfelues ou invalides. Le gestionnaire Middle Office sert donc
de validateur de premier niveau sur des demandes, en les autorisant à passer
ou pas, ou en leur donnant une qualification qui va les orienter
vers tel ou tel processus sur le reste du système d’information.</p>
          <p class="defaut">Notre application exemple de Middle Office
permettra ainsi de déposer des demandes, d’associer une
décision à telle ou telle demande par un autre
rôle, ainsi que de paramétrer différents
types de demandes et les décisions possibles. Cette application
est souhaitée comme la plus générique
possible, dans le sens où elle permet de gérer
n’importe quel type de demande, avec toutes les données
qui y sont associées, ainsi que n’importe quelle décision
sur ces demandes. Dans les exemples de paramétrages qui
seront utilisés, nous verrons ainsi un type de demande
pour les déclarations de changements d’adresse, qui pourront être
validées ou rejetées, mais aussi un type de demande correspondant&nbsp;à des
résultats de notes de baccalauréat, qui donneront
lieu à une décision d’affectation de telle ou
telle mention ou bien d’envoi au rattrapage ou bien de recalage
du candidat.</p>
          <p class="defaut">Dans tous les cas, les rôles (au
sens des autorisations sur le logiciel) seront toujours différents
entre le gestionnaire de demandes, qui peut créer ces dernières, le
validateur qui entre une décision sur les demandes et le
paramétreur qui conçoit les différents
types de demandes et définit les choix possibles pour la décision.
La séparation des responsabilités est particulièrement
importante dans une sécurité fonctionnelle sur
des architectures de microservices, de la même manière
que l’autonomie de ceux-ci et leur mode de découpage qui
doit être aligné sur le métier et surtout
pas sur la technique. Nous reviendrons sur ce point dans le détail
sur l’architecture de la solution.</p>
        </div>
        <div class="sect3" id="refTitle5">
          <h3 class="title">b. Limites logicielles</h3>
          <p class="defaut">L’application Middle Office est utilisée
de manière récurrente par l’auteur comme support
de cours et des pans complets de cette application ont été créés
dans le cadre de travaux pratiques sur des sujets aussi variés
que l’urbanisation des systèmes d’information, la contractualisation
des API, les architectures de microservices, la sécurité logicielle,&nbsp;les
middlewares, etc. Ceci explique de nombreuses limites dans l’application
elle-même.</p>
          <p class="defaut">Le lecteur constatera rapidement que l’interface
graphique est loin d’être aussi léchée
que sur des produits commerciaux ou même des logiciels
gratuits à vocation grand public.&nbsp;Hormis quelques
services qui ont fait l’objet de travaux pratiques spécifiques
sur l’utilisation de HTML et de CSS, les services ont une interface
graphique rudimentaire.</p>
          <p class="defaut">Le code lui-même est loin d’avoir
le niveau pour une application industrielle, car il sert avant tout
de bac à sable pour pratiquer diverses technologies. En fonction
du sujet, le code peut être de très bon niveau
si le but du TP était de travailler sur sa qualité,
ou bien de qualité médiocre si le but du TP correspondant était
de montrer une fonctionnalité qui nécessitait
ce code pour être réalisée, mais pour
laquelle le code n’avait qu’une visée temporaire. Dans certains
cas, le code source est même volontairement porteur d’erreurs, lorsque
l’objectif était de faire détecter aux étudiants
des mauvaises pratiques de programmation, en termes de performance
ou en termes de sécurité logicielle.&nbsp;</p>
          <p class="defaut">Bref, Middle Office présente des
limitations très fortes en termes logiciels, et il est
fortement recommandé de ne surtout pas utiliser cette application comme
exemple de quoi que ce soit. Son objectif est uniquement d’être
un support pour des exercices, en l’occurrence le déploiement
d’une application en microservices sur des conteneurs Docker. Pour
atteindre ce but, elle possède par contre une très
bonne structure conceptuelle, ce qui est le point qui importe le
plus dans notre utilisation.</p>
        </div>
        <div class="sect3" id="refTitle6">
          <h3 class="title">c. Où trouver l’application exemple</h3>
          <p class="defaut">L’application reste un travail en mouvement,
qui s’améliore au fur et à mesure du temps. La
version stabilisée pour le présent ouvrage est
disponible sur <a class="url" href="https://dev.azure.com/eni-kubernetes/_git/middleoffice-microservices-v2?version=GTv0.2" target="_blank">https://dev.azure.com/eni-kubernetes/_git/middleoffice-microservices-v2?version=GTv0.2</a>.
Cette version v0.2 correspond aux captures d’écran qui seront
utilisées ci-dessous, et les livrables correspondants sont
repris sur le site web des Éditions ENI. Nous encourageons
le lecteur qui le souhaite à se référer au
projet original s’il souhaite disposer de nouvelles versions. Dans
tous les cas, la version fournie permet toutes les explorations
présentées ci-dessous.</p>
          <p class="defaut">Tout le code source est disponible sur un
dépôt Azure DevOps, permettant ainsi au lecteur
de récupérer facilement tous les fichiers nécessaires
pour réaliser les exercices sur sa propre infrastructure&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP01.png" title="images/05EP01.png" src="IMAGES/05EP01.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Les commandes à utiliser pour ce
faire sont les suivantes&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//dev.azure.com/eni-kubernetes/_git/middleoffice-&nbsp;</span>
microservices-v2&nbsp;
cd middleoffice-microservices-v2&nbsp;
git checkout v0<span class="hljs-number">.2</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que la désignation
de v2 pour le projet fait suite à une première
version qui avait été programmée principalement
en Node.js, et sous forme de projets distincts.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle7">
          <h3 class="title">d. Utilisation des API<var style="display:none"> API</var></h3>
          <p class="defaut">En bon microservices, les différentes
parties de l’application Middle Office ne parlent les unes aux autres
que par le biais d’API, qui font l’objet de contrats d’appel. Ainsi,
même si l’implémentation de ces contrats (bref,
le code derrière l’API) change, le contrat est resté le
même et les appelants ne sont normalement pas impactés.
Cet aspect&nbsp;contractuel et la compatibilité ascendante
qui en découle sont les piliers d’une architecture microservices
où la complexité reste maîtrisée.
Si des contrats ne sont pas clairement établis, la complexité additionnelle
due au fort découpage des services fait que le tout a rapidement tendance à devenir
plus lent à faire évoluer que l’architecture monolithique qu’il
remplace, alors que le but était justement de trouver un
remplacement plus souple et adaptable. De nombreux retours d’expérience
documentent ce qui est désormais un anti-pattern reconnu, à savoir
la non-maîtrise de la complexité dans les architectures
de microservices, principalement à cause d’un mauvais découpage
des microservices.</p>
          <p class="defaut">Dans le cas de notre application exemple,
les API principales sont les suivantes&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1"><span class="courier11">demandes-backoffice</span>&nbsp;:
persistance des demandes.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">demande-creer</span>&nbsp;:
interface permettant de choisir un type de demande à créer.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">demande-remplir</span>&nbsp;:
interface permettant de remplir les différentes données
associées à un type de demande et de soumettre
cet envoi au Back Office.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">demandes-liste</span>&nbsp;:
interface et API de listage des demandes.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">decisions</span>&nbsp;:
interface de manipulation des décisions sur les demandes.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">decisions-backoffice</span>&nbsp;:
persistance des décisions prises sur les demandes.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">parametrage</span>&nbsp;:
API permettant de créer de nouveaux types de demandes.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">welcome</span>&nbsp;: écrans
liés à la page de bienvenue. Ce service porte
la structure graphique de l’application et intègre les
contenus fournis par d’autres services, soit sous la forme de portions
d’interface (en iFrame, pour les connaisseurs) soit par des appels&nbsp;aux
autres API.</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Il s’agit des API exposées, mais
certains liens entre conteneurs sont internes, comme les liaisons
aux bases de données MongoDB auxquels trois des services délèguent
les fonctionnalités de persistance des entités
qu’ils gèrent (à savoir les demandes, les décisions&nbsp;et
le paramétrage, qui sont gérés de manière
complètement indépendante, comme recommandé par
les bonnes pratiques d’architecture microservices).</p>
          <p class="defaut">La section suivante explique davantage le
contenu des API, en montrant comment elles s’appellent les unes
les autres.</p>
        </div>
        <div class="sect3" id="refTitle8">
          <h3 class="title">e. Scénarios d’utilisation</h3>
          <p class="defaut">Le scénario d’usage standard de l’application
Middle Office consiste à ce qu’une personne crée
une demande, puis qu’une autre personne choisisse cette demande
dans une liste et appose une décision dessus.</p>
          <p class="defaut">En amont, un gestionnaire de paramétrage
aura créé le type de demande, ainsi que les&nbsp;décisions
possibles et tous les libellés associés, en prenant éventuellement
en compte l’internationalisation de ce paramétrage. Pour
cela, le paramétreur appellera l’API <span class="courier11">/api/parametrage</span> du
service <span class="courier11">parametrage</span>. Le verbe <span class="courier11">POST</span> lui permettra d’injecter un fichier
JSON décrivant le paramétrage d’un type de demande.
Ce fichier, dont deux exemples sont disponibles sur le site des Éditions
ENI, sera décrit plus loin en détail, mais pour
comprendre le fonctionnement de l’application, il est nécessaire
d’expliquer quelques points&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">Un paramétrage
de type de demande porte un identifiant unique sous forme d’une
URN, par exemple <span class="courier11">urn:esaip:typeDemande:MOD_ADR</span>.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Une liste de champs à remplir
dans la demande est fournie sous forme de tableau JSON, avec pour
chaque champ le libellé associé, mais aussi le
type d’entrée attendu (un nombre, un texte, une date, etc.)
ainsi que le caractère obligatoire de cette saisie. Par
exemple, dans une demande de changement d’adresse, on peut rendre
le code postal obligatoire tandis que le pays ne le sera pas.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Une liste des traitements est également
incluse dans le paramétrage, qui permet de montrer tous
les choix possibles par le validateur (celui qui va faire porter
une décision sur la demande) mais aussi de spécifier
quelles doivent être les opérations informatiques&nbsp;qui
suivent ce choix. Par défaut, une décision est
simplement stockée,&nbsp;mais l’ajout de champs dans
l’attribut <span class="courier11">actions</span> permet de spécifier
(à la manière de webhooks, pour les experts) des
ensembles d’appels d’URL qui doivent être exécutés à la
suite de telle ou telle décision.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Les libellés sont internationalisables
en suivant le standard de structure composé d’un attribut <span class="courier11">lang</span> reprenant le code ISO de culture
et d’un attribut <span class="courier11">value</span> portant le
libellé correspondant. Les exemples mis à disposition fournissent
des libellés pour les cultures <span class="courier11">fr-FR</span> (français
de France) et parfois <span class="courier11">en</span> (anglais).</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Lorsque l’utilisateur accède à l’application,
la racine correspond à une page d’accueil permettant de
se rediriger ensuite vers l’interface graphique correspondant au
traitement voulu&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP02.png" title="images/05EP02.png" src="IMAGES/05EP02.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La création d’une nouvelle demande
fait apparaître une interface servie par l’API <span class="courier11">/demandes/creer</span> du
service <span class="courier11">demande-creer</span>&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP03.png" title="images/05EP03.png" src="IMAGES/05EP03.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La liste déroulante est peuplée
avec les valeurs issues d’un appel réalisé côté serveur
sur l’API <span class="courier11">parametrage</span>, cette fois-ci
en mode <span class="courier11">GET</span> pour retrouver la liste
de tous les types de demandes possibles avec les options associées.
Il se trouve que dans ce cas, seuls le libellé et l’identifiant
seront utilisés.</p>
          <p class="defaut">En cliquant sur le bouton <b>Créer</b> du
formulaire, un appel est réalisé sur l’API <span class="courier11">/demandes/remplir</span> du
service <span class="courier11">demande-remplir</span>. On peut
d’ailleurs voir sur la capture ci-dessous&nbsp;que c’est bien
le code identifiant, et non le libellé, du type de demande
qui a bien été passé en paramètre
dans l’URL&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP04.png" title="images/05EP04.png" src="IMAGES/05EP04.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Après avoir saisi des informations
exemples sur ce type de demande, à savoir un changement
d’adresse, le formulaire nous envoie par rebond sur l’API <span class="courier11">decisions</span> ci-dessous,&nbsp;qui
permet de faire porter un choix parmi la liste donnée sur
une demande qui reprend l’identifiant généré par
la base de données MongoDB&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP06.png" title="images/05EP06.png" src="IMAGES/05EP06.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">À noter encore une fois que l’interface
est très spartiate et que l’information fournie sur la
demande est réalisée sous forme d’une iFrame (portion
de document HTML) contenant uniquement du texte de résumé,
et le tout dans un bloc de taille fixe. Il n’en&nbsp;reste pas
moins qu’elle est fonctionnelle, avec un appel pour obtenir l’iFrame à l’API <span class="courier11">/demandes/iframe</span> du
service <span class="courier11">demandes-liste</span> ainsi qu’un
formulaire pointant sur <span class="courier11">/demandes/envoi</span> du
service <span class="courier11">/decisions</span>, qui
lui-même appellera le Back Office pour les décisions.</p>
          <p class="defaut">Un clic sur le bouton <b>Accepter</b> montre
que des erreurs d’encodage sont encore présentes, mais
la décision a bien été persistée&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP07.png" title="images/05EP07.png" src="IMAGES/05EP07.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Un retour à la liste des demandes
comme proposé montre les demandes en cours ou validées&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP08.png" title="images/05EP08.png" src="IMAGES/05EP08.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Un retour par la page d’accueil permet de
consulter également les décisions portées
sur les demandes, dans une interface encore plus dépouillée,
qui n’affiche que le code JSON de ces entités&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP09.png" title="images/05EP09.png" src="IMAGES/05EP09.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Au final, ce cas d’usage simple fait appel à pratiquement
toutes les API disponibles dans cette application d’exemple. Bien
que la fonctionnalité soit basique et les interfaces peu
travaillées, cette application cache toutefois un certain
degré de sophistication dans sa décomposition
très granulaire en microservices, chacun portant une API
contractuelle. Ainsi, l’évolutivité et la mise à l’échelle
sont de très haut niveau par rapport à une application équivalente
qui aurait été codée de manière
monolithique. Le travail sur cette partie de l’architecture n’est
peut-être pas le plus visible, mais pour certains types d’applications
ou même de systèmes d’information, il constitue
la colonne&nbsp;vertébrale des flux de données
et est donc bien plus important que celui porté sur une
interface, qui variera de toute façon au gré des
modes et des frameworks.</p>
        </div>
      </div>
      <div class="sect2" id="refTitle9">
        <h2 class="title">3. Mode de développement</h2>
        <p class="defaut">Bien que le sujet soit principalement le déploiement
de l’application à l’aide de conteneurs Docker, il est
important de préciser quelques points sur la façon dont
l’application a été conçue et programmée,
car certains de ces points ont un impact direct sur le mode de déploiement
que nous allons mettre en œuvre.</p>
        <div class="sect3" id="refTitle10">
          <h3 class="title">a. Code source et paramétrage</h3>
          <p class="defaut">Pour la plupart des fonctionnalités
de l’application, il n’est pas nécessaire de comprendre
quoi que ce soit au code source, ni même de savoir qu’il
est basé sur .NET Core, et en particulier la technologie
Web API. Le lecteur curieux pourra récupérer le
code source complet et l’étudier dans l’éditeur
de son choix. Le code source est accompagné de fichiers
de paramétrage exemple, dont nous montrons ci-dessous un
extrait&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP10.png" title="images/05EP10.png" src="IMAGES/05EP10.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Quelques points sont toutefois à relever
par rapport à leur importance dans le déploiement.
Le premier porte sur le code source mis en œuvre pour exposer l’API
sur un port&nbsp;; comme le montre le <span class="courier11">Dockerfile</span> ci-dessous
correspondant au service <span class="courier11">parametrage</span>,&nbsp;aucune
surcharge du port d’exposition n’est réalisée
et l’application exposera donc le port HTTP 80 par défaut&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">FROM microsoft/dotnet:2.2-sdk AS builder&nbsp;
WORKDIR /app&nbsp;
ADD /parametrage.csproj /app&nbsp;
RUN dotnet <span class="hljs-keyword">restore</span>&nbsp;
<span class="hljs-keyword">ADD</span> / /app&nbsp;
RUN <span class="hljs-keyword">dotnet</span> publish -o <span class="hljs-keyword">output</span>&nbsp;
<span class="hljs-keyword">FROM</span> microsoft/<span class="hljs-keyword">dotnet</span>:<span class="hljs-number">2.2</span>-aspnetcore-runtime&nbsp;
COPY <span class="hljs-comment">--from=builder /app/output /app&nbsp;</span>
WORKDIR /app&nbsp;
ENTRYPOINT [<span class="hljs-string">"dotnet"</span>, <span class="hljs-string">"parametrage.dll"</span>]</code></pre>
          <p class="defaut">Tous les autres fichiers <span class="courier11">Dockerfile</span> suivent
le même modèle, à part celui du service <span class="courier11">welcome</span> qui est basé sur
Nginx, mais qui reste, lui aussi, cantonné aux expositions
de port standards&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">FROM</span> nginx:<span class="hljs-number">1.15</span><span class="hljs-number">.5</span>&nbsp;
ADD *.css /usr/share/nginx/html/&nbsp;
ADD images /usr/share/nginx/html/images&nbsp;
ADD *.html /usr/share/nginx/html/&nbsp;
ADD *.js /usr/share/nginx/html/</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Les versions utilisées pour
.NET et pour Nginx ne sont pas les plus récentes, ni même
les versions stables recommandées&nbsp;: .NET va bientôt être
officiellement en 5.0 et la version stable est la Core 3.1, tandis
que Nginx existe en version 1.19.2, avec une version stable en 1.18.0.
Mais ces retards de version sont sans importance pour l’usage que
nous aurons&nbsp;de l’application exemple qui, encore une fois,
n’est qu’un support d’exercices et en aucun cas un modèle
de développement.</p>
            </div>
          </div>
          <p class="defaut">En dehors de ces informations utiles pour
le déploiement, le fait que le code source ait recours à des
variables d’environnement est également à souligner. Par
exemple, dans le même service en charge du paramétrage
de l’application, la variable d’environnement <span class="courier11">URL_SRV_DB_PARAM</span> est
utilisée pour spécifier la chaîne de
connexion à la base de données utilisant le protocole
MongoDB à laquelle le service délègue
la persistance des données&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP11.png" title="images/05EP11.png" src="IMAGES/05EP11.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La première ligne de code permet
de récupérer la valeur de cette variable d’environnement
et de spécifier une valeur par défaut au cas où elle
ne serait pas définie. Une autre variable d’environnement
est particulièrement importante, à savoir <span class="courier11">URL_BASE</span>, qui sert pour spécifier
la partie fixe de l’URL sous laquelle l’application est exposée,
et qui sera utilisée à chaque fois qu’un service
aura besoin de pointer sur un autre, en la complétant par
le reste de l’URL qui est conventionnel, reprenant l’exposition
du service ainsi que l’adresse relative des différentes
fonctionnalités d’API exposées, comme le montre
la ligne sélectionnée dans l’extrait de code ci-dessous.</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP12.png" title="images/05EP12.png" src="IMAGES/05EP12.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Il serait tout à fait possible
de faire en sorte que l’application n’utilise que des URL relatives
comme on le fait à l’intérieur du projet <span class="courier11">welcome</span>, mais ceci constituerait un
couplage entre les services, qui seraient alors obligatoirement
déployé sous le même nom d’hôte.
Le fait de passer par des URL absolues ménage un degré de
liberté de plus, même s’il faudrait dupliquer
les variables d’environnement pour en profiter réellement.
Dans une application en production, ce type de problème
est plutôt géré par un service dédié d’API Gateway.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle11">
          <h3 class="title">b. Intégration continue<var style="display:none"> Intégration continue</var></h3>
          <p class="defaut">Le choix de la forge logicielle influe bien
sûr également sur le déploiement, tout
simplement car les livrables doivent bien être fournis
d’une manière ou d’une autre pour atteindre les machines
du cluster Kubernetes. Le format de ces livrables est, logiquement,
celui d’une image Docker, mais la façon dont ces images
sont créées doit être décrite
de façon à mieux comprendre les étapes
de déploiement à suivre.</p>
          <p class="defaut">Pour rappel, le code source est hébergé sur
la forge logicielle Azure DevOps, dans un dépôt
(ou plutôt une organisation, pour reprendre le vocabulaire
Microsoft) nommé <span class="courier11">eni-kubernetes</span> et
disponible sur <a class="url" href="https://dev.azure.com/eni-kubernetes/" target="_blank">https://dev.azure.com/eni-kubernetes/</a>&nbsp;<var style="display:none"> Azure DevOps</var></p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP13.png" title="images/05EP13.png" src="IMAGES/05EP13.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le lecteur ne verra normalement pas
tous les projets, mais seulement certains ayant été déclarés
comme publics et accessibles sans restriction en mode lecture seule.</p>
            </div>
          </div>
          <p class="defaut">La forge fait apparaître quatre projets
publics dans l’organisation&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1"><span class="courier11">middleoffice-microservices</span>&nbsp;:
ce projet contient une ancienne version du code, écrite
en Node.js, qui n’est désormais plus entretenue.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">middleoffice-microservices-v2</span>&nbsp;:
ce projet contient le code source .NET Core de l’application exemple
que nous allons utiliser par la suite, et qui est une évolution
majeure de la version précédente, sans compatibilité ascendante,
d’où le changement de version majeure et l’utilisation
d’un projet à part.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">middleoffice-swarm-deployment</span>&nbsp;:
ce projet peut être considéré comme obsolète,&nbsp;car
il utilise Swarm, une technologie de déploiement désormais
supplantée par Kubernetes. Toutefois, Swarm compense son manque
de sophistication par une simplicité élégante
et une architecture claire qui nous servira dans le chapitre suivant
pour introduire les concepts d’orchestration de manière
progressive.</p>
              </li>
              <li class="liste1">
                <p class="liste1"><span class="courier11">middleoffice-k8s-deployment</span>&nbsp;:
ce projet sert pour le déploiement de l’application dans
un orchestrateur Kubernetes, option la plus industrielle et que
nous décrirons&nbsp;dans le chapitre suivant.</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Pour en revenir à ce qu’il est nécessaire
de connaître de l’application, les fichiers <span class="courier11">Dockerfile</span>&nbsp;ont été rapidement
montrés plus haut, mais il convient d’expliquer comment
ils sont compilés et où sont placés les
livrables associés. La réponse réside
dans la notion de build d’Azure DevOps. En se plaçant sur
le projet de code source dans sa version .NET Core et en cliquant
sur la section <b>Pipelines</b>, nous
voyons les différents&nbsp;builds (scénarios
de compilation) qui vont produire les images&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP14.png" title="images/05EP14.png" src="IMAGES/05EP14.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La sélection d’un de ces builds,
par exemple celui pour le service <span class="courier11">parametrage</span>,
et l’activation du mode de modification par le bouton <b>Edit</b> nous amène sur la définition
suivante, montrant qu’après une phase de collecte des codes
sources, l’agent de compilation réalise deux actions, à savoir
la compilation d’une image Docker et une opération de dépôt
de cette image dans un registre&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP15.png" title="images/05EP15.png" src="IMAGES/05EP15.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Sélectionner la première
opération nous indique les paramètres qu’elle
utilise, sur le côté droit de l’interface&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP16.png" title="images/05EP16.png" src="IMAGES/05EP16.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Nous voyons en particulier que le fichier <span class="courier11">Dockerfile</span> utilisé est, conformément
aux attentes, <span class="courier11">parametrage/Dockerfile</span>.
En descendant un peu plus bas dans la liste d’options, nous constatons
que le nom de l’image générée est décrit
partiellement par un nom en dur, mais aussi par un numéro
de version qui est variable, et qui se trouve en l’occurrence être
celui du build généré&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP17.png" title="images/05EP17.png" src="IMAGES/05EP17.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">L’image est également étiquetée <span class="courier11">latest</span>, ce qui correspond à l’étiquette
par défaut pour Docker.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention, cette dernière
information est importante pour la façon dont le déploiement
continu est géré, et l’option n’est pas cochée
par défaut dans l’interface actuelle d’Azure DevOps.</p>
            </div>
          </div>
          <p class="defaut">En parcourant les options de la seconde étape
de build, une information supplémentaire est glanée, à savoir
l’endroit où l’image est envoyée après
avoir été buildée, en l’occurrence&nbsp;sur
le registre public Docker Hub, dans un dépôt nommé simplement <span class="courier11">middleoffice</span>.</p>
          <p class="defaut">Ainsi, toute compilation fait apparaître
les images correspondantes dans le registre standard fourni par
Docker, comme on peut le vérifier en se connectant directement
sur le site web correspondant&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/05EP18.png" title="images/05EP18.png" src="IMAGES/05EP18.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmN4f9iYy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Les images sont publiques, ce qui fait que
le lecteur pourra déployer l’application sans avoir à toucher
le code s’il le souhaite.</p>
        </div>
      </div>
    </div></div></div></div></app-page-content><!----><!----><!----></div></kendo-pdf-export>