<kendo-pdf-export _ngcontent-uvf-c168="" papersize="A4" margin="2cm" id="div-book-content" class="col-12 col-sm-10 offset-0 div-book-content" uipath_custom_id="10"><div><app-page-content _ngcontent-uvf-c168="" _nghost-uvf-c166="" class="font-size-14 font-size-sm-20"><div _ngcontent-uvf-c166="" class="mainContent mt-4"><div _ngcontent-uvf-c166="" id="bookContent" class="bookContent"><div _ngcontent-uvf-c166="" id="content"><div class="sect1" style="abcpdf-tag-visible: true" id="AU_8e6a9da2-5ca8-44c3-80a4-11442ebf7878" uri="ImagesUri_../download/5c180f28-f752-47db-98e8-8656c84b148d/images/">
      <h1 class="title">L’approche Docker Swarm<var style="display:none"> Swarm</var></h1>
      <p class="defaut">Toutes ces explications théoriques étant
posées, nous pouvons passer à la mise en œuvre
avec Swarm, ou, pour être plus précis, le mode
Swarm de Docker. Ce dernier est un système de clustering
des démons et d’orchestration des conteneurs implémenté nativement
dans le produit depuis sa version 1.12. Auparavant, un logiciel
externe existait sous le nom de Docker Swarm, d’où le nom
légèrement différent aujourd’hui de mode
Swarm pour Docker. Dans la suite, nous utiliserons simplement l’expression
Swarm.</p>
      <p class="defaut">Comme expliqué plus haut, l’avantage
de Swarm sur d’autres orchestrateurs est qu’il est très
simple à prendre en main par une personne habituée à utiliser le
client Docker, l’outil réutilisant au mieux les API de
Docker et supportant l’utilisation de Docker Compose, ce qui permet
de reprendre une grande partie des habitudes de travail développées
dans les chapitres précédents.</p>
      <p class="defaut">Ce support de la description d’une application
dans la grammaire Docker Compose n’est plus réellement
un avantage, dans la mesure où Kubernetes est désormais
le logiciel&nbsp;référence et sa grammaire
YAML de description d’artefacts celle qui est - par conséquent - la
plus utilisée. Docker a d’ailleurs annoncé récemment
que son produit allait supporter la grammaire Kubernetes pour ses
définitions de charges applicatives. Certains le verront
comme la preuve de la perte d’influence de Docker sur le domaine
des orchestrateurs, d’autres comme une tentative astucieuse de rester
dans le jeu. Après tout, Kubernetes a aussi obtenu son
succès actuel en grande partie par son support&nbsp;des
conteneurs Docker.</p>
      <div class="sect2" id="refTitle0">
        <h2 class="title">1. Gestion du cluster Swarm</h2>
        <div class="sect3" id="refTitle1">
          <h3 class="title">a. Prérequis</h3>
          <p class="defaut">Pour tester le fonctionnement de Swarm et
créer un petit cluster de test, nous aurons besoin de trois
machines connectées sur un même réseau.
La création d’une machine virtuelle dans le cloud ayant
déjà été exposée plus
haut, nous n’approfondissons pas cette étape et considérons
que les trois machines existent. Par la suite, nous les désignerons
sous les noms de <span class="courier11">Manager</span>, <span class="courier11">Agent1</span> et <span class="courier11">Agent2</span>.
Comme c’est presque uniquement sur le manager que nous agirons,
les deux autres machines étant pilotées par la
première, il est recommandé de mettre en place
un alias pour y accéder plus facilement si ce sont des
machines externes.</p>
          <p class="defaut">Les machines utilisées dans l’exemple
ci-dessous sont connectées comme suit&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP02.png" title="images/06EP02.png" src="IMAGES/06EP02.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Il est essentiel, si ce sont des machines
fournies par un cloud, qu’elles soient bien positionnées&nbsp;sur
un réseau interne commun. Et bien sûr, si elles
sont accédées en SSH depuis une machine distante
et qu’on souhaite leur faire exposer du HTTP / HTTPS, il
est également important qu’elles soient exposées
sur le réseau Internet, en prenant soin d’ouvrir les ports
22, 80 et 443 sur le pare-feu.</p>
        </div>
        <div class="sect3" id="refTitle2">
          <h3 class="title">b. Initialisation</h3>
          <p class="defaut">Les machines devant communiquer entre elles
pour établir un cluster, une information nécessaire
pour la création du cluster est l’adresse IP sur laquelle
le manager devra être appelé. Il serait aberrant
du point de vue de la performance et de la sécurité que
les trois machines passent par le réseau Internet pour échanger
les messages de gestion du cluster, et cette adresse IP doit donc
bien être celle correspondant au réseau interne,
et surtout pas l’adresse IP publique.</p>
          <p class="defaut">Pour retrouver cette information, il convient
d’utiliser la commande <span class="courier11">ifconfig</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs typescript">azureuser<span class="hljs-meta">@ClearDockerENI</span>~ $ ifconfig&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
docker0&nbsp;&nbsp; Link encap:Ethernet&nbsp;&nbsp;HWaddr <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:<span class="hljs-number">4</span>A:EE:<span class="hljs-number">77</span>:<span class="hljs-number">83</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet addr:<span class="hljs-number">172.17</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>&nbsp;&nbsp;Bcast:<span class="hljs-number">172.17</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span>&nbsp;&nbsp;
Mask:<span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP BROADCAST MULTICAST&nbsp;&nbsp;MTU:<span class="hljs-number">1500</span>&nbsp;&nbsp;Metric:<span class="hljs-number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX packets:<span class="hljs-number">0</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> frame:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TX packets:<span class="hljs-number">0</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> carrier:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collisions:<span class="hljs-number">0</span> txqueuelen:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX bytes:<span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> b)&nbsp;&nbsp;TX bytes:<span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> b)&nbsp;
&nbsp;
docker_gw Link encap:Ethernet&nbsp;&nbsp;HWaddr <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:A1:<span class="hljs-number">60</span>:<span class="hljs-number">65</span>:A7&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet addr:<span class="hljs-number">172.18</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>&nbsp;&nbsp;Bcast:<span class="hljs-number">172.18</span><span class="hljs-number">.255</span><span class="hljs-number">.255</span>&nbsp;&nbsp;
Mask:<span class="hljs-number">255.255</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP BROADCAST MULTICAST&nbsp;&nbsp;MTU:<span class="hljs-number">1500</span>&nbsp;&nbsp;Metric:<span class="hljs-number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX packets:<span class="hljs-number">0</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> frame:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TX packets:<span class="hljs-number">0</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> carrier:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collisions:<span class="hljs-number">0</span> txqueuelen:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX bytes:<span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> b)&nbsp;&nbsp;TX bytes:<span class="hljs-number">0</span> (<span class="hljs-number">0.0</span> b)<b>&nbsp;
&nbsp;
eth0&nbsp;</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Link encap:Ethernet&nbsp;&nbsp;HWaddr <span class="hljs-number">00</span>:<span class="hljs-number">0</span>D:<span class="hljs-number">3</span>A:E7:<span class="hljs-number">2</span>F:D2&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet addr:<b><span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span></b>&nbsp;&nbsp;Bcast:<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.255</span>&nbsp;&nbsp;
Mask:<span class="hljs-number">255.255</span><span class="hljs-number">.255</span><span class="hljs-number">.0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP BROADCAST RUNNING MULTICAST&nbsp;&nbsp;MTU:<span class="hljs-number">1500</span>&nbsp;&nbsp;Metric:<span class="hljs-number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX packets:<span class="hljs-number">5468</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> frame:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TX packets:<span class="hljs-number">5124</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> carrier:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collisions:<span class="hljs-number">0</span> txqueuelen:<span class="hljs-number">1000</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX bytes:<span class="hljs-number">2339817</span> (<span class="hljs-number">2.2</span> Mb)&nbsp;&nbsp;TX bytes:<span class="hljs-number">1088636</span> (<span class="hljs-number">1.0</span> Mb)&nbsp;
&nbsp;
lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Link encap:Local Loopback&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet addr:<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>&nbsp;&nbsp;Mask:<span class="hljs-number">255.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UP LOOPBACK RUNNING&nbsp;&nbsp;MTU:<span class="hljs-number">65536</span>&nbsp;&nbsp;Metric:<span class="hljs-number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX packets:<span class="hljs-number">12</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> frame:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TX packets:<span class="hljs-number">12</span> errors:<span class="hljs-number">0</span> dropped:<span class="hljs-number">0</span> overruns:<span class="hljs-number">0</span> carrier:<span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;collisions:<span class="hljs-number">0</span> txqueuelen:<span class="hljs-number">1000</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RX bytes:<span class="hljs-number">840</span> (<span class="hljs-number">840.0</span> b) &nbsp;TX bytes:<span class="hljs-number">840</span> (<span class="hljs-number">840.0</span> b)</code></pre>
          <p class="defaut">Une fois muni de cette information, la mise
en place d’un cluster Swarm est extrêmement simple&nbsp;:
une machine choisie pour porter un node de type "manager" va initialiser
le cluster et générer un ticket qui sera ensuite
utilisé par les autres machines pour rejoindre le cluster.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que, par défaut,
les nodes de type "manager" peuvent accueillir des tâches
au même titre que les nodes de type "agents" dans un cluster
Swarm.</p>
            </div>
          </div>
          <p class="defaut">La première étape se déroule
donc sur la machine préalablement créée
et qui est désignée par le vocable "Manager".</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous à la machine <span class="courier11">Manager</span> en utilisant PuTTY s’il s’agit
d’une machine distante ou en ouvrant une session locale sinon.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>En utilisant la commande <span class="courier11">ifconfig</span> montrée
plus haut, récupérez l’adresse IP de cette machine
(dans l’exemple qui suit, nous considérerons que la valeur
est 10.0.0.4 comme sur l’environnement de l’auteur).</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez la commande suivante&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">swarm</span> <span class="hljs-selector-tag">init</span> <span class="hljs-selector-tag">--advertise-addr</span> 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.4</span><var style="display:none"> <span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">swarm</span> <span class="hljs-selector-tag">init</span></var></code></pre>
          <p class="defaut">Docker répond le message suivant
(à part bien sûr que le ticket pour joindre le cluster
Swarm sera différent, celui-ci étant à dessein
long pour éviter d’être trouvé au hasard,
ce qui compromettrait la sécurité de l’ensemble)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet">Swarm initialized: current node (tgox69lz7q6lyp5ypyzr4lf9w) <span class="hljs-keyword">is</span> &nbsp;
now a manager.&nbsp;
&nbsp;
<span class="hljs-keyword">To</span> add a worker <span class="hljs-keyword">to</span> this swarm, run the following command:&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;docker swarm <span class="hljs-keyword">join</span> --token SWMTKN<span class="hljs-number">-1</span><span class="hljs-number">-0</span>tvo2z6j57x8vwgl9fwg 
gumdox6pzmxgwsuicgmmbw3wzm919qb4uqdh9k0jk1l4jpgabskkug7 
<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span>:<span class="hljs-number">2377</span>&nbsp;
&nbsp;
<span class="hljs-keyword">To</span> add a manager <span class="hljs-keyword">to</span> this swarm, run ’docker swarm <span class="hljs-keyword">join</span>-token &nbsp;
manager’ <span class="hljs-keyword">and</span> follow the instructions.<var style="display:none"> docker swarm <span class="hljs-keyword">join</span></var></code></pre>
          <p class="defaut">Nous allons précisément
suivre ces instructions pour la seconde partie de la mise en place
du cluster, mais pour l’instant intéressons-nous à l’état
du cluster&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Toujours sur la machine <span class="courier11">Manager</span>,
entrez la commande <span class="courier11">docker node ls</span>.</p>
          </div>
          <p class="defaut">L’affichage est alors comme suit (encore une
fois, les valeurs changeront bien sûr)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">La machine correspondant au manager (dans
notre cas, <span class="courier11">ClearDockerENI</span>, qu’on
retrouve&nbsp;dans la colonne <span class="courier11">HOSTNAME</span>)
fait désormais partie - mais elle s’y trouve pour
l’instant seule - de la liste des nodes. Elle est donc
disponible dans le cluster, prête à l’usage, et
l’astérisque à côté de l’identifiant
Docker montre que c’est depuis cette machine&nbsp;que la commande
est lancée. Enfin, comme le signale la dernière
colonne, ce manager a été élu "Leader"
du cluster, ce qui est logique vu qu’il s’agit présentement
du seul manager.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le terme d’élection est le
jargon utilisé habituellement pour décrire le
processus permettant de désigner un des nœuds
de type manager comme responsable du pilotage des autres. Ce système
d’élection est particulièrement important dans
le fonctionnement du cluster, car il doit amener à élire
rapidement un leader de remplacement dans le cas où le
leader courant ne fait plus correctement son travail. Nous ne rentrerons
pas dans le détail de ce fonctionnement, car il est entièrement
pris en charge par Swarm et un utilisateur standard ne lui est normalement
jamais exposé. Les lecteurs intéressés
pourront consulter la documentation sur l’algorithme de consensus
Raft.</p>
            </div>
          </div>
          <p class="defaut">Cette première partie étant
terminée, nous allons pouvoir passer aux commandes à lancer
sur les autres machines.</p>
        </div>
        <div class="sect3" id="refTitle3">
          <h3 class="title">c. Liaison des agents</h3>
          <p class="defaut">Le reste des opérations se passe
sur les machines <span class="courier11">Agent1</span> et <span class="courier11">Agent2</span> (celles dont le nom dans la
configuration de l’auteur est <span class="courier11">ClearLinux-worker1</span> et <span class="courier11">ClearLinux-worker2</span>). Vue la faible
taille de notre cluster, la répétition de la commande
ci-dessous de manière manuelle ne posera pas de problème. Dans
le cas d’un cluster de taille importante, une approche automatisée consisterait à réaliser
la première opération expliquée&nbsp;juste
avant de manière manuelle (l’initialisation d’un cluster
ne se fait de toute façon qu’une fois, sur un nœud
de type manager), puis à injecter la commande de liaison
ci-dessous dans le script de provisionnement (de Vagrant, par exemple),
pour toutes les autres machines de type agent.</p>
          <p class="defaut">Dans notre cas, les commandes sont donc&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous à la machine <span class="courier11">Agent1</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande fournie par l’exécution
de la précédente (la commande <span class="courier11">docker&nbsp;swarm
init</span> lancée plus haut). Dans notre cas, il s’agit
de&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">swarm</span> <span class="hljs-selector-tag">join</span> <span class="hljs-selector-tag">--token</span> <span class="hljs-selector-tag">SWMTKN-1-</span>&nbsp;
0<span class="hljs-selector-tag">tvo2z6j57x8vwgl9fwggumdox6pzmxgwsuicgmmbw3wzm919q-</span>&nbsp;
<span class="hljs-selector-tag">b4uqdh9k0jk1l4jpgabskkug7</span> 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-pseudo">:2377</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Si vous n’avez pas rajouté l’utilisateur
au groupe <span class="courier11">docker</span>, pensez bien à utiliser le
préfixe <span class="courier11">sudo</span> devant la
commande ci-dessus, sous peine de recevoir un message d’erreur sur
les droits insuffisants.</p>
            </div>
          </div>
          <p class="defaut">Si tout se passe bien, le message suivant
doit apparaître&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">This node joined a swarm <span class="hljs-keyword">as</span> a worker.</code></pre>
          <p class="defaut">Dans le cas contraire, il sera nécessaire
de vérifier que la machine peut bien accéder à la
machine citée, dans notre cas par l’adresse IP 10.0.0.4
et par l’intermédiaire du port 2377, qui ne doit pas être
bloqué. Si malgré cela une erreur persiste, les
forums Docker seront la prochaine étape.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Déconnectez-vous de la machine <span class="courier11">Agent1</span>.</p>
          </div>
          <p class="defaut">Vu que la machine est désormais contrôlée
par le cluster Swarm mis en place, ceci devrait&nbsp;normalement être
la seule fois où il est nécessaire de s’y connecter. Toutes
les opérations à suivre pourront désormais être
réalisées depuis le nœud manager, et
même (c’est d’ailleurs une bonne pratique) depuis n’importe
quel client Docker ayant un accès à ce nœud.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Reproduisez la manipulation sur la seconde
machine, à savoir celle nommée <span class="courier11">Agent2</span> lors de sa création
par Vagrant, plus haut dans le présent chapitre.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Retournez sur la machine <span class="courier11">Manager</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Relancez la commande <span class="courier11">docker
node ls</span>, qui devrait cette fois-ci faire apparaître
les deux nouveaux arrivants dans le cluster Swarm&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">Nous constatons effectivement que trois lignes
apparaissent désormais, et l’astérisque indique
que nous sommes connectés depuis la machine <span class="courier11">Manager</span> (toujours notre nœud
de type "manager", qui restera seul dans cette manipulation, et
qui est de surcroît leader du cluster). Les autres machines
juste ajoutées sont visibles et disponibles pour utilisation.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention, si vous lancez la commande <span class="courier11">docker node ls</span> sur une machine qui n’est
pas un nœud de type manager, le message suivant apparaîtra,
indiquant que ceci est une condition indispensable à l’utilisation
de la commande, les nœuds de type agent (worker&nbsp;nodes
en anglais) ne pouvant ni influer ni même voir l’état
du cluster.</p>
            </div>
          </div>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">Error</span> response <span class="hljs-keyword">from</span> daemon:&nbsp;<b>This node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> a swarm manager</b>. &nbsp;
Worker nodes can’t be used <span class="hljs-keyword">to</span> view <span class="hljs-keyword">or</span> modify cluster state. &nbsp;
Please run this command <span class="hljs-keyword">on</span> a manager node <span class="hljs-keyword">or</span> promote the current &nbsp;
node <span class="hljs-keyword">to</span> a manager.</code></pre>
          <p class="defaut">Par contre, il reste possible de savoir si
une machine fait partie d’un cluster Swarm en utilisant la commande <span class="courier11">docker info</span>. Ainsi, par exemple, l’exécution
de cette commande sur la machine <span class="courier11">Agent1</span> produirait
la sortie suivante (extrait)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css">(...)&nbsp;
<span class="hljs-selector-tag">Swarm</span>: <span class="hljs-selector-tag">active</span>&nbsp;
&nbsp;&nbsp;<span class="hljs-selector-tag">NodeID</span>: <span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;
&nbsp;&nbsp;<span class="hljs-selector-tag">Is</span> <span class="hljs-selector-tag">Manager</span>: <span class="hljs-selector-tag">false</span>&nbsp;
&nbsp;&nbsp;<span class="hljs-selector-tag">Node</span> <span class="hljs-selector-tag">Address</span>: 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.7</span>&nbsp;
&nbsp;&nbsp;<span class="hljs-selector-tag">Manager</span> <span class="hljs-selector-tag">Addresses</span>:&nbsp;
&nbsp;&nbsp; 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-pseudo">:2377</span>&nbsp;
(...)</code></pre>
          <p class="defaut">Notre cluster Swarm est désormais
prêt à l’emploi. Il s’agit du plus petit cluster
réaliste que nous pouvons mettre en place. Si nous avions à faire
grossir notre cluster, nous pourrions maintenant ajouter des agents
aussi facilement que montré ci-dessus, avec ces quelques étapes&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">Mettre à disposition
la machine sur le réseau.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Installer le système d’exploitation
avec Docker dessus.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Faire rejoindre le cluster Swarm à la
machine.</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Le gros avantage de cette façon de
procéder est qu’il établit une séparation
très stricte des responsabilités entre les intervenants.
Lorsque des machines physiques ou virtuelles sont utilisées,
le gestionnaire de l’application demande à l’administrateur
système des machines avec une configuration particulière. L’administrateur
doit communiquer une information sur l’identifiant de la machine
pour que le gestionnaire puisse l’utiliser, ce qui peut prêter à des
erreurs de communication ou au nécessaire dévoilement
de mots de passe pour se connecter.</p>
          <p class="defaut">De plus, la frontière n’est pas toujours
claire entre les dépendances installées par l’administrateur&nbsp;(le
système d’exploitation, au moins) et celles installées par
le gestionnaire (l’application voulue, au moins). Quid par exemple
du serveur web&nbsp;? Ou d’un composant externe à l’application&nbsp;?
Qui décide de la version du framework Java à déployer,&nbsp;en
fonction des contraintes de chacun, qui peuvent s’opposer&nbsp;?</p>
          <p class="defaut">Dans un cluster Docker, les responsabilités
sont parfaitement séparées&nbsp;: si le gestionnaire
a besoin de plus de ressources, il demande un certain nombre de nodes
en plus dans le cluster. L’administrateur rajoute des machines physiques dans
les racks et les configure pour que leurs ressources, sous forme
virtualisée ou pas, soient intégrées
dans le cluster. Il n’a pas à communiquer d’identifiant de
machine ou quoi que ce soit d’autre au gestionnaire, à part
le fait qu’il a terminé son travail. De son côté,
le gestionnaire n’a pas vu de changement sur les applications qu’il
exploite, à part qu’elles ont désormais plus de
ressources à disposition sur le cluster. Cette séparation
claire des responsabilités est capital pour rendre possible
le mode DevOps&nbsp;: les personnes ne peuvent travailler efficacement
en collaboration que si les règles d’intervention sur les
domaines sont rigoureusement établies. Cela ne veut surtout
pas dire qu’elles travaillent chacune dans leur coin, bien au contraire&nbsp;:
c’est même précisément le but de l’approche
DevOps de faire qu’elles se coordonnent de manière très
réactives. Mais pour atteindre cette collaboration, il
est essentiel que leurs objectifs soient alignés et les
"points de rencontre" parfaitement définis.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que la construction
d’un cluster est durable, et qu’il n’est nul besoin de réaliser
une quelconque opération lors d’un redémarrage
d’une ou de plusieurs machines. Les démons Docker sont
alors paramétrés en mode Swarm et se reconnecteront
d’eux-mêmes pour participer à nouveau au réseau
de démons.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle4">
          <h3 class="title">d. Ajout d’un manager</h3>
          <p class="defaut">La manipulation décrite ci-dessus
nous permettrait de faire grossir la charge supportable par notre
cluster, jusqu’à ce que le manager ait potentiellement du
mal à gérer tous les agents. Pour donner une meilleure
performance à l’ensemble, nous pourrions faire en sorte
que le manager soit désormais consacré uniquement à la
gestion des worker nodes, et donc libéré lui-même
de l’exécution de conteneurs Docker.</p>
          <p class="defaut">Pour cela, la commande ci-dessous serait utilisée&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">docker node <span class="hljs-keyword">update</span> <span class="hljs-comment">--availability drain Manager</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">La commande <span class="courier11">drain</span> peut également être
utilisée pour n’importe quel nœud du cluster dans
le cas où il est nécessaire d’intervenir sur la
machine. Elle empêche de démarrer de nouvelles
tâches sur cette machine et libère progressivement
celle-ci de ses tâches en cours en lançant des
répliques sur d’autres nœuds du cluster. C’est
Swarm qui s’occupe de toute cette mécanique complexe, qui
illustre bien le large spectre des responsabilités d’un
orchestrateur.</p>
            </div>
          </div>
          <p class="defaut">Il est également possible de rajouter
un voire plusieurs nœuds de type manager sur le cluster
Swarm, mais ceci n’aura d’incidence que sur la solidité du cluster,
et peu sur sa performance (en fait, l’inverse est même
vrai, car les managers doivent alors se synchroniser en permanence
pour qu’un autre puisse prendre le relai si jamais le leader tombe).</p>
          <p class="defaut">On pourrait s’attendre à ce que la
perte du manager dans le cas d’un cluster avec un seul nœud
de ce type aboutisse à l’arrêt complet du fonctionnement, mais
ce n’est pas le cas&nbsp;: tous les conteneurs sur les machines
de type agent continuent à fonctionner même sans
manager (un bon exemple de résilience). Il s’agit évidemment
d’un mode de repli qui doit être corrigé au plus
vite mais, au moins, les processus "métier" ne sont pas
impactés, ce qui augmente les chances que la panne ne soit
pas perçue par les utilisateurs finaux des services portés
par les conteneurs.</p>
          <p class="defaut">La commande pour ajouter une machine (ou,
pour être plus précis, un démon Docker)
dans un cluster est pour ainsi dire la même que pour ajouter
un agent. Seul le ticket à utiliser est différent,
pour des raisons de sécurité, le niveau de confiance
nécessaire pour accueillir un nœud en tant que
manager étant plus élevé que pour lui
confier de simples tâches d’exécution de conteneurs.
Pour trouver cette seconde valeur, nous allons&nbsp;utiliser
la commande <span class="courier11">docker swarm join-token</span> avec
la valeur d’option <span class="courier11">manager</span>.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Si nous utilisons la commande avec
son option <span class="courier11">worker</span>, nous obtenons
exactement la même information que précédemment.</p>
            </div>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sur la machine <span class="courier11">Manager</span>,
lancez la commande <span class="courier11">docker swarm join-token
manager</span>.</p>
          </div>
          <p class="defaut">Le résultat est comme suit&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">To</span> <span class="hljs-selector-tag">add</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">manager</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">swarm</span>, <span class="hljs-selector-tag">run</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">following</span> <span class="hljs-selector-tag">command</span>:&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">swarm</span> <span class="hljs-selector-tag">join</span> <span class="hljs-selector-tag">--token</span> <span class="hljs-selector-tag">SWMTKN-1-</span>&nbsp;
0<span class="hljs-selector-tag">tvo2z6j57x8vwgl9fwggumdox6pzmxgwsuicgmmbw3wzm919q-</span>&nbsp;
3<span class="hljs-selector-tag">mu9dq7j2a0p482v8parbj06n</span> 10<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-pseudo">:2377</span></code></pre>
          <p class="defaut">C’est cette commande qui devra être
utilisée pour rajouter un nœud de type manager
au cluster (la première, vue plus haut, servait à rajouter
un agent). Imaginons par exemple que nous ayons créé une
machine nommée <span class="courier11">ManagerBis</span>.
Il serait possible de la faire rejoindre le cluster Swarm précédemment monté en
utilisant la commande ci-dessus. L’exécution de la commande <span class="courier11">docker node ls</span> produirait alors le
résultat suivant&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><span class="hljs-selector-tag">Leader</span></b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">yt7ud9ijf6gfjs90soa8bsj01</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ManagerBis</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b><span class="hljs-selector-tag">Reachable</span></b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">Conformément à ce qui est
attendu, la machine <span class="courier11">Manager</span> (<span class="courier11">ClearDockerENI</span> dans notre cas) est
bien toujours le leader, comme indiqué dans la colonne <span class="courier11">MANAGER STATUS</span>,&nbsp;mais la machine
nommée <span class="courier11">ManagerBis</span> est désormais vue
comme un manager&nbsp;possible&nbsp;: <span class="courier11">Reachable</span> signifie
que la machine peut être "atteinte" en vue de passer <span class="courier11">leader</span> si le besoin s’en faisait sentir.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention, pour effectivement apporter
de la robustesse au cluster, il serait nécessaire de passer
le nombre de managers à trois, comme cela va être
expliqué par la suite. L’ajout d’un <span class="courier11">ManagerBis</span> comme
ici ne suffit pas.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle5">
          <h3 class="title">e. Les limites à l’ajout de managers</h3>
          <p class="defaut">L’ajout de nœuds de type manager
augmente la résistance à la panne, mais cette
amélioration ne se fait pas sans coût, en l’occurrence
le temps de synchronisation des managers&nbsp;les uns avec les
autres. Pour cette raison, il est recommandé de ne pas
dépasser&nbsp;le nombre de sept managers. Au-delà de
ce nombre, le surcoût de mise en relation&nbsp;est
plus élevé que l’apport de performance.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">De plus, sept managers suffisent déjà à gérer
la charge de travail pour des centaines de workers, ce qui est déjà plus
que la majorité des usages.</p>
            </div>
          </div>
          <p class="defaut">Il est également fortement recommandé d’utiliser
des nombres impairs de managers, car un nombre pair immédiatement
supérieur n’apporte pas une meilleure résistance à la
panne. Pour bien comprendre pourquoi, la notion de quorum doit être
expliquée, et le plus simple est de prendre un exemple.
Imaginons un cluster composé de nombreux agents et de cinq
managers. Le quorum requis pour l’élection d’un leader
parmi les managers est de trois (c’est le principe de l’élection à la
majorité qualifiée). En effet, si le cluster a
commencé à cinq managers, alors si quatre managers
arrivent à se parler, c’est qu’un des managers n’est plus
accessible (panne de la machine, réseau débranché,
etc.). Toutefois, les quatre restants peuvent s’arranger entre eux
pour continuer, en sachant que le manager isolé se rendra
compte qu’il ne peut pas faire grand-chose tout seul et, s’il fonctionne
encore (mais n’est simplement plus accessible suite à une
panne de réseau, par exemple), s’arrêtera de travailler.
Même chose avec deux managers inaccessibles&nbsp;:
même s’ils arrivent à se parler l’un à l’autre,
ils ne peuvent pas poursuivre à deux car le restant des
serveurs est à trois, et donc plus à même
de continuer le travail du cluster.<var style="display:none"> Quorum</var></p>
          <p class="defaut">Que se passe-t-il si un troisième
manager tombe en panne&nbsp;? A première vue, il est
imaginable que les deux managers puissent continuer le travail.
D’ailleurs, il est même possible de faire fonctionner un
Swarm avec un seul manager, alors pourquoi pas avec deux&nbsp;?
Le problème vient du fait que ces deux managers qui restent
savent seulement qu’ils n’arrivent plus à communiquer avec les
trois autres, mais ils ne peuvent pas être sûr
que leurs confrères sont réellement en panne.
Il n’est pas impossible que le problème vienne simplement d’un
souci sur le réseau qui fait qu’eux se parlent à deux,
mais que les trois autres managers, bien qu’hors de leur portée,
fonctionnent parfaitement ensemble à trois. Or, dans ce
cas, il est essentiel que le cluster ne prenne pas le risque de
faire diverger la donnée, avec deux sous-clusters qui fonctionneraient
de manière indépendante.</p>
          <p class="defaut">Si un cluster a démarré à cinq
managers, le quorum est donc bien de trois, et dès que
le nombre de machines pouvant se parler passe en dessous de ce seuil, le
cluster doit s’arrêter, non parce qu’il ne peut plus fonctionner,
mais parce qu’il ne peut plus assurer la consistance des données
gérées. La tolérance à la panne
de ce cluster est donc de deux managers seulement sur les cinq.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que dans certains
cas, des clusters peuvent accepter un mode dégradé de
fonctionnement lorsque le nombre est inférieur au quorum.
Typiquement, il s’agit d’un mode où le cluster ne répond
qu’en lecture. C’est par exemple la façon de fonctionner
d’un cluster de serveurs DNS.</p>
            </div>
          </div>
          <p class="defaut">Un cluster avec six managers n’apportera en
rien une meilleure robustesse, car il ne pourra pas tolérer
plus de deux managers en panne. Si un troisième tombe,
il ne restera que trois managers, or le quorum pour un tel cluster
est de quatre répondants (la moitié plus un, pour éviter
le cas d’une scission en deux clusters de même taille).
Ceci a pour conséquence qu’un cluster de six managers possède
la même robustesse aux pannes qu’un cluster avec seulement cinq
managers, et qu’il est donc inutile de perdre en performance à cause
du surcoût de synchronisation pour un gain nul en tolérance à la
panne.</p>
          <p class="defaut">C’est pour cette raison que les clusters traditionnellement
réalisés utilisent trois, cinq ou sept managers,
mais jamais un nombre pair. Et comme expliqué plus haut,
il est inutile de dépasser le nombre de sept. Le seul autre
cas logique est un cluster avec un seul manager, mais il ne possède
aucune tolérance à la panne, comme d’ailleurs
un cluster avec deux managers.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Nous ne rentrerons pas dans la complexité de
la répartition sur des zones de disponibilités,
ce qui complique encore plus l’approche. Plus de détails
sur <a class="url" href="https://docs.docker.com/engine/swarm/admin_guide/#add-manager-nodes-for-fault-tolerance" target="_blank">https://docs.docker.com/engine/swarm/admin_guide/#add-manager-nodes-for-fault-tolerance</a></p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle6">
          <h3 class="title">f. Promotion d’un nœud</h3>
          <p class="defaut">Pour l’instant, les commandes montrées
permettaient d’enregistrer un nœud dans un cluster sous
forme d’agent ou de manager, mais il est également possible
de faire varier ce statut en cours d’exécution du cluster
et de "promouvoir" par exemple un nœud agent en nœud
manager. La commande est la suivante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs scss">docker node promote <span class="hljs-selector-attr">[identifiant du nœud]</span></code></pre>
          <p class="defaut">L’identifiant du node à utiliser
est celui fourni par la commande <span class="courier11">docker node
ls</span>.</p>
          <p class="defaut">L’opération inverse de "déclassement"
d’un manager en un simple "worker" est opérée
par la commande ci-dessous&nbsp;:</p>
          <pre class="programlisting"><code class="hljs scss">docker node demote <span class="hljs-selector-attr">[identifiant du nœud]</span></code></pre>
          <p class="defaut">Si nous poursuivons l’exemple de la section
précédente, nous pourrions par exemple déclasser
le node correspondant à la machine <span class="courier11">ManagerBis</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">docker node demote yt7ud9ijf6gfjs90soa8bsj01</code></pre>
          <p class="defaut">Le résultat de la commande pour lister
les nœuds serait alors le suivant&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">yt7ud9ijf6gfjs90soa8bsj01</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ManagerBis</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">Le nœud aurait perdu son caractère
"Reachable" comme statut de manager, mais, par contre, il ferait
toujours partie du cluster Swarm et pourrait être utilisé comme
simple agent d’exécution de tâches.</p>
          <p class="defaut">Bien sûr, il est impossible de ne
plus avoir de manager dans un cluster Swarm, et une tentative pour
supprimer le dernier aboutira au message suivant&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">Error</span> response <span class="hljs-keyword">from</span> daemon: rpc <span class="hljs-keyword">error</span>: code = <span class="hljs-number">9</span> desc = attempting <span class="hljs-keyword">to</span> &nbsp;
demote the last manager <span class="hljs-keyword">of</span> the swarm</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Cette manipulation est l’occasion
de rappeler le principe de "cattle versus pet" en montrant le problème
du au couplage entre le nom de la machine et son statut dans le
cluster. Après l’opération de déclassement,
nous avons désormais une machine nommée <span class="courier11">ManagerBis</span>, mais qui n’est plus un
manager, ce qui peut prêter à confusion. Dans
une approche purement "cattle", toutes les machines auraient des
noms absolument quelconques et le problème ne se poserait
pas d’avoir un nom prêtant à confusion. Toutes
les machines sont égales et leur nom ne possède
aucun couplage avec leur rôle. Elles peuvent être
manager et même leader à un moment et se retrouver
simple agent par la suite.</p>
            </div>
          </div>
          <p class="defaut">Pour revenir à l’état précédent,
la commande à utiliser serait par exemple&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">docker node promote ManagerBis</code></pre>
          <p class="defaut">Ceci nous permet de montrer en particulier
qu’il est possible d’utiliser l’identifiant, mais également
le nom de machine hôte pour désigner le nœud à promouvoir
ou déclasser.&nbsp;</p>
        </div>
        <div class="sect3" id="refTitle7">
          <h3 class="title">g. Suppression d’un nœud</h3>
          <p class="defaut">Une machine (ou plutôt le démon
Docker qu’elle héberge) peut décider de sortir
du cluster auquel elle participe, en utilisant pour cela la commande <span class="courier11">docker swarm leave</span>. Nous allons utiliser
cette commande pour supprimer <span class="courier11">ManagerBis</span> de
notre cluster (sa présence n’était motivée
que par le besoin de démontrer le rattachement en mode
manager, mais les manipulations à suivre ne nécessitent
qu’un cluster simple avec un manager et deux workers).</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous sur la machine <span class="courier11">ManagerBis</span> à l’aide de <span class="courier11">PuTTY</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez la commande <span class="courier11">docker
swarm leave</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Notez l’erreur recopiée ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">Error</span> response <span class="hljs-keyword">from</span> daemon: You are attempting <span class="hljs-keyword">to</span> leave the swarm &nbsp;
<span class="hljs-keyword">on</span> a node that <span class="hljs-keyword">is</span> participating <span class="hljs-keyword">as</span> a manager. Removing this node &nbsp;
leaves <span class="hljs-number">1</span> managers out <span class="hljs-keyword">of</span> <span class="hljs-number">2.</span> Without a Raft quorum your swarm will &nbsp;
be inaccessible. The only way <span class="hljs-keyword">to</span> restore a swarm that has lost &nbsp;
consensus <span class="hljs-keyword">is</span> <span class="hljs-keyword">to</span> reinitialize it <span class="hljs-keyword">with</span> `--force-<span class="hljs-keyword">new</span>-cluster`. Use &nbsp;
`--force` <span class="hljs-keyword">to</span> suppress this message.</code></pre>
          <p class="defaut">Cet avertissement apparaît parce
que nous essayons de retirer un manager du cluster et indique que
ceci n’est pas sans risque sur le processus d’élection
d’un leader de remplacement. En effet, si le processus Raft ne permet
pas d’établir un quorum sur les managers&nbsp;restants,
le cluster deviendra inaccessible et il faudra le réinitialiser.
Dans&nbsp;notre cas, le manager restant est le leader et, vu qu’il
est seul, il saurait au besoin s’auto-élire, même
si sa présence seule n’assurerait plus aucune redondance.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Afin d’outrepasser l’erreur, relancez la commande
avec l’option de forçage&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">docker swarm leave <span class="hljs-comment">--force</span></code></pre>
          <p class="defaut">À noter qu’il est également
possible, comme indiqué plus haut, de tout gérer depuis
le manager élu du cluster. Ainsi, au lieu de se connecter
sur la machine du nœud à supprimer, et toujours
dans l’approche "cattle versus pet", la manipulation de suppression
du nœud du cluster pourrait être réalisée
depuis la machine <span class="courier11">Manager</span>. Pour
cela&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous à la machine <span class="courier11">Manager</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez la commande <span class="courier11">docker
swarm rm ManagerBis</span>.</p>
          </div>
          <p class="defaut">Encore une fois, une erreur est émise,
qui est recopiée ci-dessous&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">Error</span> response <span class="hljs-keyword">from</span> daemon: rpc <span class="hljs-keyword">error</span>: code = <span class="hljs-number">9</span> desc = node &nbsp;
muurm6z7bdpope2tu8e0si03d <span class="hljs-keyword">is</span> a cluster manager <span class="hljs-keyword">and</span> <span class="hljs-keyword">is</span> a member <span class="hljs-keyword">of</span> &nbsp;
the raft cluster. It must be demoted <span class="hljs-keyword">to</span> worker before removal</code></pre>
          <p class="defaut">Elle correspond au même risque que
décrit précédemment, mais comporte une autre
solution de forçage, à savoir de déclasser
le nœud avant de le supprimer du cluster, ce que nous allons
faire&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">docker node demote ManagerBis</code></pre>
          <p class="defaut">Un coup d’œil sur le résultat
de la commande <span class="courier11">docker node ls</span> montre
que le résultat&nbsp;est bien celui attendu&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">yt7ud9ijf6gfjs90soa8bsj01</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ManagerBis</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">Par contre, il est nécessaire de
passer une étape supplémentaire pour supprimer
le nœud du cluster, car une commande <span class="courier11">docker
node rm ManagerBis</span> entraînera l’affichage de l’erreur
ci-dessous&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><span class="hljs-keyword">Error</span> response <span class="hljs-keyword">from</span> daemon: rpc <span class="hljs-keyword">error</span>: code = <span class="hljs-number">9</span> desc = node &nbsp;
yt7ud9ijf6gfjs90soa8bsj01 <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> down <span class="hljs-keyword">and</span> can’t be removed</code></pre>
          <p class="defaut">Il faut que le nœud soit réellement
arrêté pour pouvoir être supprimé,
ce que nous pouvons provoquer en arrêtant la machine <span class="courier11">ManagerBis</span>. Une fois cette opération
réalisée,&nbsp;la commande <span class="courier11">docker node ls</span> peut être
relancée pour constater le changement&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">yt7ud9ijf6gfjs90soa8bsj01</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ManagerBis</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <b><span class="hljs-selector-tag">Down</span></b>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">Cette fois, le statut de la machine est <span class="courier11">Down</span> (à savoir arrêté,
comme vu dans la colonne <span class="courier11">STATUS</span>).</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez à nouveau la commande <span class="courier11">docker node rm ManagerBis</span>.</p>
          </div>
          <p class="defaut">La commande devrait se comporter comme attendu,
et le résultat de <span class="courier11">docker node
ls</span> afficher ceci (aux identifiants près, bien sûr)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">ID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">HOSTNAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">AVAILABILITY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">MANAGER</span> <span class="hljs-selector-tag">STATUS</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ENGINE</span> <span class="hljs-selector-tag">VERSION</span>&nbsp;
<span class="hljs-selector-tag">tgox69lz7q6lyp5ypyzr4lf9w</span> *&nbsp;&nbsp; <span class="hljs-selector-tag">ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">Leader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
<span class="hljs-selector-tag">s5omfktu2544rib7zz4eft1pl</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker1</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span>&nbsp;
32<span class="hljs-selector-tag">a0tb08egurgwbkcdzu749av</span>&nbsp;&nbsp;&nbsp;&nbsp; <span class="hljs-selector-tag">ClearLinux-worker2</span>&nbsp;&nbsp; <span class="hljs-selector-tag">Ready</span>&nbsp;&nbsp;
<span class="hljs-selector-tag">Active</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19<span class="hljs-selector-class">.03</span><span class="hljs-selector-class">.8</span></code></pre>
          <p class="defaut">D’une manière ou d’une autre, nous
sommes revenus à l’état original du cluster Swarm.
La machine <span class="courier11">ManagerBis</span> n’étant
désormais plus utile, nous pouvons également la
supprimer définitivement.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">En cas de bug (quelques problèmes
sont répertoriés dans des cas particuliers de
promotion&nbsp;d’un node en manager, et qui aboutissent à un
cluster bloqué), le plus simple sur un environnement de
test est de lancer la commande <span class="courier11">docker swarm
leave --force</span> sur toutes les machines, en commençant
par les agents et en finissant par les managers, et en particulier
le leader en toute fin. Ceci réinitialise complètement
le cluster Swarm. Les conteneurs lancés dans les tâches
ne seront pas arrêtés.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="sect2" id="refTitle8">
        <h2 class="title">2. Test du cluster avec un cas simple</h2>
        <p class="defaut">Les prochaines sections seront entièrement
consacrées à des déploiements de services
logiciels sur un cluster Swarm, mais un premier exemple simple d’utilisation
du cluster juste créé permettra de bien comprendre
ce qui a été mis en œuvre.</p>
        <p class="defaut">Tout d’abord, essayons d’utiliser la grammaire
traditionnelle de lancement d’un conteneur Docker depuis le manager&nbsp;:</p>
        <div class="manip">
          <p><span class="icon-manip">&nbsp;</span>Connectez-vous sur la machine <span class="courier11">Manager</span>.</p>
        </div>
        <div class="manip">
          <p><span class="icon-manip">&nbsp;</span>Lancez un conteneur sur l’image <span class="courier11">nginx</span> en le nommant <span class="courier11">web</span> pour plus de facilité de
gestion, en utilisant l’option d’arrière-plan pour que
le shell vous redonne la main et en exposant le port 80 pour accéder
au serveur web depuis la machine hôte&nbsp;:</p>
        </div>
        <pre class="programlisting"><code class="hljs sql">docker run -d <span class="hljs-comment">--name web -p 80:80 nginx</span></code></pre>
        <div class="manip">
          <p><span class="icon-manip">&nbsp;</span>Constatez le résultat en appelant
le serveur web&nbsp;:</p>
        </div>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP03.png" title="images/06EP03.png" src="IMAGES/06EP03.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Une commande <span class="courier11">docker
ps</span> permettra de confirmer que le conteneur web tourne bien
sur la machine courante, à savoir <span class="courier11">ClearDockerENI</span>&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP04.png" title="images/06EP04.png" src="IMAGES/06EP04.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Pourtant, un coup d’œil sur le contenu
de <span class="courier11">docker info</span> nous rappelle que nous
sommes bien en mode Swarm&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP05.png" title="images/06EP05.png" src="IMAGES/06EP05.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Or, quel que soit le nombre de conteneurs
lancés, ils seront tous présents sur cette machine&nbsp;manager.
Bref, la commande <span class="courier11">docker run</span> fonctionne
exactement comme avant la présence de Swarm, ce qui est évidemment
une bonne chose du point de vue de la compatibilité ascendante,
mais qui va nécessiter d’apprendre une nouvelle syntaxe
afin de bénéficier du cluster Swarm nouvellement
créé.</p>
        <p class="defaut">Cette syntaxe est basée autour de
la notion de service. Là où un démon
Docker local supportait des "conteneurs", ce sont des "services"
qui seront poussés sur un cluster de démons Docker.</p>
        <p class="defaut">La syntaxe de commande à utiliser
est la suivante&nbsp;:</p>
        <p><span class="bridgehead_niv4">Création d’un service Docker<var style="display:none"> Service</var></span></p>
        <pre class="literallayout"><code class="hljs scss">docker service create <span class="hljs-selector-attr">[options]</span> image</code></pre>
        <p class="defaut">Avant toute tentative d’utilisation, il est
recommandé d’arrêter le conteneur lancé plus
haut&nbsp;:</p>
        <div class="manip">
          <p><span class="icon-manip">&nbsp;</span>Entrez la commande <span class="courier11">docker
rm -fv web</span>.</p>
        </div>
        <div class="manip">
          <p><span class="icon-manip">&nbsp;</span>Vérifiez que le conteneur web est
bien supprimé grâce à la commande <span class="courier11">docker ps -a</span>.</p>
        </div>
        <p class="defaut">Nous pouvons maintenant créer un
service, et nous utiliserons le même nom de <span class="courier11">web</span>, ainsi que l’image <span class="courier11">nginx</span> déjà lancée
et le port de publication 80&nbsp;:</p>
        <pre class="programlisting"><code class="hljs sql">docker service <span class="hljs-keyword">create</span> <span class="hljs-comment">--name web -p 80:80 nginx</span></code></pre>
        <div class="note">
          <div class="remarkimg"><span class="icon-note"></span></div>
          <div class="divinline">
            <p class="remarque">L’option <span class="courier11">-d</span> n’a
plus de sens en mode service, car son absence faisait que le processus
lancé dans le conteneur prenait la main sur le shell en
cours. Or, ce conteneur peut maintenant être lancé sur
n’importe quelle machine du cluster, et donc sans aucun lien en
mémoire avec la ligne de commande à l’origine
de ce démarrage. Donc, l’option n’est plus disponible,
au même titre d’ailleurs que l’option <span class="courier11">-i</span>,
qui permettait de lancer le conteneur en mode interactif (la ligne
de commande alimentait alors le processus lancé).</p>
          </div>
        </div>
        <p class="defaut">Des messages apparaissent, expliquant les
tâches en cours, dont l’attente de la convergence du service,
c’est-à-dire l’assurance que le cluster est bien coordonné pour
exposer ce service de manière distribuée. La commande
renvoie également l’identifiant interne du service créé,
qu’on peut retrouver par ailleurs grâce à la commande
pour lister les services présents sur un cluster&nbsp;:</p>
        <p><span class="bridgehead_niv4">Lister les services</span></p>
        <pre class="literallayout"><code class="hljs">docker service ls</code></pre>
        <p class="defaut">L’exécution de cette commande donnerait
dans notre cas&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP06.png" title="images/06EP06.png" src="IMAGES/06EP06.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">L’appel du serveur web montre que le conteneur
fonctionne correctement&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP07.png" title="images/06EP07.png" src="IMAGES/06EP07.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Mais cette fois, ce résultat peut également être
visible depuis une autre machine, comme par exemple <span class="courier11">Agent1</span> (notez le nom de la machine
dans la barre de titre de la capture ci-dessous, montrant que la
connexion depuis PuTTY est bien réalisée sur un
autre serveur)&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP08.png" title="images/06EP08.png" src="IMAGES/06EP08.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Pourtant, la commande <span class="courier11">docker
ps</span> ne renvoie rien sur la machine Manager&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP09.png" title="images/06EP09.png" src="IMAGES/06EP09.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Dans le cadre de cet exemple, il se trouve
que le conteneur tourne en fait sur la machine&nbsp;<span class="courier11">Agent2</span>&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP10.png" title="images/06EP10.png" src="IMAGES/06EP10.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Si nous regardons la liste des images locales, <span class="courier11">nginx</span> a bien été rapatrié sur
le cache local&nbsp;de la machine désignée
comme le second agent worker de notre cluster&nbsp;:</p>
        <div class="image">
          <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP11.png" title="images/06EP11.png" src="IMAGES/06EP11.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
        </div>
        <p class="defaut">Deux opérations se sont déroulées,
qui permettent cette facilité de répartition des
conteneurs sur le cluster&nbsp;:</p>
        <p class="defaut">1. Lors de la création du service,
au lieu de lancer un conteneur en local, le manager a délégué à un
des agents la "tâche" (il s’agit du jargon Docker consacré, avec
sa forme anglaise task pour faire lien à la documentation)
de démarrer le conteneur sur son propre démon.</p>
        <p class="defaut">2. La fonctionnalité dite "routing
mesh" de Docker Swarm a ouvert le port de publication sur toutes
les machines du cluster et se charge de sa redirection sur le port
mis en lien dans le conteneur, et ce quelle que soit la localisation
effective du conteneur sur telle ou telle machine.</p>
        <p class="defaut">Bref, l’effet peut paraître extrêmement
simple mais, sous le capot, les opérations nécessaires&nbsp;pour
réaliser ceci sont nombreuses et sophistiquées.</p>
        <div class="note">
          <div class="remarkimg"><span class="icon-note"></span></div>
          <div class="divinline">
            <p class="remarque">Nous n’élaborerons pas plus
sur ces mécanismes dans le présent ouvrage, dédié avant
tout à Docker. Pour le lecteur souhaitant comprendre en
profondeur Swarm, mais aussi Docker Machines et Docker Compose,
nous nous permettons de renvoyer au livre sur ce sujet aux mêmes Éditions
ENI et du même auteur.</p>
          </div>
        </div>
        <p class="defaut">Pour arrêter le service, la commande
obéit à une syntaxe assez logique, à savoir&nbsp;:</p>
        <pre class="programlisting"><code class="hljs">docker service rm web</code></pre>
      </div>
      <div class="sect2" id="refTitle9">
        <h2 class="title">3. Déploiement manuel sur le cluster Swarm</h2>
        <p class="defaut">Avant de réaliser un déploiement
automatisé à l’aide d’un fichier descriptif de l’application
composée de services comme plus haut sur une machine locale, nous
allons commencer par déployer une application très
simple (composée de deux services seulement) de manière
manuelle. Le but de cette manipulation est pédagogique&nbsp;:
elle permettra d’approfondir la notion de service et de découvrir
les autres concepts du déploiement en mode cluster.</p>
        <div class="sect3" id="refTitle10">
          <h3 class="title">a. Application exemple</h3>
          <p class="defaut">L’application exemple qui va servir ci-dessous
peut être téléchargée sur <a class="url" href="https://github.com/EditionsENI/sample-app-1" target="_blank">https://github.com/EditionsENI/sample-app-1</a>.
Le plus simple pour cela est d’utiliser la ligne de commande suivante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//github.com/EditionsENI/sample-app-1</span></code></pre>
          <p class="defaut">Le répertoire <span class="courier11">sample-app-1</span> créé contient
tout le nécessaire pour réaliser l’exercice à suivre.
Comme expliqué plus haut, l’application <span class="courier11">sample-app-1</span> est composée
de deux services, le premier basé sur l’image <span class="courier11">mongo</span> en version 3.2 et le second
sur une image que nous allons générer à partir
du contenu du répertoire <span class="courier11">node-app</span>,
contenant le code source et le fichier <span class="courier11">Dockerfile</span> adéquat.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Une rapide étude montrera
que les versions utilisées pour les images de base sont
vieilles. La question s’est posée lors de la réécriture
de la présente édition de la faire évoluer
comme pour tous les autres exemples, mais il paraissait intéressant
de montrer justement (au moins dans un des exemples) que tant que les
images ne sont pas dépréciées&nbsp;et
rendues inaccessibles, le nommage précis des images de
base, incluant leur version, permet de s’assurer de la possibilité de
reconstruire une application à l’identique, malgré le
passage des ans.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle11">
          <h3 class="title">b. Préparation des images</h3>
          <p class="defaut">L’application a besoin d’images Docker pour
fonctionner. Une des deux est une image officielle et pourrait être
récupérée directement de Docker Hub. Pour
la seconde, il sera nécessaire de la compiler, ce que nous
ferons depuis la machine <span class="courier11">Manager</span>.
Ceci peut être utile pour faire des tests sur une machine avant
de passer au mode cluster.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez une connexion à la machine
Manager si ce n’est pas déjà le cas.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Commencez par récupérer l’image
officielle en ligne pour MongoDB&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">docker</span> <span class="hljs-selector-tag">pull</span> <span class="hljs-selector-tag">mongo</span><span class="hljs-selector-pseudo">:3.2</span></code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Placez-vous dans le sous-répertoire <span class="courier11">node-app</span> du répertoire <span class="courier11">sample-app-1</span> cloné à partir
de Github&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs">cd node-app</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la compilation de l’image correspondante,
en lui donnant comme nom (<span class="courier11">tag</span>, en
jargon Docker, ici dans un paramètre abrégé en <span class="courier11">-t</span>) <span class="courier11">node-app</span>.</p>
          </div>
          <pre class="programlisting"><code class="hljs">docker build -t node-app .</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">C’est une bonne pratique d’utiliser
une dénomination similaire pour les images et pour le répertoire
contenant les fichiers ayant permis de les générer.
Ainsi, il y a moins de risque de confusion entre les différents
contenus de l’application.</p>
            </div>
          </div>
          <p class="defaut">Une fois que ces deux commandes sont terminées,
l’exécution de la commande <span class="courier11">docker&nbsp;images</span> vous
permettra de vérifier que les deux images sont bel et bien
présentes, ce qui est un prérequis pour la suite
de l’exercice.</p>
        </div>
        <div class="sect3" id="refTitle12">
          <h3 class="title">c. Lancement des services</h3>
          <p class="defaut">Les images étant prêtes,
nous allons maintenant lancer les services qui leur sont associés.
Les services peuvent être vus comme un niveau d’abstraction au-dessus
des conteneurs. Ils ne sont pas en eux-mêmes des conteneurs
Docker, mais permettent de décrire comment ceux-ci vont
effectivement être lancés dans le cluster Swarm.</p>
          <p class="defaut">Ce niveau d’abstraction existait déjà en
partie dans les fichiers Docker Compose en version 1&nbsp;:
une déclaration dans ce fichier correspondait en général à un
seul conteneur effectivement démarré sur la machine,
mais rien n’empêchait, en utilisant la commande <span class="courier11">docker-compose scale</span>, de créer
plus qu’un seul conteneur pour un service donné. Toutefois,
dans cette première approche, il n’y avait pas d’indirection
par rapport à la machine qui allait supporter le conteneur&nbsp;:
tous étaient lancés sur la même machine
hôte. La version 2 des fichiers Docker Compose permet,
grâce à la notion&nbsp;de service, de définir le
contenu du service de manière indépendante de
la machine&nbsp;du cluster Swarm sur laquelle il va fonctionner,
pour la bonne et simple raison que ceci n’est pas déterminable
par avance. Mais nous reviendrons plus loin sur l’utilisation de
la grammaire Docker Compose&nbsp;; pour l’instant, le but est
de déployer manuellement les services composant l’application
et de faire en sorte que celle-ci soit opérationnelle.</p>
          <p class="defaut">La grammaire pour lancer un service reste
très proche dans ses paramètres de celle pour
démarrer un conteneur&nbsp;:</p>
          <p><span class="bridgehead_niv4">Création d’un service Docker</span></p>
          <pre class="literallayout"><code class="hljs scss">docker service create --name <span class="hljs-selector-attr">[nom]</span> <span class="hljs-selector-attr">[image]</span></code></pre>
          <p class="defaut">Le premier service à être
créé sera celui pour le moteur de base de données MongoDB&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Si ce n’est pas le cas, connectez-vous sur
la machine <span class="courier11">Manager</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">docker service <span class="hljs-keyword">create</span> <span class="hljs-comment">--name db mongo:3.2</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le nom <span class="courier11">db</span> est
particulièrement important à respecter par rapport
au reste de l’exemple, car c’est ce nom de service qui fera le lien
avec le nom de la machine à contacter dans le code Node.js
de la seconde partie de l’application qui sert à établir
la connexion à la base de données.</p>
            </div>
          </div>
          <p class="defaut">Au bout de quelques secondes maximum, la ligne
de commande renvoie un code, qui est l’identifiant du service juste
créé.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Il peut arriver que vous obteniez
un message du type <span class="courier11">Error response from daemon:
rpc error: code = 4 desc = context deadline exceeded</span>. Dans
la plupart des cas rencontrés par l’auteur, il s’agissait
d’un problème causé par le changement d’adresse
IP de la machine manager. Elle peut également se produire
si l’adresse IP de publication du cluster n’est plus accessible (vous
verrez alors l’état <span class="courier11">Swarm:pending</span> si
la commande <span class="courier11">docker info</span> est lancée
sur les nœuds de type worker). Il suffit alors de recréer&nbsp;le
cluster Swarm pour résoudre le problème. Dans
un cas particulier, cette manipulation&nbsp;n’a pas suffi et
il a été nécessaire de redémarrer
les machines. Cette erreur&nbsp;est toutefois arrivée
dans une version très ancienne de Docker, et n’est reproduite ici
que pour référence. Si vous êtes bloqué par
un problème similaire, les forums Docker sont une excellente
source d’information, après bien sûr le premier
réflexe à avoir, qui est de mettre à jour
Docker dans la version la plus récente.</p>
            </div>
          </div>
          <p class="defaut">Pour le second service, à savoir
l’application web portant l’API REST, nous procéderons
de la même manière, hormis l’ajout d’un paramètre
pour exposer le port 80 de l’image Docker sur le port 80 de notre
hôte.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande suivante&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">docker service <span class="hljs-keyword">create</span> <span class="hljs-comment">--name app --publish 80:80 node-app</span></code></pre>
          <p class="defaut">Cette fois, un message plus complet apparaît,
et qui porte une information importante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs delphi"><b>image node-app:latest could <span class="hljs-keyword">not</span> be accessed <span class="hljs-keyword">on</span> a registry <span class="hljs-keyword">to</span> <span class="hljs-keyword">record</span>&nbsp;
its digest. Each node will access node-app:latest independently,&nbsp;
possibly leading <span class="hljs-keyword">to</span> different nodes running different&nbsp;
versions <span class="hljs-keyword">of</span> the image.</b>&nbsp;
&nbsp;
<span class="hljs-number">2</span>ya0ycn2gz8ixihw9zmds094z&nbsp;
overall progress: <span class="hljs-number">1</span> <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> tasks&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>: running&nbsp;&nbsp;
[==================================================&gt;]&nbsp;
verify: Service converged</code></pre>
          <p class="defaut">Dans les précédentes versions
de Docker Swarm, le message faisait beaucoup plus penser à une
situation de blocage, mais il a été adouci (suite
certainement à la demande&nbsp;référencée
sur <a class="url" href="https://github.com/docker/docker/issues/29205" target="_blank">https://github.com/docker/docker/issues/29205</a>)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs vbnet"><b>unable</b> <span class="hljs-keyword">to</span> pin image node-app <span class="hljs-keyword">to</span> digest: errors:&nbsp;
<b>denied</b>: requested access <span class="hljs-keyword">to</span> the resource <span class="hljs-keyword">is</span> denied&nbsp;
<b>unauthorized</b>: authentication required&nbsp;
&nbsp;
phaisd25sjwv06uadh7ag87za</code></pre>
          <p class="defaut">Comme on peut le voir, un identifiant est
tout de même renvoyé en fin de commande, ce qui
veut dire que le service a bien été démarré.
En fait, le message remonte bien un problème, mais il ne
s’agit que d’un avertissement qui est consécutif au fait
que nous soyons en mode Swarm et que le service est déclaré avec
un attribut <span class="courier11">build</span>, c’est-à-dire
que son image est compilée par rapport à la définition
fournie par le <span class="courier11">Dockerfile</span>.</p>
          <p class="defaut">Or, il se trouve que ces deux approches ne
sont pas naturellement compatibles. Lorsque l’image est fournie
par un registre comme Docker Hub (ce qui est le cas pour l’image
"officielle" <span class="courier11">mongo:3.2</span>), n’importe
quelle machine du cluster peut récupérer celle-ci
pour la démarrer dans un conteneur local, avec un fort
degré de garantie qu’il s’agisse à l’octet près
de la même image. Le comportement est donc prévisible,
quel que soit le node sur lequel le conteneur sera démarré.</p>
          <p class="defaut">Ce n’est pas le cas d’une image construite à partir
du code source, car celui-ci est présent sur une machine
donnée et, lors de la compilation, l’image est stockée
dans le cache local de cette machine. Chacun des nodes pourra ainsi
avoir dans son cache local une image avec la même étiquette,
mais potentiellement un contenu différent, car Docker n’a
pas eu accès au "digest", c’est-à-dire la signature
numérique garantissant qu’une image est exactement la même
qu’une autre.</p>
          <p class="defaut">Toutefois, Docker réussit tout de
même à lancer un conteneur Docker, mais avec la
restriction signalée qu’il ne peut pas garantir la similarité de
l’image d’un node du cluster à l’autre. Dans notre cas,
ceci nous permet d’avancer, mais dans un cluster Swarm en production,
l’approche sera bien sûr de positionner toutes les images
sur un registre (que ce soit Docker Hub ou un registre privé)
accessible à toutes les machines du cluster.</p>
          <p class="defaut">Un rapide coup d’œil aux conteneurs
lancés sur les différentes machines confirme cette
hypothèse. Par exemple, voici le contenu de la machine <span class="courier11">Agent1</span> dans le contexte de l’exécution
sur la machine de l’auteur&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP12.png" title="images/06EP12.png" src="IMAGES/06EP12.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Le conteneur correspondant au service <span class="courier11">db</span> basé sur l’image <span class="courier11">mongo:3.2</span> y est identifiable, mais
il aurait pu se trouver sur n’importe laquelle des trois machines.
Le second service se trouve sur <span class="courier11">Manager</span>.
Comme nous l’avons expliqué, il ne peut en être
autrement&nbsp;pour l’instant, puisque l’image a été compilée sur
cette machine et qu’elle n’est donc disponible que dans le cache
local de celle-ci&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP13.png" title="images/06EP13.png" src="IMAGES/06EP13.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Le message d’avertissement concernait justement
ce point&nbsp;: il fallait prévenir l’utilisateur que
le service n’allait pas pouvoir être réellement
lancé sur le cluster. Afin de ne pas bloquer purement et
simplement le déploiement, Docker le lance quand même,
mais avec une restriction de localisation. Or, ceci va à l’encontre
du principe de répartition libre qu’on attend d’un mécanisme
de clustering, et Docker le signale donc avec un message approprié.</p>
          <p class="defaut">Les deux services étant lancés,
nous allons pouvoir tester notre application. Avant cela,&nbsp;il
est possible de vérifier que les services sont bien présents
avec la commande Docker adéquate.</p>
          <p><span class="bridgehead_niv4">Lister les services Docker</span></p>
          <pre class="literallayout"><code class="hljs">docker service ls</code></pre>
          <p class="defaut">La commande renvoie par exemple dans notre
cas&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP14.png" title="images/06EP14.png" src="IMAGES/06EP14.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Une autre commande permet d’inspecter toutes
les propriétés d’un service, pour rentrer dans
(beaucoup) plus de détails&nbsp;:</p>
          <p><span class="bridgehead_niv4">Inspecter un service</span></p>
          <pre class="literallayout"><code class="hljs scss">docker service inspect <span class="hljs-selector-attr">[identifiant du service]</span></code></pre>
          <p class="defaut">Dans notre cas, la commande appliquée
sur le service <span class="courier11">app</span> que nous venons
de créer donnerait une sortie comme ceci (extrait)&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">[&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ID"</span>: <span class="hljs-string">"2ya0ycn2gz8ixihw9zmds094z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Version"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Index"</span>: <span class="hljs-number">42</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"CreatedAt"</span>: <span class="hljs-string">"2020-10-10T12:43:57.213502387Z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"UpdatedAt"</span>: <span class="hljs-string">"2020-10-10T12:43:57.218003205Z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Spec"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"app"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Labels"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"TaskTemplate"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ContainerSpec"</span>: {<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Image"</span>: <span class="hljs-string">"node-app:latest"</span>,</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Init"</span>: <span class="hljs-literal">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"StopGracePeriod"</span>: <span class="hljs-number">10000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"DNSConfig"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Isolation"</span>: <span class="hljs-string">"default"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Resources"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Limits"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Reservations"</span>: {}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"RestartPolicy"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Condition"</span>: <span class="hljs-string">"any"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Delay"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxAttempts"</span>: <span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Placement"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ForceUpdate"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Runtime"</span>: <span class="hljs-string">"container"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Mode"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Replicated"</span>: {<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Replicas"</span>: <span class="hljs-number">1</span></b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"UpdateConfig"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Parallelism"</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"FailureAction"</span>: <span class="hljs-string">"pause"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Monitor"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxFailureRatio"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Order"</span>: <span class="hljs-string">"stop-first"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"RollbackConfig"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Parallelism"</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"FailureAction"</span>: <span class="hljs-string">"pause"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Monitor"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxFailureRatio"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Order"</span>: <span class="hljs-string">"stop-first"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
]</code></pre>
          <p class="defaut">Cette sortie fait apparaître quelques
informations intéressantes, comme le nombre de replicas
(instances similaires du service, soit le nombre de conteneurs démarrés
dans le cluster à partir de la même image), les
paramètres pour la mise à jour des services, le
port de publication du service ainsi que les informations liées
au réseau. Nous allons étudier en détail
tous ces points dans la suite du présent chapitre, mais
dans un premier temps, il est nécessaire de valider que
le lancement a produit une application fonctionnant correctement.</p>
        </div>
        <div class="sect3" id="refTitle13">
          <h3 class="title">d. Premier test</h3>
          <p class="defaut">Le plus simple pour tester l’application est
de commencer par un appel sur l’API <span class="courier11">DELETE</span>,&nbsp;qui
remet à 1 le compteur en supprimant et en recréant
la collection dans la base de données.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Depuis la machine <span class="courier11">Manager</span>,
entrez la commande suivante&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">curl -X <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">http</span>://localhost/</code></pre>
          <p class="defaut">La commande est anormalement lente et ne répond
rien.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Arrêtez la commande en entrant la
combinaison <span class="courier11">CTRL+C</span>.</p>
          </div>
          <p class="defaut">Visiblement, quelque chose pose problème.
Pour diagnostiquer en première approche, le plus simple
est d’utiliser la commande suivante pour observer le comportement
de l’application dans le conteneur&nbsp;:</p>
          <pre class="programlisting"><code class="hljs typescript">azureuser<span class="hljs-meta">@ClearDockerENI</span>~<span class="hljs-regexp">/sample-app-1/</span>node-app $ docker service &nbsp;
logs app&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| App listening on port <span class="hljs-number">80</span>&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET /muieblackcat <span class="hljs-number">404</span> &nbsp;
<span class="hljs-number">6.518</span> ms - <span class="hljs-number">25</span>&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//phpMyAdmin/scripts/setup.php 404 2.315 ms - 42&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//phpmyadmin/scripts/setup.php 404 0.588 ms - 42&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//pma/scripts/setup.php 404 0.354 ms - 35&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//myadmin/scripts/setup.php 404 0.286 ms - 39&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//MyAdmin/scripts/setup.php 404 0.249 ms - 39&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//Admin/scripts/setup.php 404 0.710 ms - 37&nbsp;</span>
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| GET &nbsp;
<span class="hljs-comment">//mysql/scripts/setup.php/db/scripts/setup.php/typo3/phpmyadmin/&nbsp;</span>
scripts/&nbsp;
setup.php/web/phpMyAdmin/scripts/setup.php/web/scripts/setup.php/&nbsp;
phpmyadmin2/scripts/setup.php/admin/scripts/setup.&nbsp;
php/admin/phpmyadmin/scripts/setup.php/phpmyadmin1/scripts/setup.php/&nbsp;
xampp/phpmyadmin/scripts/setup.php/php-my-admi&nbsp;
n/scripts/setup.php <span class="hljs-number">404</span> <span class="hljs-number">0.241</span> ms - <span class="hljs-number">333</span>&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;|<b>Failed connection to &nbsp;
MongoDB { [MongoError: failed to connect to server [db:&nbsp;<span class="hljs-number">27017</span>]</b> 
on first connect [MongoError: getaddrinfo ENOTFOUND db]]&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; name: ’MongoError’,&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp; message: ’failed to &nbsp;
connect to server [db:<span class="hljs-number">27017</span>] on first connect [MongoEr&nbsp;
ror: getaddrinfo ENOTFOUND db]’ }&nbsp;
app<span class="hljs-number">.1</span>.rst1ai3l8w7t<span class="hljs-meta">@ClearDockerENI</span>&nbsp;&nbsp;&nbsp;&nbsp;| DELETE / - - ms - -</code></pre>
          <p class="defaut">Les traces montrent que l’application Node.js
est bien à l’écoute sur le port 80 (qui a été redirigé vers
le port 80 de l’hôte Docker dans notre exemple) mais que
la tentative d’accès à la base de données
s’est soldée par un échec&nbsp;: la connexion à <span class="courier11">db:27017</span> ne fonctionne pas.</p>
          <p class="defaut">Dans une approche de gestion directe des conteneurs,
en utilisant Docker Compose plutôt que la nouvelle gestion
des services proposée par Docker, il serait possible de
simplement exposer le port 27017 sur la machine hôte, puis de
paramétrer l’accès à la base de données
en pointant sur ce même hôte. Une solution plus
propre serait de créer un lien entre le conteneur de l’application et
celui de la base de données, ce qui revient en gros au
même, sauf que le port 27017 n’est pas exposé à tout
le monde et que Docker se charge de gérer l’exposition
d’un conteneur à un autre, pour une meilleure isolation.
Mais la nouvelle approche basée sur les services propose
une solution bien plus puissante, à savoir l’utilisation
d’un réseau dédié à l’application.</p>
        </div>
        <div class="sect3" id="refTitle14">
          <h3 class="title">e. Mise en place d’un réseau overlay dédié<var style="display:none"> Réseau overlay</var></h3>
          <p class="defaut">Lorsqu’on utilise les services, les liens
entre conteneurs n’ont plus cours, et la solution recommandée
est d’utiliser un réseau dédié dans lesquels
les conteneurs pourront se parler librement, tout en étant
protégés des accès de toute autre machine
ou tout autre conteneur étrangers à ce réseau.</p>
          <p class="defaut">C’est cette solution que nous allons montrer
ici, mais il est nécessaire de faire un peu de ménage
auparavant&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous sur la machine <span class="courier11">Manager</span> si ce n’est pas déjà le
cas.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Supprimez les services avec la commande ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs">docker services rm db app</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Vérifiez que plus aucun conteneur
n’est présent (même à l’état
arrêté, car la gestion des services s’occupe également
de les supprimer) en utilisant la commande ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs">docker ps -a</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">La suppression du service peut prendre
un peu de temps à se réaliser pleinement, c’est-à-dire à aboutir à la
suppression des conteneurs associés. Si vous voyez encore
un conteneur juste après avoir lancé la commande
de suppression du service, il s’agit d’un comportement tout à fait
normal, comme une deuxième exécution de la commande
quelques secondes plus tard le confirmera normalement.</p>
            </div>
          </div>
          <p class="defaut">Le réseau que nous allons créer
pour accueillir les services est un réseau dit "overlay",
c’est-à-dire qu’il se positionne en surcouche d’un autre
réseau. Il ne s’agit bien sûr pas d’un réseau
basé sur des adaptateurs physiques, mais d’un réseau
réalisé par du logiciel, donc d’une certaine manière
"virtuel", en s’appuyant toutefois sur le "vrai" réseau
pour rendre possibles les échanges effectifs entre machines.
En l’occurrence, ce réseau vient se placer au-dessus du réseau
qui relie les trois machines que nous avons créées.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez la commande ci-dessous afin de créer
un réseau que nous appellerons justement <span class="courier11">reseau</span> (en français mais
sans accent)&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">docker network <span class="hljs-keyword">create</span> <span class="hljs-comment">--driver overlay reseau</span></code></pre>
          <p class="defaut">La commande renvoie un identifiant que nous
retrouverons si nous entrons une commande <span class="courier11">docker
network ls</span>, qui va lister les réseaux disponibles et
leurs caractéristiques&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP15.png" title="images/06EP15.png" src="IMAGES/06EP15.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Comme nous pouvons le voir, Docker avait déjà créé plusieurs
réseaux de différents types, à savoir <span class="courier11">overlay</span>, <span class="courier11">bridge</span> (il
s’agit du mode par défaut) et <span class="courier11">host</span>.
En fin de liste, nous retrouvons le réseau que nous venons
juste de créer. Nous allons maintenant reproduire les étapes
de création de services décrites plus haut, mais
cette fois-ci en associant ces services à ce nouveau réseau
qui leur est dédié&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Entrez les commandes ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">docker service <span class="hljs-keyword">create</span> <span class="hljs-comment">--name db --network reseau mongo:3.2&nbsp;</span>
docker service <span class="hljs-keyword">create</span> <span class="hljs-comment">--name app --network reseau --publish 80:80 node-app</span></code></pre>
          <p class="defaut">Sur l’exécution de la seconde commande,
nous obtenons le message d’avertissement comme lors de la précédente
manipulation, ce qui est normal puisque nous n’avons pas encore
fait le nécessaire pour résoudre le problème
(cela viendra par la suite).</p>
        </div>
        <div class="sect3" id="refTitle15">
          <h3 class="title">f. Validation du fonctionnement</h3>
          <p class="defaut">Pour valider le fonctionnement de l’ensemble,
nous allons répéter le test préalablement
exécuté sans succès, à savoir
accéder au service sur la méthode <span class="courier11">DELETE</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">curl -X <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">http</span>://localhost/</code></pre>
          <p class="defaut">Cette fois-ci, normalement, le service doit
rendre la main immédiatement. L’API en mode <span class="courier11">DELETE</span> ne renvoie toutefois aucune
valeur, donc il est difficile de se rendre compte du succès,
mais nous pouvons comme précédemment retrouver
les logs de l’application pour vérifier que l’appel a bien été réalisé&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP16.png" title="images/06EP16.png" src="IMAGES/06EP16.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">On voit clairement que l’appel tenté a
bien été pris en compte, et a même été réalisé avec
un code HTTP de retour 200 (OK).</p>
          <p class="defaut">Pour se rassurer un peu plus sur le fonctionnement
effectif de ces deux tentatives, nous pouvons également
nous connecter sur les autres machines du cluster et chercher le
conteneur correspondant au moteur de base de données MongoDB,
afin d’y reproduire&nbsp;la même manipulation de lecture
des traces. Dans notre cas, ce conteneur tournait sur l’hôte <span class="courier11">Agent1</span>, mais Swarm peut le démarrer
sur n’importe quelle instance. Et ceci ne pose pas problème
car l’ensemble peut fonctionner n’importe où, maintenant
que le service peut se baser sur un réseau.</p>
          <p class="defaut">Les résultats confirment que le service
a bien eu accès à la base de données
et a supprimé la collection comme attendu (commande <span class="courier11">drop</span> visible dans l’avant-dernière
ligne des traces ci-dessous, juste en dessous de la ligne signalant
une connexion depuis une application Node.js)&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP17.png" title="images/06EP17.png" src="IMAGES/06EP17.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Pour faire bonne mesure, nous pouvons nous
connecter sur la machine du cluster où ne tourne aucun
conteneur des deux services, et appeler les fonctionnalités
de l’API permettant d’incrémenter un compteur (ce que nous
ferons trois fois) puis le lire, grâce à un appel
en mode <span class="courier11">GET</span>, qui est le verbe par défaut
pour la commande <span class="courier11">curl</span>. Le compteur étant
initialisé à 1 par l’appel de la méthode <span class="courier11">DELETE</span>, les trois incréments
l’amènent à une valeur de 4. Le résultat
constaté est tel qu’attendu (même si l’absence
de saut de ligne automatique le rend difficile à lire,
le nombre est bien présent sur la toute dernière ligne
des traces qui suivent, juste devant l’invite <span class="courier11">azureuser@ClearLinux-worker2</span>)&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP18.png" title="images/06EP18.png" src="IMAGES/06EP18.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Bien sûr, cette façon
de faire en se connectant sur les différentes machines n’est
pas celle recommandée, car elle contrevient au principe
"cattle versus pet" où les nœuds de type worker
doivent être complètement quelconques pour le
gestionnaire du cluster. Nous avons vu avec la commande <span class="courier11">docker service logs</span> une façon
plus élégante de procéder, mais il est
important de montrer que derrière un service se trouve
tout de même un conteneur et que Docker n’a pas tant changé qu’on
pourrait le croire. La gestion des services reste bien une surcouche
de gestion, une indirection permettant plus de confort, mais autorisant
toutefois à travailler comme auparavant lorsque c’est plus
pratique.</p>
            </div>
          </div>
          <p class="defaut">L’exemple étant fonctionnel, nous
allons maintenant montrer comme rendre son déploiement&nbsp;plus
propre. Mais auparavant, revenons rapidement sur la dernière
remarque&nbsp;en précisant qu’un service est une surcouche
non pas sur un conteneur, mais potentiellement sur plusieurs instances
de conteneurs tous liés à la même image.</p>
        </div>
        <div class="sect3" id="refTitle16">
          <h3 class="title">g. Passage à l’échelle</h3>
          <p class="defaut">Le but d’un service est en effet de fournir
une surcouche de robustesse, de facilité de gestion et
de scalabilité au-dessus d’une image Docker. Ainsi, un
service va pouvoir par exemple lancer à un moment donné deux
instances d’une image Docker dans des versions différentes
pour gérer une montée en version en douceur. Mais
le service peut également s’occuper du passage à l’échelle
des conteneurs sous-jacents en autorisant de manière simple
la multiplication des conteneurs.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Exécutez la commande ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs">docker service scale app=3</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sur la machine <span class="courier11">Manager</span>,
lancez la commande suivante&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs">docker ps</code></pre>
          <p class="defaut">Pour la même raison que précédemment
(qui nous arrange bien, en l’occurrence, pour nos exercices), les
conteneurs doivent s’exécuter sur l’hôte <span class="courier11">Manager</span> car c’est le seul à disposer
de l’image Docker <span class="courier11">node-app</span> compilée à partir du
code source. Les conteneurs sont visibles sur cette machine&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP19.png" title="images/06EP19.png" src="IMAGES/06EP19.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Attention toutefois à ne pas prendre
au pied de la lettre cette augmentation du nombre de conteneurs.
En pratique, la gestion de service de Docker ne fera pas apparaître
immédiatement les conteneurs, mais en fonction de ses propres heuristiques.
Il se peut donc que les conteneurs apparaissent au bout de quelques
secondes voire minutes.&nbsp;</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">En règle générale,
la réduction d’échelle se manifeste de manière
plus rapide. Bien sûr parce qu’il est plus facile d’arrêter
un conteneur que de le démarrer, mais aussi peut-être
parce que la demande n’est pas la même&nbsp;: dans
une augmentation d’échelle, il est demandé à Docker
de se tenir prêt à des flux supplémentaires,
tandis que dans une réduction d’échelle, le but
est de récupérer des ressources, ce qui est en
général une demande plus urgente. Il n’est pas
impossible que la gestion des services de Docker prenne en compte à sa manière
ce genre de critères.</p>
            </div>
          </div>
          <p class="defaut">Après quelques changements d’échelle,
il est intéressant de constater que, même si à aucun
moment le nombre de conteneurs n’a été inférieur à 1,
certains des conteneurs initiaux ont été recyclés.
Après quelques montées et baisses d’échelle,
nous pouvons constater qu’un des conteneurs a changé d’identifiant&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP20.png" title="images/06EP20.png" src="IMAGES/06EP20.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Encore une fois, ceci illustre bien le principe
"cattle versus pet" (même si en l’occurrence il s’applique
sur les conteneurs, alors que nous l’avons jusqu’à maintenant
expliqué en rapport avec les serveurs)&nbsp;: la première
instance de service lancée n’est en aucun cas plus importante
que les autres, et Docker n’a pas hésité à la
supprimer à un moment&nbsp;donné pour laisser
d’autres instances fonctionner à sa place. C’est le propre
des conteneurs de pouvoir être recyclés et relancés
pour assurer une excellente robustesse de l’ensemble ainsi qu’un passage à l’échelle
rapide.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Bien sûr, ce genre d’approche
nécessite que les applications hébergées
dans les conteneurs soient parfaitement stateless, c’est-à-dire
qu’elles ne contiennent pas un état. Dans notre cas, l’application
Node.js ne stocke rien en session et délègue la
persistance au conteneur MongoDB, donc ça ne pose aucun
problème. Moyennant quelques conditions de collaboration,
il serait même possible de passer à l’échelle
l’image <span class="courier11">mongo</span>, vu que le point central
de persistance des données est lui-même délégué à un
stockage sur disque dur par l’intermédiaire des volumes.
La pratique n’est pas aussi simple que la théorie toutefois,
mais ce n’est pas le sujet du présent livre que d’expliquer&nbsp;le
fonctionnement de MongoDB en cluster ou d’entrer dans les problématiques
de replicas, sharding et gestion des verrous sur les fichiers de données.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle17">
          <h3 class="title">h. Suppression des ressources déployées</h3>
          <p class="defaut">Nous marquons la fin de cette première
approche manuelle de déploiement de service par leur suppression,
sans oublier celle du réseau associé&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">docker service rm db app&nbsp;
docker network rm reseau</code></pre>
        </div>
      </div>
      <div class="sect2" id="refTitle18">
        <h2 class="title">4. Déploiement de l’application microservices</h2>
        <div class="sect3" id="refTitle19">
          <h3 class="title">a. Récupérer l’application exemple</h3>
          <p class="defaut">Le but de cette section est de montrer un
déploiement un peu plus réaliste sur Swarm, en
ne lançant plus les deux services d’une application simpliste à la main,
mais en utilisant la grammaire Docker Compose, que nous avions vue plus
haut, pour déployer une application un peu plus complexe,
avec une dizaine de services. L’exemple utilisé sera le
même que dans le chapitre précédent, à savoir
l’application Middle Office.</p>
          <p class="defaut">Le code complet de cette application peut être
récupéré localement en clonant le dépôt
Git grâce à la commande suivante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//eni-kubernetes@dev.azure.com/eni-kubernetes/&nbsp;</span>
middleoffice-microservices-v2/_git/middleoffice-microservices-v2</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">La présence de Kubernetes
dans le nom du dépôt ne veut pas dire que cette application
ne peut se déployer que sur Kubernetes. Il s’agit tout
simplement du dépôt créé pour
accueillir l’application exemple du livre sur Kubernetes aux mêmes Éditions
ENI. Mais ce dépôt est constitué de plusieurs
projets, dont <span class="courier11">middleoffice-microservices-v2</span> qui
correspond à l’application elle-même, indépendamment
de tout moyen de déploiement,&nbsp;ainsi que d’autres projets
qui serviront pour le déploiement, sur un orchestrateur&nbsp;Kubernetes
ou, comme nous le verrons plus loin, sur un orchestrateur Swarm.</p>
            </div>
          </div>
          <p class="defaut">Une fois le projet récupéré,
il est conseillé de se placer sur l’étiquette
v0.3 pour être exactement synchronisé avec le
contenu des exercices ci-dessous&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">cd middleoffice-microservices-v2&nbsp;
git checkout</code></pre>
          <p class="defaut">Ce dossier permettra d’accéder au
code source des services de l’application, et donc de compiler les
images Docker nécessaires, ou bien de modifier les paramètres
de l’application si nécessaire dans le contexte du lecteur.</p>
        </div>
        <div class="sect3" id="refTitle20">
          <h3 class="title">b. Le retour de Docker Compose</h3>
          <p class="defaut">Le dossier ne contient toutefois pas de fichier <span class="courier11">docker-compose.yml</span> car, comme expliqué,
ce sont d’autres projets du même dépôt
sur Azure DevOps qui contiennent les outils de déploiement
en fonction de l’orchestrateur ciblé. Dans notre cas, il
est nécessaire&nbsp;de se placer sur le projet pour
Swarm&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">git <span class="hljs-keyword">clone</span> https:<span class="hljs-comment">//eni-kubernetes@dev.azure.com/eni-kubernetes/&nbsp;</span>
middleoffice-swarm-deployment/_git/middleoffice-swarm-deployment&nbsp;
cd middleoffice-swarm-deployment&nbsp;
git checkout v0<span class="hljs-number">.3</span></code></pre>
          <p class="defaut">Ce projet ne contient pas réellement
que les fichiers de déploiement pour Swarm, mais aussi
ceux pour le déploiement local sur un démon Docker unique.
C’est d’ailleurs à partir de ce fichier que nous allons
démarrer l’exercice, pour bien montrer point par point
les différences à mettre en œuvre, et en
profiter pour dérouler les concepts liés au déploiement
en mode Swarm.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Recopiez le fichier <span class="courier11">docker-compose.yml</span> dans
le répertoire <span class="courier11">middleoffice-microservices-v2</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Placez l’invite de commandes dans ce dernier
répertoire.</p>
          </div>
          <p class="defaut">Le fichier recopié correspond à un
déploiement par Docker Compose en mode local, et de plus
sans utiliser Traefik. Il y a toutefois une différence
majeure entre l’utilisation de Docker Compose sur des conteneurs
locaux et son utilisation sur des services à déployer
dans Swarm. Bien sûr, Docker Compose nous permettait aussi
de passer à l’échelle des conteneurs, de déterminer
quels étaient les ports exposés, etc. Mais il
n’en reste pas moins que lancer un conteneur et démarrer
un service qui s’occupe de lancer des tâches basées
sur des conteneurs sont des fonctionnalités éminemment
différentes, tout d’abord parce que la première
se fait sur le client et l’autre sur le démon.</p>
          <p class="defaut">Le fichier <span class="courier11">docker-compose.yml</span> que
nous avons récupéré va donc devoir être
sérieusement&nbsp;mis à jour pour permettre
de gérer un ensemble de services, ce qui dans le jargon
Docker s’appelle une stack ("pile" en français).</p>
          <p class="defaut">De plus, et ceci explique que nous avons parlé d’utiliser
la grammaire Docker Compose et non pas Docker Compose lui-même,
c’est la ligne de commande de Docker qui sera utilisée
pour démarrer cette stack. Docker Compose, en effet, se
cantonnait au côté client et finalement ne faisait
qu’automatiser des commandes de Docker. Dans une approche plus complexe
comme un cluster Swarm, il n’est pas possible de gérer
toutes les fonctionnalités du côté client, car
le serveur dans son ensemble doit s’auto-organiser en fonction de
paramètres qui lui sont passés par le client.
Il y a donc une réelle évolution d’architecture,
et même si le contenu du fichier est en partie le même,
nous allons voir qu’il doit évoluer sérieusement
pour être adapté à notre nouveau cas d’usage
et, surtout, que ce ne sera pas une application Docker Compose qui utilisera
ce fichier, mais l’application Docker elle-même.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">La conséquence de ceci est
que, pour des installations en production sur un cluster, il est
inutile d’installer l’exécutable Docker Compose, même
si nous utilisons des fichiers utilisant la grammaire initialement
définie par ce logiciel (qui au passage s’appelait Fig
au tout début de l’histoire de Docker et était
une contribution externe à la plateforme).</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle21">
          <h3 class="title">c. Détail du vocabulaire</h3>
          <p class="defaut">La section précédente a
introduit une énième expression liée à l’architecture
de Docker,&nbsp;et il est temps de prendre un peu de recul pour
reposer clairement les relations entre les piles (stacks), les tâches
(tasks), les services (services), les démons (daemons),
les clusters (swarms), les conteneurs (containers), le registre (registry)
et les images (images).</p>
          <p class="defaut">Reprenons toutes ces notions à partir
d’un schéma décrivant un mécanisme de déploiement&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP21.png" title="images/06EP21.png" src="IMAGES/06EP21.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Pour simplifier le lien avec les commandes
Docker, nous utiliserons majoritairement le vocable anglais pour
décrire toutes les relations du schéma précédent&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">Une stack S regroupe
un ensemble de services A, B et C.</p>
              </li>
              <li class="liste1">
                <p class="liste1">C’est cette stack S qui va être
déployée sur un Swarm W.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Le Swarm W est un ensemble de démons
D1, D2 et D3 qui fonctionnent ensemble par l’intermédiaire
d’une première couche de réseau overlay (non représentée
dans le schéma, pour des raisons de clarté).</p>
              </li>
              <li class="liste1">
                <p class="liste1">Chaque service est lié à une
image, et ces images A, B et C peuvent se trouver dans un registre
R. Les restrictions et avertissements consécutifs ont été exposés
plus haut dans le cas d’une image buildée lors de la création
du service. Nous verrons un peu plus loin que le registre devient
carrément obligatoire dans le cas du déploiement
d’une stack.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Les services définissent également
une échelle de déploiement, par exemple trois
instances pour le service B. Par défaut, les autres services
n’auront qu’une seule instance.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Ces instances s’appellent des tâches,
et c’est l’orchestrateur Docker Swarm qui se charge de déployer
autant de tâches sur le cluster que les différents services
de la stack S le demandent.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Les tasks A1, B1, B2, B3 et C1 sont
réparties sur les différents nœuds du
cluster par l’orchestrateur, qui va décider de l’hôte
(D1, D2 ou D3) sur lequel elles sont créées, de
la façon dont elles sont réparties, et même
de les redémarrer en cas de nécessité.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Une tâche s’exécute
en lançant un conteneur Docker, basé bien sûr
sur l’image correspondant au service associé, qu’elle va
chercher dans le registre et stocke dans le cache local.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Toutes ces tâches s’exécutent
au sein d’un second réseau overlay, noté N, qui
a été créé en surcouche du réseau
reliant les machines du Swarm entre elles, afin de séparer&nbsp;les
instances de services de cette stack de celles d’une autre stack.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Si une autre tâche s’exécute
sur un même démon Docker, comme dans le cas du
démon&nbsp;D2 dans notre diagramme, elle sera étanche
par rapport à la stack S.</p>
              </li>
              <li class="liste1">
                <p class="liste1">De la même manière,
un conteneur lancé en local sur le démon D1 (même si
cela n’arrive normalement plus) n’aura pas accès aux autres
conteneurs ou tâches tournant sur ce même démon,
a fortiori sur ceux lancés sur d’autres démons.</p>
              </li>
            </ul>
          </div>
          <p class="defaut">Ce diagramme devrait avoir éclairci
les points de vocabulaire, mais seul un exemple permettra de valider
le fonctionnement tel que décrit.</p>
        </div>
        <div class="sect3" id="refTitle22">
          <h3 class="title">d. Compilation éventuelle des images</h3>
          <p class="defaut">Les raisons pour lesquelles le fichier <span class="courier11">docker-compose.yml</span> se base sur les images
déjà compilées et disponibles sur le
compte Docker Hub d’identifiant <span class="courier11">middleoffice</span> ont été évoquées
plus haut, mais il est bien sûr possible - si le
lecteur le souhaite&nbsp;- de modifier ce fichier pour
pointer sur ses propres images.</p>
          <p class="defaut">L’approche la plus simple pour recompiler
toutes les images localement est de lancer ensuite la commande <span class="courier11">docker-compose build</span>. En effet, le
fichier descriptif de l’application&nbsp;contient des attributs <span class="courier11">images</span> pour pointer sur les images
précompilées (par défaut, celles disponibles
sur le compte Docker Hub <span class="courier11">middleoffice</span>,
pour des raisons de praticité), mais aussi des attributs <span class="courier11">build</span> qui pointent sur les répertoires
contenant les fichiers <span class="courier11">Dockerfile</span>. C’est
pour cette raison que la recopie du fichier <span class="courier11">docker-compose.yml</span> dans le
répertoire contenant les sources était conseillée
un peu plus haut.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention à bien respecter
des conventions de nommage strictes, par exemple en nommant systématiquement
de manière similaire les images et les dossiers de code
source, sous peine de rapidement arriver à des situations compliquées.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle23">
          <h3 class="title">e. Lancement par Docker Compose</h3>
          <p class="defaut">Avant de déployer une stack, nous
allons une dernière fois lancer Docker Compose directement&nbsp;sur
le fichier, juste pour montrer le message associé&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $ docker-&nbsp;
compose up -d<b>&nbsp;
WARNING: The Docker Engine you’re using is running in swarm mode.&nbsp;
&nbsp;
Compose does not <span class="hljs-keyword">use</span> swarm <span class="hljs-keyword">mode</span> <span class="hljs-keyword">to</span> deploy services <span class="hljs-keyword">to</span> multiple &nbsp;nodes 
<span class="hljs-keyword">in</span> a swarm. <span class="hljs-keyword">All</span> containers will be scheduled <span class="hljs-keyword">on</span> the <span class="hljs-keyword">current</span> node.&nbsp;
&nbsp;
<span class="hljs-keyword">To</span> deploy your application across the swarm, <span class="hljs-keyword">use</span> <span class="hljs-string">`docker stack 
deploy`</span>.</b>&nbsp;
&nbsp;
Creating network <span class="hljs-string">"middleoffice-microservices-v2_default"</span> <span class="hljs-keyword">with</span> the &nbsp;
<span class="hljs-keyword">default</span> driver&nbsp;
Creating mo-<span class="hljs-keyword">database</span> ... done&nbsp;
Creating mo-welcome&nbsp;&nbsp;... done&nbsp;
Creating mo-decisions&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... done&nbsp;
Creating mo-demande-remplir ... done&nbsp;
Creating mo-demande-creer&nbsp;&nbsp; ... done&nbsp;
Creating mo-decisions-bo&nbsp;&nbsp;&nbsp;&nbsp;... done&nbsp;
Creating mo-demandes-liste&nbsp;&nbsp;... done&nbsp;
Creating mo-demandes-bo&nbsp;&nbsp;&nbsp;&nbsp; ... done&nbsp;
Creating mo-parametrage&nbsp;&nbsp;&nbsp;&nbsp; ... done</code></pre>
          <p class="defaut">Docker Compose nous prévient que
Docker est en mode Swarm et que Compose n’est pas en mesure d’utiliser
ce mode de fonctionnement. En conséquence, il avertit que
tous les conteneurs seront déployés sur le démon
local, et nous fournit même la commande à lancer
pour réaliser plus intelligemment ce déploiement.
Ce message reste un simple avertissement et pas une erreur. D’ailleurs,
l’application est bien accessible, même si elle se trouve
dans un mode dégradé comme nous l’avions expliqué dans
le précédent chapitre, les différents
services étant exposés sur des ports variés
alors que l’application utilise des liens relatifs avec des noms
de service (c’est d’ailleurs ce qui nous avait amenés à basculer
sur Traefik).</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande <span class="courier11">docker-compose
down</span> pour supprimer le déploiement en mode Docker
Compose, de façon qu’il ne gêne pas pour la suite.</p>
          </div>
        </div>
        <div class="sect3" id="refTitle24">
          <h3 class="title">f. Déploiement d’une stack<var style="display:none"> Stack</var></h3>
          <p class="defaut">Pour la suite, nous allons justement suivre
les recommandations de Docker Compose et utiliser la commande <span class="courier11">docker stack deploy</span> recommandée.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Connectez-vous à la machine <span class="courier11">Manager</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Vérifiez que les services créés
lors des précédents exercices sont bien arrêtés, à l’aide
de la commande <span class="courier11">docker service ls</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Au besoin, arrêtez-les avec la commande <span class="courier11">docker service rm [identifiant du
service]</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande <span class="courier11">docker
stack --help</span>, qui va nous permettre de visualiser les commandes
disponibles&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs sql">Usage:&nbsp;&nbsp;docker stack COMMAND&nbsp;
&nbsp;
Manage Docker stacks&nbsp;
&nbsp;
Options:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--help&nbsp;&nbsp; Print usage&nbsp;</span>
&nbsp;
Commands:&nbsp;
&nbsp;&nbsp;deploy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Deploy a new stack or <span class="hljs-keyword">update</span> an existing stack&nbsp;
&nbsp;&nbsp;ls&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">List</span> stacks&nbsp;
&nbsp;&nbsp;ps&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">List</span> the tasks <span class="hljs-keyword">in</span> the stack&nbsp;
&nbsp;&nbsp;rm&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove the stack&nbsp;
&nbsp;&nbsp;services&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">List</span> the services <span class="hljs-keyword">in</span> the stack&nbsp;
&nbsp;
Run ’docker stack COMMAND <span class="hljs-comment">--help’ for more information on a command.</span></code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Précisez le besoin d’aide en appelant <span class="courier11">docker stack deploy --help</span>, ce qui
aboutira à l’affichage suivant&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs delphi">Usage:&nbsp;&nbsp;docker stack deploy [OPTIONS] STACK&nbsp;
&nbsp;
Deploy a new stack <span class="hljs-keyword">or</span> update an existing stack&nbsp;
&nbsp;
Aliases:&nbsp;
&nbsp;&nbsp;deploy, up&nbsp;
&nbsp;
Options:&nbsp;
&nbsp;&nbsp;-c, --compose-<span class="hljs-keyword">file</span> <span class="hljs-keyword">string</span>&nbsp;&nbsp; Path <span class="hljs-keyword">to</span> a Compose <span class="hljs-keyword">file</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print usage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--<span class="hljs-keyword">with</span>-registry-auth&nbsp;&nbsp;&nbsp;&nbsp;Send registry authentication details &nbsp;
<span class="hljs-keyword">to</span> Swarm agents</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Positionnez-vous dans le répertoire <span class="courier11">middleoffice-microservices-v2</span> si vous
n’y êtes pas déjà.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande de déploiement
d’une stack à partir du fichier Docker Compose préalablement
recopié depuis le projet de déploiement, comme suit&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> deploy -c ./docker-compose.yml mastack</code></pre>
          <p class="defaut">Le message ci-dessous apparaîtra
alors&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP22.png" title="images/06EP22.png" src="IMAGES/06EP22.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Nous renvoyons le lecteur au livre sur Docker
Swarm pour approfondir les fonctionnalités des différentes
versions de fichier Docker Compose, car cela n’est pas dans le périmètre
du présent ouvrage. La version sera simplement modifiée
dans le fichier.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Ouvrez le fichier <span class="courier11">docker-compose.yml</span> et
modifiez la valeur de version de <span class="courier11">2.1</span> à <span class="courier11">3</span>.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sauvegardez le fichier et fermez l’éditeur
de texte utilisé.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Relancez la commande précédente.</p>
          </div>
          <p class="defaut">Cette fois, c’est un autre problème
qui apparaît&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP23.png" title="images/06EP23.png" src="IMAGES/06EP23.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">La grammaire de dépendance n’est
pas la même en version 3. Comme expliqué précédemment,
ce mécanisme n’est de toute façon pas une panacée
et l’approche la plus élégante est de faire en
sorte que les services soient complètement autonomes et
aient donc un comportement correct (ce qui ne veut pas dire pleinement
fonctionnel) lorsque certaines de leurs dépendances sont
absentes.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Supprimez toutes les entrées <span class="courier11">depends_on</span> du fichier <span class="courier11">docker-compose.yml</span>, en n’omettant
bien sûr pas les lignes en dessous du titre de section
et qui comprennent les paramètres de gestion de dépendance
(service ciblé, condition, etc.).</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Sauvegardez le fichier.</p>
          </div>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Relancez la commande <span class="courier11">docker
stack deploy</span> comme précédemment.</p>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention, si le fichier a été modifié pour
utiliser des images locales plutôt que celles par défaut
qui sont disponibles sur Docker Hub, une erreur apparaîtra expliquant
que ceci empêche la stack d’être déployée.
Le problème est le même que celui expliqué plus
haut lors du déploiement manuel sur Swarm&nbsp;: comme
Docker ne peut pas être sûr que les images sont
strictement les mêmes d’une machine à l’autre,
il y a risque de dérive. La différence est qu’en mode
manuel, Docker se contentait d’un avertissement et lançait
le conteneur sur le démon local, tandis qu’en mode stack,
il bloque complètement (ce qui est assez logique, vu que
la fonctionnalité est prévue spécifiquement
pour des déploiements sans dépendance à une
machine ou à une autre).</p>
            </div>
          </div>
          <p class="defaut">Cette fois-ci, l’instruction fonctionne et
déploie une stack, non sans quelques derniers avertissements
toutefois&nbsp;:</p>
          <pre class="programlisting"><code class="hljs delphi">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $ docker &nbsp;
stack deploy -c ./docker-compose.yml mastack<b>&nbsp;
WARN[<span class="hljs-number">0000</span>] ignoring IP-address (<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">27017</span>:<span class="hljs-number">27017</span>/tcp) &nbsp;
service will listen <span class="hljs-keyword">on</span> ’<span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>’&nbsp;
Ignoring unsupported options: build, links, restart&nbsp;
&nbsp;
Ignoring <span class="hljs-keyword">deprecated</span> options:&nbsp;&nbsp;
container_name: Setting the container <span class="hljs-keyword">name</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> supported.</b>&nbsp;
&nbsp;
Creating network mastack_default&nbsp;
Creating service mastack_mo-welcome&nbsp;
Creating service mastack_mo-demande-remplir&nbsp;
Creating service mastack_mo-parametrage&nbsp;
Creating service mastack_mo-demandes-liste&nbsp;
Creating service mastack_mo-database&nbsp;
Creating service mastack_mo-decisions&nbsp;
Creating service mastack_mo-demandes-bo&nbsp;
Creating service mastack_mo-demande-creer&nbsp;
Creating service mastack_mo-decisions-bo&nbsp;
Creating service mastack_traefik</code></pre>
          <p class="defaut">Prenons ces avertissements un par un pour
les résoudre, ou au moins les comprendre.</p>
          <p class="defaut">Tout d’abord, la restriction d’appel de notre
base de données MongoDB sur la machine locale sera ignorée.
Ceci est complètement logique pour la simple et bonne raison
que nous ne savons plus désormais sur quelle machine le
conteneur sera déployé dans le cluster&nbsp;;
restreindre sur une IP ne fait donc plus sens.</p>
          <p class="defaut">Les lignes ci-dessous seront donc purement
et simplement effacées, car elles avaient été prévues
pour un diagnostic local&nbsp;de la base, mais ouvrir le port 27017
hors restriction serait dangereux&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">ports</span>:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-selector-tag">-</span> 127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-pseudo">:27017</span><span class="hljs-selector-pseudo">:27017</span></code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Pour rappel, c’est pour donner une
solution plus propre à cette limitation que le mécanisme
de tunnel SSH avait été montré dans la
section précédente.</p>
            </div>
          </div>
          <p class="defaut">Le second avertissement porte sur le fait
que la commande <span class="courier11">docker stack deploy</span> ignore
l’option <span class="courier11">build</span>. Ceci est plutôt
une bonne nouvelle, car le fait qu’elle n’en ait pas besoin ne veut
pas dire qu’il est obligatoire de l’enlever&nbsp;; or, cet attribut
est bien utile pour compiler d’un coup toutes les images. Nous laissons
donc bien sûr tous les attributs correspondants.</p>
          <p class="defaut">Le troisième avertissement porte
sur le fait que l’attribut <span class="courier11">links</span> sera également
ignoré. Ceci peut paraître un vrai problème
car les conteneurs ont besoin de pouvoir se parler, et en particulier
les services de back office ont besoin de la base de données
pour fonctionner correctement. Nous allons voir plus loin que ce
problème est résolu de manière très élégante
par Docker, et pouvons pour l’instant purement et simplement supprimer
les sections <span class="courier11">links</span> du fichier <span class="courier11">docker-compose.yml</span>.</p>
          <p class="defaut">De plus, les attributs <span class="courier11">restart</span> sont
ignorés, ce qui est logique car le cycle de vie des conteneurs
sera désormais pris en charge par Docker en mode Swarm, et
ce sont les services qui se chargeront de redémarrer les
conteneurs si nécessaire, d’en rajouter ou d’en supprimer
en fonction des passages à l’échelle demandés,
etc. Là aussi, nous supprimons simplement ces attributs.</p>
          <p class="defaut">Enfin, le dernier avertissement était
sur le fait que les indications <span class="courier11">container_name</span> seront
ignorées. Comme le lecteur le constatera, les conteneurs sont
entièrement gérés&nbsp;par Docker,
et leur nommage est automatique. Il convient donc de supprimer ces
attributs qui ne serviront plus, ce qui doit au final donner un
contenu de fichier <span class="courier11">docker-compose.yml</span> comme
suit&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">version: ’<span class="hljs-number">3</span>’&nbsp;
services:&nbsp;
&nbsp;
&nbsp;&nbsp;mo-welcome:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/welcome&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./welcome&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">80</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;
&nbsp;&nbsp;mo-parametrage:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/parametrage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./parametrage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">81</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_PARAM=mongodb:<span class="hljs-comment">//mongo:27017&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demandes-bo:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demandes-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demandes-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">82</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_DEMANDES=mongodb:<span class="hljs-comment">//mongo:27017&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demande-creer:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demande-creer&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demande-creer&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">83</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demande-remplir:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demande-remplir&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demande-remplir&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">84</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demandes-liste:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demandes-liste&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demandes-liste&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">85</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-decisions-bo:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/decisions-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./decisions-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">86</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_DECISIONS=mongodb:<span class="hljs-comment">//mongo:27017&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-decisions:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/decisions&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./decisions&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">87</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-database:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: mongo:<span class="hljs-number">3.6</span><span class="hljs-number">.4</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;volumes:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- mongodata:<span class="hljs-regexp">/data/</span>db&nbsp;
&nbsp;
volumes:&nbsp;
&nbsp;&nbsp;mongodata:</code></pre>
          <p class="defaut">Le prochain lancement devrait donc se passer
uniquement avec un avertissement, et qui est considéré comme
normal.</p>
        </div>
        <div class="sect3" id="refTitle25">
          <h3 class="title">g. Diagnostic et validation du fonctionnement</h3>
          <p class="defaut">Avant de recommencer la manipulation maintenant
que la source des avertissements est partiellement levée,
il est essentiel de commencer par supprimer la stack créée
précédemment, de façon à pouvoir
réutiliser le même nom, mais aussi et surtout
pour ne pas laisser des ressources inutilement bloquées.</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Exécutez la commande pour supprimer
la stack existante mais incomplète&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> rm mastack</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Vérifiez que la stack est bien supprimée
avec la commande ci-dessous&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> ls</code></pre>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez à nouveau la commande de création
de la stack&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> deploy -c ./docker-compose.yml mastack</code></pre>
          <p class="defaut">Cette fois, le déploiement se déroule
tel qu’attendu. Nous pouvons vérifier que la stack est
bien lancée, et les services sous-jacents démarrés
comme suit&nbsp;:</p>
          <div class="manip">
            <p><span class="icon-manip">&nbsp;</span>Lancez la commande suivante&nbsp;:</p>
          </div>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> ls</code></pre>
          <p class="defaut">Elle produit l’affichage suivant, qui décrit
les différentes stacks et leurs attributs principaux&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP26a.png" title="images/06EP26a.png" src="IMAGES/06EP26a.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Une fois les stacks en cours obtenues (en
l’occurrence uniquement celle nommée <span class="courier11">mastack</span> et
qui vient d’être lancée), une autre commande permet
de voir son état de fonctionnement sur le cluster&nbsp;:</p>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> ps mastack</code></pre>
          <p class="defaut">Le résultat est alors comme suit&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP24.png" title="images/06EP24.png" src="IMAGES/06EP24.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Il est également possible de regarder
plus en détail les différents services avec la
commande suivante&nbsp;:</p>
          <pre class="programlisting"><code class="hljs cpp">docker <span class="hljs-built_in">stack</span> services mastack</code></pre>
          <p class="defaut">Le résultat produit est le suivant&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP25.png" title="images/06EP25.png" src="IMAGES/06EP25.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À noter que, si la stack
est la seule démarrée sur ce cluster, la commande
précédente est équivalente à la
commande <span class="courier11">docker service ls</span>.</p>
            </div>
          </div>
          <p class="defaut">Cette étape nous permet de retrouver
les identifiants des services, ce qui nous permettra d’utiliser
une commande <span class="courier11">docker service inspect</span> sur
un service donné et par rebond nous fournira le maximum
de détails sur ce dernier. Par exemple&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $&nbsp;<b>&nbsp;
docker service inspect mastack_mo-welcome</b>&nbsp;
[&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ID"</span>: <span class="hljs-string">"wa90fzm76cqrw6ksxmk1byu67"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Version"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Index"</span>: <span class="hljs-number">1090</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"CreatedAt"</span>: <span class="hljs-string">"2020-10-11T11:15:24.938832978Z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"UpdatedAt"</span>: <span class="hljs-string">"2020-10-11T11:15:24.942019287Z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Spec"</span>: {<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"mastack_mo-welcome"</span>,</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Labels"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"com.docker.stack.image"</span>: <span class="hljs-string">"middleoffice/welcome"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"com.docker.stack.namespace"</span>: <span class="hljs-string">"mastack"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"TaskTemplate"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ContainerSpec"</span>:<b>{ &nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Image"</span>: &nbsp;
<span class="hljs-string">"middleoffice/welcome:latest@sha256:90aacdadccfc7e6b9089b3545f764&nbsp;
627028b35e32135ee8dff21a17eb1843240"</span></b>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Labels"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"com.docker.stack.namespace"</span>: <span class="hljs-string">"mastack"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Privileges"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"CredentialSpec"</span>: <span class="hljs-keyword">null</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"SELinuxContext"</span>: <span class="hljs-keyword">null</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"StopGracePeriod"</span>: <span class="hljs-number">10000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"DNSConfig"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Isolation"</span>: <span class="hljs-string">"default"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Resources"</span>: {},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"RestartPolicy"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Condition"</span>: <span class="hljs-string">"any"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Delay"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxAttempts"</span>: <span class="hljs-number">0</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Placement"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Platforms"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Architecture"</span>: <span class="hljs-string">"amd64"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"OS"</span>: <span class="hljs-string">"linux"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Networks"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Target"</span>: <span class="hljs-string">"y72gnzh8crb90zjolzs266itf"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Aliases"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"mo-welcome"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ForceUpdate"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Runtime"</span>: <span class="hljs-string">"container"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Mode"</span>: {<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Replicated"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Replicas"</span>: <span class="hljs-number">1</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"UpdateConfig"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Parallelism"</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"FailureAction"</span>: <span class="hljs-string">"pause"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Monitor"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxFailureRatio"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Order"</span>: <span class="hljs-string">"stop-first"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"RollbackConfig"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Parallelism"</span>: <span class="hljs-number">1</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"FailureAction"</span>: <span class="hljs-string">"pause"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Monitor"</span>: <span class="hljs-number">5000000000</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"MaxFailureRatio"</span>: <span class="hljs-number">0</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Order"</span>: <span class="hljs-string">"stop-first"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"EndpointSpec"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Mode"</span>: <span class="hljs-string">"vip"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Ports"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"TargetPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishedPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishMode"</span>: <span class="hljs-string">"ingress"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Endpoint"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Spec"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Mode"</span>: <span class="hljs-string">"vip"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Ports"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"TargetPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishedPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishMode"</span>: <span class="hljs-string">"ingress"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Ports"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"TargetPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishedPort"</span>: <span class="hljs-number">80</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"PublishMode"</span>: <span class="hljs-string">"ingress"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"VirtualIPs"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"NetworkID"</span>: <span class="hljs-string">"ad44u0zbldd5oy1omca5mh5fv"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Addr"</span>: <span class="hljs-string">"10.0.0.99/24"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"NetworkID"</span>: <span class="hljs-string">"y72gnzh8crb90zjolzs266itf"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Addr"</span>: <span class="hljs-string">"10.0.8.17/24"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
]</code></pre>
          <p class="defaut">On peut constater que le nom est composé du
nom de la stack et du nom du service tel que déclaré dans
le fichier <span class="courier11">docker-compose.yml</span>, ce
qui assure l’unicité du service et son étanchéité par
rapport à son jumeau si deux stacks sont lancées
sur le même fichier descriptif d’application (ce qui était
impossible avec Docker Compose, car il y avait alors conflit sur
les identifiants, en plus des conflits sur les ports réseau).</p>
          <p class="defaut">L’information sur l’image utilisée
montre que celle-ci est bien désignée pas seulement
par son étiquette, mais bien par son "digest", qui est
un identifiant calculé d’après le contenu, et
assure qu’une image, même avec le même nom, ne pourra
pas être utilisée si elle n’est pas identique
en contenu.</p>
          <p class="defaut">L’alias <span class="courier11">mo-welcome</span> est
attribué sur le réseau interne qui a été monté&nbsp;;
ceci sera utile pour faire communiquer les conteneurs, les liens
ayant été désactivés plus haut
car non supportés.</p>
          <p class="defaut">Enfin, les logs montrent que le nombre de
répliques du service est pour l’instant à 1, ce
qui est logique vu que nous avons simplement démarré le
service et pas spécifié de passage à l’échelle.</p>
          <p class="defaut">Pour ce qui est du réseau, il est à noter
que nous n’avons pas eu besoin de créer un réseau&nbsp;avant
d’y poser les services&nbsp;: le fait de passer par une stack
a automatiquement généré un réseau
dédié, comme on peut le voir dans l’affichage suite à la
commande de déploiement de la stack&nbsp;:</p>
          <pre class="programlisting"><code class="hljs">Creating network mastack_default&nbsp;
Creating service mastack_mo-parametrage&nbsp;
(...)</code></pre>
          <p class="defaut">Cette information se retrouve d’ailleurs en
appelant la commande pour lister les réseaux,&nbsp;à savoir <span class="courier11">docker network l</span>s. Le résultat
produit dans notre cas montre bien ce réseau créé pour
la stack juste démarrée&nbsp;:</p>
          <pre class="programlisting"><code class="hljs delphi">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $ docker &nbsp;
network ls&nbsp;
NETWORK ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">NAME</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DRIVER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCOPE&nbsp;
b58a259f5b1a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bridge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bridge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">local</span>&nbsp;
ac91aeca6ebd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;docker_gwbridge&nbsp;&nbsp;&nbsp;&nbsp; bridge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">local</span>&nbsp;
be60b4ca2fbd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">local</span>&nbsp;
ad44u0zbldd5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ingress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; overlay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; swarm&nbsp;
y72gnzh8crb9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>mastack_default</b>&nbsp;&nbsp;&nbsp;&nbsp; overlay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; swarm&nbsp;
c6e547800421&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;none&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;null&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">local</span></code></pre>
          <p class="defaut">Encore une fois, une commande <span class="courier11">inspect</span> existe pour voir le contenu
détaillé des paramètres&nbsp;de ce
réseau&nbsp;:</p>
          <pre class="programlisting"><code class="hljs php">&nbsp;
azureuser@ClearDockerENI~/middleoffice-microservices-v2 $<b>&nbsp;
docker network inspect mastack_default</b>&nbsp;
[&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"mastack_default"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Id"</span>: <span class="hljs-string">"y72gnzh8crb90zjolzs266itf"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Created"</span>: <span class="hljs-string">"2020-10-11T11:15:13.291394351Z"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Scope"</span>: <span class="hljs-string">"swarm"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Driver"</span>: <span class="hljs-string">"overlay"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"EnableIPv6"</span>: <span class="hljs-keyword">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"IPAM"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Driver"</span>: <span class="hljs-string">"default"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Options"</span>: <span class="hljs-keyword">null</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Config"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Subnet"</span>: <span class="hljs-string">"10.0.8.0/24"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Gateway"</span>: <span class="hljs-string">"10.0.8.1"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Internal"</span>: <span class="hljs-keyword">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Attachable"</span>: <span class="hljs-keyword">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Ingress"</span>: <span class="hljs-keyword">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ConfigFrom"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Network"</span>: <span class="hljs-string">""</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"ConfigOnly"</span>: <span class="hljs-keyword">false</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Containers"</span>: {&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Labels"</span>: {&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"com.docker.stack.namespace"</span>: <span class="hljs-string">"mastack"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Peers"</span>: [&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"7a8a853923c1"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"IP"</span>: <span class="hljs-string">"10.0.0.4"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"92ad64cf1685"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"IP"</span>: <span class="hljs-string">"10.0.0.7"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"Name"</span>: <span class="hljs-string">"967683b51fae"</span>,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-string">"IP"</span>: <span class="hljs-string">"10.0.0.8"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
]</code></pre>
          <p class="defaut">Il nous reste maintenant à valider
que l’appel de l’application fonctionne comme attendu, et à première
vue, il semble que ce soit à peu près le cas&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP26.png" title="images/06EP26.png" src="IMAGES/06EP26.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Le service correspondant au portail d’accueil
est bien exposé sur le port 80 et accessible à l’extérieur.
Bien sûr, il reste le problème d’accès
aux liens, et un clic sur le bouton&nbsp;<b>Créer une nouvelle demande</b> ne
fonctionne pas car il pointe sur l’URL relative&nbsp;<span class="courier11">/demande-creer/demandes/creer</span> au
lieu de passer par le bon port correspondant. Nous ne reviendrons
pas sur ce problème, qui a été expliqué auparavant
et dont la solution est de mettre en place Traefik.</p>
          <p class="defaut">Un second test, à destination du
service <span class="courier11">mo-parametrage</span> qui est exposé sur le
port 81, montre par contre que le fait d’enlever les descriptions
de liens pose bien sûr un problème, car le service
n’a plus de connexion à la base de données. Un
premier appel sur la racine sert de point d’information pour renseigner
sur le paramétrage&nbsp;:</p>
          <pre class="programlisting"><code class="hljs java">azureuser<span class="hljs-meta">@ClearDockerENI</span>~/middleoffice-microservices-v2 $ curl &nbsp;
http:<span class="hljs-comment">//localhost:81&nbsp;</span>
Le service <span class="hljs-string">"parametrage"</span> est démarré&nbsp;; il pointe sur &nbsp;
mongodb:<span class="hljs-comment">//mongo:27017</span></code></pre>
          <p class="defaut">Mais si on lance un appel sur l’API de statut
du service, on voit qu’il y a un problème&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">azureuser</span>@<span class="hljs-keyword">ClearDockerENI</span>~/<span class="hljs-keyword">middleoffice</span>-<span class="hljs-keyword">microservices</span>-<span class="hljs-keyword">v2</span> $ curl &nbsp;
http://enidocker.francecentral.cloudapp.azure.com:<span class="hljs-number">81</span>/api/status&nbsp;
{"<span class="hljs-selector-tag">type</span>"<span class="hljs-selector-pseudo">:"about</span><span class="hljs-selector-pseudo">:blank"</span>,"<span class="hljs-selector-tag">status</span>"<span class="hljs-selector-pseudo">:500</span>}</code></pre>
          <p class="defaut">Pour des raisons de sécurité,
il est bon que ce message exposé au public n’en dise pas
trop, et c’est pourquoi ce sont les logs du service qui expliquent
plus précisément ce qui se passe&nbsp;:</p>
          <pre class="programlisting"><code class="hljs perl">azureuser@ClearDockerENI~<span class="hljs-regexp">/middleoffice-microservices-v2 $&nbsp;</span><b><span class="hljs-regexp">docker &nbsp;
service logs mastack_mo-parametrage</span></b><span class="hljs-regexp">&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
warn: &nbsp;
Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[35]&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
No XML encryptor configured. Key {505a87ca-666d-490e-8b27-29576fdab961}&nbsp;
may be persisted to storage in unencrypted form.&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
Hosting environment: Production&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
Content root path: /app</span>&nbsp;
mastack_mo-parametrage.<span class="hljs-number">1</span>.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
Now listening on:&nbsp;<b>http:<span class="hljs-regexp">//</span><span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>:<span class="hljs-number">80</span></b>&nbsp;
mastack_mo-parametrage.<span class="hljs-number">1</span>.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
Application started. Press Ctrl+C to shut down.&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
<span class="hljs-string">"0HM3DR62F0ONP:00000002"</span>: An unhandled exception was thrown by &nbsp;
the application.&nbsp;
mastack_mo-parametrage.<span class="hljs-number">1</span>.me6orgm96172@&nbsp;<b>ClearLinux-worker2&nbsp;</b>&nbsp;&nbsp;&nbsp;| &nbsp;
System.TimeoutException: A timeout occured after <span class="hljs-number">30000</span>ms &nbsp;
selecting a server using CompositeServerSelector{ Selectors = &nbsp;
MongoDB.Driver.MongoClient+AreSessionsSupportedServerSelector, &nbsp;
LatencyLimitingServerSelector{ AllowedLatencyRange = &nbsp;
<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">0150000</span> } }. Client view of cluster <span class="hljs-keyword">state</span> is { ClusterId&nbsp;: &nbsp;
<span class="hljs-string">"1"</span>, ConnectionMode&nbsp;: <span class="hljs-string">"Automatic"</span>, Type&nbsp;: <span class="hljs-string">"Unknown"</span>, State&nbsp;: &nbsp;
<span class="hljs-string">"Disconnected"</span>, Servers&nbsp;: [{ ServerId: <span class="hljs-string">"{ ClusterId&nbsp;: 1, EndPoint&nbsp;: &nbsp;
"</span><b>Unspecified/mongo:<span class="hljs-number">27017</span></b><span class="hljs-string">" }"</span>, EndPoint: &nbsp;
<span class="hljs-string">"Unspecified/mongo:27017"</span>, State: <span class="hljs-string">"Disconnected"</span>, Type: &nbsp;
<span class="hljs-string">"Unknown"</span>, HeartbeatException: &nbsp;
<span class="hljs-string">"MongoDB.Driver.MongoConnectionException: An exception occurred &nbsp;
while opening a connection to the server. ---&gt; &nbsp;
System.Net.Internals.SocketExceptionFactory+ExtendedSocketException: &nbsp;
No such device or address&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
at&nbsp;</span><b><span class="hljs-string">System.Net.Dns.InternalGetHostByName</span></b><span class="hljs-string">(String hostName)&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
parametrage.Controllers.ValuesController.postParametrage(Parametrage &nbsp;
parametrage) in&nbsp;</span><b><span class="hljs-string">/app/Controllers/ValuesController.cs:line 71</span></b><span class="hljs-string">&nbsp;
mastack_mo-parametrage.1.me6orgm96172@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;
at &nbsp;
&nbsp;
(...)</span><b><span class="hljs-string">&nbsp;
&nbsp;
at Microsoft.AspNetCore.Server.Kestrel.Core.Internal.Http.HttpProtocol.&nbsp;
ProcessRequests</span></b><span class="hljs-string">[TContext](IHttpApplication`1 application)</span></code></pre>
          <p class="defaut">Conformément à ce qui était
attendu, l’accès à la base de données
ne fonctionne pas, ce qui est logique puisque les liens ont été supprimés
dans le fichier <span class="courier11">docker-compose.yml</span>,
comme ils n’étaient pas supportés par la grammaire en
version 3. Dans le détail, on voit que les étapes
dans l’extrait de logs ci-dessus sont les suivantes&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">La commande à utiliser
est <span class="courier11">docker service logs</span>. L’avantage
de cette commande est qu’elle regroupe automatiquement les logs
des conteneurs lancés pour implémenter le service,
quels que soit leur nombre et leur emplacement sur le cluster.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Le serveur applicatif du conteneur
démarre et écoute sur le port 80 en interne (nous
l’avons redirigé sur le port 81 dans le fichier descriptif
de l’application).</p>
              </li>
              <li class="liste1">
                <p class="liste1">Une erreur apparaît sur
le conteneur, qui a été lancé sur le
second node dans notre cas (<span class="courier11">ClearLinux-worker2</span>).</p>
              </li>
              <li class="liste1">
                <p class="liste1">Cette erreur est sur le fait que
l’adresse <span class="courier11">mongo:27017</span> n’est pas
connue.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Elle s’est manifestée lors
de l’appel de la fonction de résolution DNS du nom d’hôte.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Cette fonction était utilisée
par la ligne 71 du code <span class="courier11">ValuesController.cs</span> du
service <span class="courier11">parametrage</span>, dont on pourrait
vérifier que c’est la ligne qui ouvre la connexion à la
base de données MongoDB.</p>
              </li>
              <li class="liste1">
                <p class="liste1">Enfin, à titre uniquement
d’information, cette commande est déclenchée par
le traitement d’une requête HTTP par le serveur Kestrel
sous-jacent d’ASP.NET Core.</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="sect3" id="refTitle26">
          <h3 class="title">h. Utilisation du DNS<var style="display:none"> DNS</var></h3>
          <p class="defaut">La bonne nouvelle est que Docker a prévu
mieux que les liens pour ce mode de fonctionnement avec Swarm, à savoir
l’incorporation automatique d’entrées DNS dans le réseau
créé lors du lancement de la stack, pour que les
services puissent s’appeler les uns les autres… tout simplement
par leur nom&nbsp;!</p>
          <p class="defaut">Pour régler le problème,
il suffit donc de modifier les trois entrées dans le fichier <span class="courier11">docker-compose.yml</span> qui faisaient référence à l’adresse
de la base de données en leur passant la valeur <span class="courier11">mo-database</span> au lieu du nom de base
de données défini dans l’alias du link créé auparavant&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_DECISIONS=mongodb:<span class="hljs-comment">//mo-database:27017</span></code></pre>
          <p class="defaut">En supprimant la stack puis en la recréant,
le test sur l’appel de l’API de statut fonctionne correctement et
renvoie un code 200 (OK). Un test par Postman permet également
de valider d’une autre manière, en remplissant un type
de demande dans le paramétrage, que la base de données
est désormais correctement accédée par
le service&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP27.png" title="images/06EP27.png" src="IMAGES/06EP27.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Nous ne rentrerons pas dans le détail
de la gestion DNS de Docker, et renvoyons vers la documentation
de Docker pour les détails, ainsi que vers la webographie
associée au présent ouvrage et disponible depuis
le site des Éditions ENI. La seule information additionnelle
est la reprise d’un conseil porté justement par une de
ces références, et qui recommande de ne pas utiliser
le système d’alias DNS pour lui faire gérer la
répartition de charge d’un trafic de production entrant,
et de laisser les serveurs spécialisés s’occuper
de ceci.</p>
          <p class="defaut">De même, si le fait que les conteneurs à l’intérieur
de la stack puissent se parler librement pose des problèmes
de sécurité ou de stabilité, il est possible
de mettre en place des réseaux séparés
et de faire porter les services sur tel ou tel réseau là où,
pour des raisons de simplicité, nous avons laissé un
réseau unique par défaut être créé lors
de la commande de démarrage de la stack.</p>
          <p class="defaut">Enfin, il est aussi possible de jouer sur
les paramètres du réseau overlay créé pour
le cluster, sur le comportement de l’ingress mis en place par défaut,
etc., mais cela dépasse&nbsp;le cadre du présent
ouvrage.</p>
        </div>
      </div>
      <div class="sect2" id="refTitle27">
        <h2 class="title">5. Considérations additionnelles</h2>
        <div class="sect3" id="refTitle28">
          <h3 class="title">a. Provenance des images</h3>
          <p class="defaut">Une remarque sur l’exercice qui vient d’être
réalisé est que le registre utilisé était
public,&nbsp;mais que cette approche n’est pas toujours possible
avec des applications industrielles.&nbsp;Or, nous avons constaté qu’à aucun
moment la commande <span class="courier11">docker pull</span> n’a été lancée
par l’administrateur de l’application, vu que c’est Swarm qui a
distribué les tâches sur les différents
nœuds. Le téléchargement des images a
bien sûr nécessairement&nbsp;eu lieu, mais
de manière transparente. Si le registre utilisé avait été privé,
comment cette manipulation aurait-elle été possible
vu que le nœud n’a pas connaissance du mot de passe ou
de manière générale des crédentiels
d’accès au registre&nbsp;?</p>
          <p class="defaut">Il se trouve que Docker a pensé à cette
problématique dès les premières versions
de mise en œuvre de Swarm et propose une option <span class="courier11">--with-registry-auth</span> pour la commande <span class="courier11">docker swarm deploy</span>, qui va utiliser l’authentification
locale au registre&nbsp;(nécessaire dans le cas d’un
registre privé pour opérer la commande <span class="courier11">docker-compose push</span> telle que réalisée
plus haut) et la pousser dans les différents nœuds.</p>
        </div>
        <div class="sect3" id="refTitle29">
          <h3 class="title">b. Passage à l’échelle</h3>
          <p class="defaut">Lorsque des conteneurs additionnels seront
créés, l’orchestration de Swarm va les disposer
sur les différents nœuds du cluster, de façon à équilibrer
la charge. Pour rester dans une approche logique, le point d’entrée
dit <span class="courier11">ingress</span> (qu’on peut retrouver
en lançant une commande <span class="courier11">docker
network inspect docker_gwbridge</span>) se charge alors
de répartir la charge entre les différents conteneurs.</p>
          <p class="defaut">La commande de passage à l’échelle,
logiquement, reste exactement la même, que l’on crée
les services manuellement ou par la commande <span class="courier11">docker
stack deploy</span>&nbsp;:</p>
          <p><span class="bridgehead_niv4">Passer un service à l’échelle</span></p>
          <pre class="literallayout"><code class="hljs">docker service scale [nom du service]=[nombre d’instances]</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Le mode de fonctionnement par défaut
de la répartition de charge est celui dit "round robin"&nbsp;:
les requêtes sont distribuées à la suite
sur chacun des conteneurs disponibles, et lorsque tous ont été contactés,
le système repart au début de la liste et recommence.
Dans ce mode de fonctionnement, l’affectation d’une requête à un
conteneur plutôt qu’à un autre ne tient aucunement
compte de la charge déjà affectée à tel
ou tel. Ce mécanisme fonctionne donc particulièrement
bien lorsque les requêtes sont globalement aussi complexes
les unes que les autres et lorsque les ressources sont équitablement distribuées
entre les différents agents. Lorsque ce n’est pas le cas,
il est recommandé d’utiliser des mécanismes plus
sophistiqués qui vont tenir compte de la charge des agents
et affecter les nouvelles tâches sur ceux qui ont, à ce
moment précis, le moins de travail en cours.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle30">
          <h3 class="title">c. Mise à jour des images</h3>
          <p class="defaut">Une autre fonctionnalité que l’auteur
souhaite citer sur Docker Swarm est le rolling update. Encore une
fois, cela n’aurait pas de sens de reproduire le contenu du second
livre sur Docker dans le présent livre qui se veut une
introduction claire aux concepts de Docker, mais il reste important
de montrer qu’il y a encore un monde de fonctionnalités
derrière les principales que nous avons explorées
ici. En particulier, la mise à jour incrémentale
de services est une capacité réellement impressionnante
de Docker. Elle consiste à monter en version les services
tout en garantissant que la fonctionnalité ne sera jamais complètement
arrêtée.</p>
          <p class="defaut">Ainsi, si un service doit passer d’une version à une
autre de son image, la commande à utiliser est <span class="courier11">docker service update</span>. Par défaut,
cette commande va simplement arrêter toutes les tâches
correspondant au service et les relancer avec la nouvelle définition
de l’image pour les conteneurs. Il y aura eu rupture de service
car tout est arrêté en même temps.</p>
          <p class="defaut">Si plusieurs instances du service sont en
cours, il est possible de spécifier un degré de
parallélisme de la mise à jour avec l’option <span class="courier11">--update-parallelism</span>, la valeur entière&nbsp;spécifiant
le nombre de tâches à mettre à jour en
même temps. Ainsi, sur le service <span class="courier11">welcome</span> de
notre exemple, l’utilisation d’une valeur à 2 pour cette
option nous garantirait que, sur les cinq répliques de
ce service, trois resteront toujours actives&nbsp;pendant la
mise à jour incrémentale. Pour cela, il faut bien
sûr également spécifier un délai
entre chaque vague de mise à jour, et c’est l’option <span class="courier11">--update-delay</span> qui permet ceci. Dans
notre exemple, une valeur de <span class="courier11">30s</span> (une
demi-minute) suffirait amplement, une instance de service basée
sur l’image <span class="courier11">welcome</span> étant
très rapide à s’arrêter, télécharger
en mise à jour et démarrer (hormis cas particulier,
quelques secondes).&nbsp;Cette mise à jour contrôlée
par Swarm permet également le mécanisme de rollback, c’est-à-dire
de revenir à la précédente version fonctionnelle,
en cas de problème.&nbsp;</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Cette dernière remarque peut
paraître anodine, mais tout administrateur système
expérimenté&nbsp;a ressenti un jour de la
peur à l’idée d’arrêter tel ou tel serveur&nbsp;;
la procédure de redémarrage des applications n’est
parfois pas connue ou stable et le risque existe réellement
de tout simplement ne pas pouvoir remettre le service dans un état
fonctionnel. Les technologies décrites permettent dans
un environnement Docker de réduire quasiment à néant
ce type de problème.</p>
            </div>
          </div>
          <p class="defaut">Bref, encore un champ de fonctionnalités
avancées de Docker, dont il est possible de percevoir l’étendue
en lançant une simple commande listant les options disponibles
pour la commande <span class="courier11">docker service update</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $ docker &nbsp;
service <span class="hljs-keyword">update</span> <span class="hljs-comment">--help&nbsp;</span>
&nbsp;
<span class="hljs-keyword">Usage</span>:&nbsp;&nbsp;docker service <span class="hljs-keyword">update</span> [OPTIONS] SERVICE&nbsp;
&nbsp;
<span class="hljs-keyword">Update</span> a service&nbsp;
&nbsp;
Options:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--args command&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Service command args&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--config-add config&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a config &nbsp;</span>
<span class="hljs-keyword">file</span> <span class="hljs-keyword">on</span> a service&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--config-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a configuration &nbsp;</span>
<span class="hljs-keyword">file</span><b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--constraint-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a &nbsp;</span>
placement <span class="hljs-keyword">constraint</span></b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--constraint-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a constraint&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--container-label-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add or update a &nbsp;</span>
<span class="hljs-keyword">container</span> label&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--container-label-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a container &nbsp;</span>
label <span class="hljs-keyword">by</span> its <span class="hljs-keyword">key</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--credential-spec credential-spec&nbsp;&nbsp;&nbsp;&nbsp;Credential spec for &nbsp;</span>
<span class="hljs-keyword">managed</span> service <span class="hljs-keyword">account</span> (Windows <span class="hljs-keyword">only</span>)&nbsp;
&nbsp;&nbsp;-d, <span class="hljs-comment">--detach&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Exit immediately &nbsp;</span>
instead <span class="hljs-keyword">of</span> waiting <span class="hljs-keyword">for</span> the service <span class="hljs-keyword">to</span> converge<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add or update a custom &nbsp;</span>
DNS <span class="hljs-keyword">server</span></b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-option-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a DNS &nbsp;</span>
<span class="hljs-keyword">option</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-option-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a DNS option&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a custom DNS &nbsp;</span>
<span class="hljs-keyword">server</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-search-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a custom &nbsp;</span>
DNS <span class="hljs-keyword">search</span> <span class="hljs-keyword">domain</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--dns-search-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a DNS search &nbsp;</span>
<span class="hljs-keyword">domain</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--endpoint-mode string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Endpoint mode (vip or &nbsp;</span>
dnsrr)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--entrypoint command&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Overwrite the default &nbsp;</span>
ENTRYPOINT <span class="hljs-keyword">of</span> the image&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--env-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add or update an &nbsp;</span>
environment <span class="hljs-keyword">variable</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--env-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove an environment &nbsp;</span>
<span class="hljs-keyword">variable</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--force&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Force update even if &nbsp;</span>
<span class="hljs-keyword">no</span> changes require it&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--generic-resource-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add a Generic resource&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--generic-resource-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a Generic &nbsp;</span>
<span class="hljs-keyword">resource</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--group-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add an additional &nbsp;</span>
supplementary <span class="hljs-keyword">user</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">to</span> the <span class="hljs-keyword">container</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--group-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a previously &nbsp;</span>
added supplementary <span class="hljs-keyword">user</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">from</span> the <span class="hljs-keyword">container</span><b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--health-cmd string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Command to run to &nbsp;</span>
<span class="hljs-keyword">check</span> health</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--health-interval duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Time between running &nbsp;</span>
the <span class="hljs-keyword">check</span> (ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--health-retries int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Consecutive failures &nbsp;</span>
needed <span class="hljs-keyword">to</span> report unhealthy&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--health-start-period duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Start period for the &nbsp;</span>
<span class="hljs-keyword">container</span> <span class="hljs-keyword">to</span> initialize <span class="hljs-keyword">before</span> counting retries towards unstable &nbsp;
(ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--health-timeout duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum time to allow &nbsp;</span>
one <span class="hljs-keyword">check</span> <span class="hljs-keyword">to</span> run (ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--host-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add a custom host-to-IP &nbsp;</span>
<span class="hljs-keyword">mapping</span> (host:ip)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--host-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a custom host-to-IP&nbsp;</span>
<span class="hljs-keyword">mapping</span> (host:ip)<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--hostname string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Container hostname</span></b><span class="hljs-comment">&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--image string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Service image tag&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--init&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Use an init inside &nbsp;</span>
<span class="hljs-keyword">each</span> service <span class="hljs-keyword">container</span> <span class="hljs-keyword">to</span> forward signals <span class="hljs-keyword">and</span> reap processes&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--isolation string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Service container &nbsp;</span>
<span class="hljs-keyword">isolation</span> <span class="hljs-keyword">mode</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--label-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add or update a &nbsp;</span>
service label&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--label-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a label by its key</span><b><span class="hljs-comment">&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--limit-cpu decimal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Limit CPUs&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--limit-memory bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Limit Memory</span></b><span class="hljs-comment">&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--log-driver string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logging driver for &nbsp;</span>
service&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--log-opt list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Logging driver options&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--mount-add mount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a mount &nbsp;</span>
<span class="hljs-keyword">on</span> a service&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--mount-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a mount by its &nbsp;</span>
target <span class="hljs-keyword">path</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--network-add network&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add a network&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--network-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a network&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--no-healthcheck&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Disable any container-&nbsp;</span>
specified HEALTHCHECK&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--no-resolve-image&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Do not query the &nbsp;</span>
registry <span class="hljs-keyword">to</span> resolve image digest <span class="hljs-keyword">and</span> supported platforms&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--placement-pref-add pref&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add a placement &nbsp;</span>
preference&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--placement-pref-rm pref&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a placement &nbsp;</span>
preference&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--publish-add port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Add or update a &nbsp;</span>
published port&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--publish-rm port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Remove a published &nbsp;</span>
port <span class="hljs-keyword">by</span> its target port&nbsp;
&nbsp;&nbsp;-q, <span class="hljs-comment">--quiet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Suppress progress &nbsp;</span>
<span class="hljs-keyword">output</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--read-only&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mount the container’s &nbsp;</span>
root filesystem <span class="hljs-keyword">as</span> <span class="hljs-keyword">read</span> <span class="hljs-keyword">only</span><b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--replicas uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Number of tasks&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--replicas-max-per-node uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Maximum number of &nbsp;</span>
tasks per node (<span class="hljs-keyword">default</span> <span class="hljs-number">0</span> = <span class="hljs-keyword">unlimited</span>)</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--reserve-cpu decimal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reserve CPUs&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--reserve-memory bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Reserve Memory&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--restart-condition string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Restart when condition &nbsp;</span>
<span class="hljs-keyword">is</span> met (<span class="hljs-string">"none"</span>|<span class="hljs-string">"on-failure"</span>|<span class="hljs-string">"any"</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--restart-delay duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Delay between restart &nbsp;</span>
attempts (ns|us|ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--restart-max-attempts uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum number of &nbsp;</span>
restarts <span class="hljs-keyword">before</span> giving up&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--restart-window duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Window used to &nbsp;</span>
<span class="hljs-keyword">evaluate</span> the restart <span class="hljs-keyword">policy</span> (ns|us|ms|s|m|h)<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rollback to previous &nbsp;</span>
specification</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-delay duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Delay between task &nbsp;</span>
rollbacks (ns|us|ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-failure-action string&nbsp;&nbsp;&nbsp;&nbsp; Action on rollback &nbsp;</span>
<span class="hljs-keyword">failure</span> (<span class="hljs-string">"pause"</span>|<span class="hljs-string">"continue"</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-max-failure-ratio float&nbsp;&nbsp; Failure rate to &nbsp;</span>
tolerate during a <span class="hljs-keyword">rollback</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-monitor duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Duration after each &nbsp;</span>
task <span class="hljs-keyword">rollback</span> <span class="hljs-keyword">to</span> monitor <span class="hljs-keyword">for</span> <span class="hljs-keyword">failure</span> (ns|us|ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-order string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rollback order &nbsp;</span>
(<span class="hljs-string">"start-first"</span>|<span class="hljs-string">"stop-first"</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--rollback-parallelism uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum number of &nbsp;</span>
tasks rolled back simultaneously (<span class="hljs-number">0</span> <span class="hljs-keyword">to</span> roll back <span class="hljs-keyword">all</span> <span class="hljs-keyword">at</span> once)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--secret-add secret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a secret &nbsp;</span>
<span class="hljs-keyword">on</span> a service&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--secret-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a secret&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--stop-grace-period duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Time to wait before &nbsp;</span>
<span class="hljs-keyword">force</span> killing a <span class="hljs-keyword">container</span> (ns|us|ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--stop-signal string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Signal to stop the &nbsp;</span>
<span class="hljs-keyword">container</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--sysctl-add list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add or update a Sysctl &nbsp;</span>
<span class="hljs-keyword">option</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--sysctl-rm list&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Remove a Sysctl option&nbsp;</span>
&nbsp;&nbsp;-t, <span class="hljs-comment">--tty&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Allocate a pseudo-TTY</span><b><span class="hljs-comment">&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--update-delay duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Delay between updates &nbsp;</span>
(ns|us|ms|s|m|h)</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--update-failure-action string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Action on update &nbsp;</span>
<span class="hljs-keyword">failure</span> (<span class="hljs-string">"pause"</span>|<span class="hljs-string">"continue"</span>|<span class="hljs-string">"rollback"</span>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--update-max-failure-ratio float&nbsp;&nbsp;&nbsp;&nbsp; Failure rate to &nbsp;</span>
tolerate during an <span class="hljs-keyword">update</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--update-monitor duration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Duration after each &nbsp;</span>
task <span class="hljs-keyword">update</span> <span class="hljs-keyword">to</span> monitor <span class="hljs-keyword">for</span> <span class="hljs-keyword">failure</span> (ns|us|ms|s|m|h)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">--update-order string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Update order ("start-&nbsp;</span>
<span class="hljs-keyword">first</span><span class="hljs-string">"|"</span><span class="hljs-keyword">stop</span>-<span class="hljs-keyword">first</span><span class="hljs-string">")</span><b><span class="hljs-string">&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--update-parallelism uint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum number of &nbsp;
tasks updated simultaneously (0 to update all at once)</span></b><span class="hljs-string">&nbsp;
&nbsp;&nbsp;-u, --user string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Username or UID &nbsp;
(format: &lt;name|uid&gt;[:&lt;group|gid&gt;])&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--with-registry-auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Send registry &nbsp;
authentication details to swarm agents&nbsp;
&nbsp;&nbsp;-w, --workdir string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Working directory &nbsp;
inside the container</span></code></pre>
          <p class="defaut">Sans rentrer dans les détails, on
voit rapidement qu’il est possible de jouer sur de nombreuses options,
dont (en gras ci-dessus)&nbsp;:</p>
          <div class="divliste1">
            <ul class="liste1">
              <li class="liste1">
                <p class="liste1">l’ajout de contraintes
(voir section suivante)&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">la gestion DNS&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">la déclaration de l’état
de santé des services&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">le nom d’hôte à utiliser&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">les quotas en tranches de CPU ou
en mémoire&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">le nombre de répliques&nbsp;;</p>
              </li>
              <li class="liste1">
                <p class="liste1">le rollback et les mécanismes
d’update, comme nous venons de les décrire.</p>
              </li>
            </ul>
          </div>
        </div>
        <div class="sect3" id="refTitle31">
          <h3 class="title">d. Gestion des contraintes<var style="display:none"> Contraintes</var></h3>
          <p class="defaut">Un autre mécanisme intéressant à citer
rapidement est celui des contraintes. Les contraintes décrivent
des associations entre les libellés portés sur
les démons Docker et les libellés portés
par les services. Ainsi, il est possible par exemple d’établir
une contrainte faisant en sorte que les conteneurs correspondant à un
service en particulier soient démarrés sur une
machine précise du cluster Swarm.</p>
          <p class="defaut">Cela peut servir si des machines sont équipées
de disques durs rapides et que l’application utilise des bases de
données, car ces dernières seront bien plus efficaces
sur les premières, alors que les autres services en tireront
moins d’avantages. Dans le cas d’un cluster hybride, c’est-à-dire
mélangeant des démons Windows et des démons
Linux (une possibilité récente de Swarm), la gestion des
contraintes est même obligatoire car les images d’une architecture
ne s’exécuteront pas sur l’autre (l’exception étant
les images multiplateformes, que nous avons citées dans
le chapitre Création et gestion des images Docker).</p>
          <p class="defaut">Les contraintes peuvent également
permettre de prioriser le déploiement de conteneurs ayant
besoin de bonnes performances d’accès en lecture/écriture (bases
de données, serveur de cache, etc.) sur certains nodes
du cluster qui, par exemple, bénéficient de disques
durs rapides comme des SSD ou des disques flash.</p>
          <p class="defaut">La gestion des contraintes est donc une corde
importante à l’arc de l’administrateur applicatif Docker,
et il est recommandé de bien penser à faire porter
les bons libellés sur les images Docker, y compris si elles
ne sont pas prévues dans un premier temps pour fonctionner
dans un cluster. Ces métadonnées peuvent se révéler
précieuses après coup.</p>
        </div>
        <div class="sect3" id="refTitle32">
          <h3 class="title">e. Arrêt de la stack</h3>
          <p class="defaut">L’exemple étant terminé,
la seule manipulation restant à montrer sur la stack est
comment l’arrêter. La commande est simplissime&nbsp;:</p>
          <pre class="programlisting"><code class="hljs scss">ubuntu@Manager:~/sample-app-<span class="hljs-number">1</span><span class="hljs-variable">$</span><b><span class="hljs-variable">docker</span> stack rm mastack</b>&nbsp;
Removing service mastack_db&nbsp;
Removing service mastack_app&nbsp;
Removing network mastack_default</code></pre>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">L’application de cette commande est
quasi instantanée sur les services, mais les conteneurs
peuvent parfois rester actifs pendant quelques secondes avant disparition.</p>
            </div>
          </div>
          <p class="defaut">L’arrêt par la commande citée
ci-dessus est le seul moyen d’arrêter les services. En
effet,&nbsp;la définition de la stack, des services
qu’elle déclare et au final le lancement des conteneurs
pour répondre à l’état souhaité sont
tous rémanents, c’est-à-dire que cet état
global sera restauré lors du redémarrage des machines supportant
le cluster. Vous pouvez faire l’essai en arrêtant tout
le système puis en le redémarrant&nbsp;: les
services seront&nbsp;toujours là.</p>
          <p class="defaut">À titre de remarque, il n’est pas
nécessaire de supprimer la stack à chaque changement
du fichier <span class="courier11">docker-compose.yml</span>. Le
seul fait de relancer la même commande suffit à rafraîchir
les services qui en ont besoin dans la plupart des cas (pas pour
un changement de mode de déploiement de <span class="courier11">replicated</span> à <span class="courier11">global</span>, toutefois).</p>
        </div>
      </div>
      <div class="sect2" id="refTitle33">
        <h2 class="title">6. Mélanger déploiement Swarm et Traefik<var style="display:none"> Traefik</var></h2>
        <p class="defaut">Arrivé à ce stade, le déploiement
fonctionne correctement, mais l’application est dans le même état
que lors du déploiement manuel sur un Docker local et avant
que nous ne passions à Traefik, à savoir qu’elle
nécessiterait d’ajuster les liens pour être fonctionnelle.
La solution Traefik étant parfaitement adaptée pour
un démon local, nous allons la réutiliser dans
le cas d’un démon "virtuel" composé par un cluster
constitué par Docker en mode Swarm.</p>
        <div class="sect3" id="refTitle34">
          <h3 class="title">a. Fusion des grammaires précédentes</h3>
          <p class="defaut">Le fichier <span class="courier11">docker-compose.yml</span> doit
bien sûr être adapté pour tirer parti à la
fois de Traefik et du déploiement en mode Swarm. Pour cela,
le plus simple est de repartir du fichier <span class="courier11">docker-compose.yml</span> créé auparavant
pour l’exposition de notre application exemple par Traefik et de
lui appliquer le même traitement que lors du passage en
mode Swarm, à savoir supprimer tout ce qui a trait aux
attributs <span class="courier11">container_name</span>, <span class="courier11">links</span>, <span class="courier11">restart</span> et <span class="courier11">depends_on</span>. Comme précédemment,
nous supprimerons toute exposition de la base de données
par le port 27017, et nous passerons la version en 3. Enfin, les
paramétrages de connexion à la base de données
seront modifiés pour pointer sur le nom DNS du service, à savoir <span class="courier11">mo-database</span>. Le résultat
devrait&nbsp;alors se présenter comme suit&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">version: ’<span class="hljs-number">3</span>’&nbsp;
services:&nbsp;
&nbsp;
&nbsp;&nbsp;traefik:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: traefik:<span class="hljs-number">1.7</span><span class="hljs-number">.26</span>-alpine&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">80</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">88</span>:<span class="hljs-number">8080</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;volumes:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-regexp">/var/</span>run/docker.sock:<span class="hljs-regexp">/var/</span>run/docker.sock&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;command: --web --docker --&nbsp;
docker.domain=enidocker.francecentral.cloudapp.azure.com --&nbsp;
logLevel=DEBUG&nbsp;
&nbsp;
&nbsp;&nbsp;mo-welcome:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/welcome&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./welcome&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.racine.frontend.rule: <span class="hljs-string">"Path: /"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.styles.frontend.rule: <span class="hljs-string">"Path: /style.css"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.pages.frontend.rule: <span class="hljs-string">"Path: /{.*}.html"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.images.frontend.rule: <span class="hljs-string">"PathPrefix: /images/"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;
&nbsp;&nbsp;mo-parametrage:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/parametrage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./parametrage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /parametrage"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_PARAM=mongodb:<span class="hljs-comment">//mo-database:27017&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demandes-bo:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demandes-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demandes-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /demandes-backoffice"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_DEMANDES=mongodb:<span class="hljs-comment">//mo-database:27017&nbsp;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demande-creer:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demande-creer&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demande-creer&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /demande-creer"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demande-remplir:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demande-remplir&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demande-remplir&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /demande-remplir"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-demandes-liste:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/demandes-liste&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./demandes-liste&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /demandes-liste"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-decisions-bo:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/decisions-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./decisions-backoffice&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /decisions-backoffice"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_DECISIONS=mongodb:<span class="hljs-comment">//mo-database:27017&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-decisions:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/decisions&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./decisions&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /decisions"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_BASE=http:<span class="hljs-comment">//enidocker.francecentral.cloudapp.azure.com&nbsp;</span>
&nbsp;
&nbsp;&nbsp;mo-database:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: mongo:<span class="hljs-number">3.6</span><span class="hljs-number">.4</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;volumes:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- mongodata:<span class="hljs-regexp">/data/</span>db&nbsp;
&nbsp;
volumes:&nbsp;
&nbsp;&nbsp;mongodata:</code></pre>
          <p class="defaut">Le lancement a l’air de se passer correctement&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">azureuser</span>@<span class="hljs-keyword">ClearDockerENI</span>~/<span class="hljs-keyword">middleoffice</span>-<span class="hljs-keyword">microservices</span>-<span class="hljs-keyword">v2</span> $ docker &nbsp;
stack deploy -c ./docker-compose.yml mastack&nbsp;
Ignoring unsupported options: build&nbsp;
&nbsp;
Creating network mastack_default&nbsp;
Creating service mastack_traefik&nbsp;
Creating service mastack_mo-parametrage&nbsp;
Creating service mastack_mo-decisions-bo&nbsp;
Creating service mastack_mo-database&nbsp;
Creating service mastack_mo-welcome&nbsp;
Creating service mastack_mo-demande-creer&nbsp;
Creating service mastack_mo-demandes-bo&nbsp;
Creating service mastack_mo-decisions&nbsp;
Creating service mastack_mo-demande-remplir&nbsp;
Creating service mastack_mo-demandes-liste</code></pre>
          <p class="defaut">Mais dès le premier clic sur un lien,
une erreur 404 apparaît&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP28.png" title="images/06EP28.png" src="IMAGES/06EP28.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
        </div>
        <div class="sect3" id="refTitle35">
          <h3 class="title">b. Passer Traefik en mode Swarm</h3>
          <p class="defaut">Le premier réflexe est de mettre à jour
les paramètres de Traefik, car pour l’instant, il tourne
en mode Docker standard, mais il est nécessaire de lui
indiquer de passer en mode Swarm, vu le contexte.</p>
          <p class="defaut">Pour cela, il est nécessaire de modifier
la commande de lancement de Traefik dans le fichier <span class="courier11">docker-compose.yml</span> pour qu’elle contienne
les paramètres additionnels suivants&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">&nbsp;&nbsp;&nbsp;&nbsp;command: <span class="hljs-comment">--web&nbsp;</span><b><span class="hljs-comment">--docker --docker.swarmmode --docker.watch</span></b><span class="hljs-comment">&nbsp;</span>
<span class="hljs-comment">--docker.domain=enidocker.francecentral.cloudapp.azure.com </span>
<span class="hljs-comment">--logLevel=DEBUG</span></code></pre>
          <p class="defaut">De cette manière, Traefik sera au
courant qu’il s’agit d’un mode Swarm et observera (watch) le fichier <span class="courier11">/var/run/docker.sock</span> en
connaissance de cause, lui permettant de pointer sur des backends
qui ne sont plus obligatoirement locaux mais peuvent être
sur n’importe quel nœud du cluster.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">À bien y réfléchir,
ce mode de fonctionnement implique une contrainte que nous laissons
au lecteur le soin de deviner, avant de montrer dans la section suivante
la solution au problème associé.</p>
            </div>
          </div>
        </div>
        <div class="sect3" id="refTitle36">
          <h3 class="title">c. Correction du placement de Traefik</h3>
          <p class="defaut">Le fichier étant modifié,
nous relançons la commande <span class="courier11">docker
stack deploy -c ./docker-compose.yml mastack</span> pour
vérifier si le fonctionnement est correct, mais l’erreur
404 est toujours présente lors de l’appel de la fenêtre
principale de l’application. Pour déboguer ce comportement
incorrect, il est d’abord nécessaire de vérifier
que tous les services se sont lancés, et c’est bien le
cas&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">azureuser</span>@<span class="hljs-keyword">ClearDockerENI</span>~/<span class="hljs-keyword">middleoffice</span>-<span class="hljs-keyword">microservices</span>-<span class="hljs-keyword">v2</span> $ docker &nbsp;
service ls&nbsp;
ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MODE&nbsp;&nbsp;
REPLICAS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PORTS&nbsp;
limho99q1og4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-database&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mongo:<span class="hljs-number">3.6</span>.<span class="hljs-number">4</span>&nbsp;
t7z19gs03pi7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-decisions&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/decisions:latest&nbsp;
<span class="hljs-number">3</span>dtunrecnxx1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-decisions-bo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/decisions-backoffice:latest&nbsp;
<span class="hljs-number">1</span>ett31o6qnka&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-demande-creer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/demande-creer:latest&nbsp;
<span class="hljs-number">41</span>bva87f2c7c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-demande-remplir&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/demande-remplir:latest&nbsp;
i86q4vv0y46g&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-demandes-bo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/demandes-backoffice:latest&nbsp;
vvne73ncg73u&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-demandes-liste&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/demandes-liste:latest&nbsp;
drwik4ivwue7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-parametrage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/parametrage:latest&nbsp;
mnbt7humndoi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_mo-welcome&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; middleoffice/welcome:latest&nbsp;
<span class="hljs-number">24</span>jtsswwpfqr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mastack_traefik&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replicated&nbsp;&nbsp;
<span class="hljs-number">1</span>/<span class="hljs-number">1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; traefik:<span class="hljs-number">1.7</span>.<span class="hljs-number">26</span>-alpine&nbsp;&nbsp;
*:<span class="hljs-number">80</span>-&gt;<span class="hljs-number">80</span>/tcp, *:<span class="hljs-number">88</span>-&gt;<span class="hljs-number">8080</span>/tcp</code></pre>
          <p class="defaut">Comme il s’agit d’une erreur 404 et que c’est
le service Traefik qui expose les contenus à l’extérieur,
il est logique de continuer en regardant les logs du service <span class="courier11">mastack_traefik</span>,&nbsp;et
des messages à répétition attirent l’attention&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">azureuser@ClearDockerENI~/middleoffice-microservices-v2 $ docker &nbsp;
service logs mastack_traefik&nbsp;
mastack_traefik.1.kup6jx7pu4z5@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
time="2020-10-11T14:55:19Z" level=warning msg="web provider &nbsp;
configuration is deprecated, you should <span class="hljs-keyword">use</span> these options&nbsp;: api, &nbsp;
rest provider, ping <span class="hljs-keyword">and</span> metrics<span class="hljs-string">"&nbsp;
&nbsp;
(...)&nbsp;
&nbsp;
mastack_traefik.1.kup6jx7pu4z5@&nbsp;</span><b><span class="hljs-string">ClearLinux-worker2</span></b><span class="hljs-string">&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>T14:<span class="hljs-number">55</span>:<span class="hljs-number">19</span>Z<span class="hljs-string">" level=info msg="</span><span class="hljs-keyword">Starting</span> <span class="hljs-keyword">server</span> <span class="hljs-keyword">on</span>&nbsp;:&nbsp;
<span class="hljs-number">80</span><span class="hljs-string">"&nbsp;
mastack_traefik.1.kup6jx7pu4z5@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>T14:<span class="hljs-number">55</span>:<span class="hljs-number">19</span>Z<span class="hljs-string">" level=info msg="</span><span class="hljs-keyword">Starting</span> <span class="hljs-keyword">server</span> <span class="hljs-keyword">on</span>&nbsp;:&nbsp;
<span class="hljs-number">8080</span><span class="hljs-string">"&nbsp;
mastack_traefik.1.kup6jx7pu4z5@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
time="</span><span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>T14:<span class="hljs-number">55</span>:<span class="hljs-number">19</span>Z<span class="hljs-string">" level=info msg="</span><span class="hljs-keyword">Starting</span> provider &nbsp;
*docker.Provider 
{\<span class="hljs-string">"Watch\":true,\"Filename\":\"\",\"Constraints\":null,\"Trace\":&nbsp;
false,\"TemplateVersion\":2,\"DebugLogGeneratedTemplate\":false,\&nbsp;
"</span>Endpoint\<span class="hljs-string">":\"unix:///var/run/docker.sock\",\"Domain\":\&nbsp;
"</span>enidocker.francecentral.cloudapp.azure.com\<span class="hljs-string">",\"TLS\":null,\&nbsp;
"</span>ExposedByDefault\<span class="hljs-string">":true,\"UseBindPortIP\":false,\"SwarmMode\&nbsp;
"</span>:<span class="hljs-literal">true</span>,\<span class="hljs-string">"Network\":\"\",\"SwarmModeRefreshSeconds\":15}"</span>&nbsp;
mastack_traefik<span class="hljs-number">.1</span>.kup6jx7pu4z5@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
<span class="hljs-built_in">time</span>=<span class="hljs-string">"2020-10-11T14:55:19Z"</span> <span class="hljs-keyword">level</span>=debug msg=<span class="hljs-string">"Provider connection &nbsp;
established with docker 19.03.8 (API 1.40)"</span>&nbsp;
mastack_traefik<span class="hljs-number">.1</span>.kup6jx7pu4z5@ClearLinux-worker2&nbsp;&nbsp;&nbsp;&nbsp;| &nbsp;
<span class="hljs-built_in">time</span>=<span class="hljs-string">"2020-10-11T14:55:19Z"</span> <span class="hljs-keyword">level</span>=<span class="hljs-keyword">error</span> msg=&nbsp;<span class="hljs-string">"</span><b><span class="hljs-string">Failed to list &nbsp;
services for docker swarm mode, error Error response from daemon: &nbsp;
This node is not a swarm manager. Worker nodes can’t be used to view &nbsp;
or modify cluster state. Please run this command on a manager node &nbsp;
or promote the current node to a manager.</span></b><span class="hljs-string">"</span>&nbsp;
&nbsp;
(...)</code></pre>
          <p class="defaut">Comme nous n’avons rien spécifié de
particulier, Traefik a été lancé sur
un node au hasard, et il s’agit dans notre cas du second de type
worker. Or, les messages expliquent&nbsp;que Traefik ne peut
pas lister les services car il ne se trouve pas sur un node de type
manager et n’a donc pas accès aux informations centralisées
qui lui sont nécessaires&nbsp;pour brancher dynamiquement
les conteneurs sur les frontends associés. La proposition
associée est de faire tourner Traefik sur un node manager
ou bien de promouvoir le node courant à ce rôle.
C’est bien sûr la première solution qui sera suivie.&nbsp;</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Il est possible que ces messages n’apparaissent
pas dans vos logs si le service Traefik s’est - par hasard - lancé sur
un node de type manager. Il n’en reste pas moins que la configuration
pose problème.</p>
            </div>
          </div>
          <p class="defaut">Pour cela, nous allons utiliser une contrainte
(concept présenté un peu plus haut) pour amener
Docker à placer Traefik sur un node du cluster qui soit
effectivement manager, en ajoutant le code ci-dessous dans la définition
du service <span class="courier11">traefik</span>&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">version: ’<span class="hljs-number">3</span>’&nbsp;
services:&nbsp;
&nbsp;
&nbsp;&nbsp;traefik:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: traefik:<span class="hljs-number">1.7</span><span class="hljs-number">.26</span>-alpine&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ports:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">80</span>:<span class="hljs-number">80</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-number">88</span>:<span class="hljs-number">8080</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;volumes:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="hljs-regexp">/var/</span>run/docker.sock:<span class="hljs-regexp">/var/</span>run/docker.sock&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;command: --web --docker --docker.swarmmode --docker.watch --&nbsp;
docker.domain=enidocker.francecentral.cloudapp.azure.com --&nbsp;
logLevel=DEBUG<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;deploy:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;placement:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;constraints:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- node.role == manager</b>&nbsp;
&nbsp;
(...)</code></pre>
          <p class="defaut">En relançant le déploiement,
les messages d’erreur sont désormais absents, et une commande <span class="courier11">docker ps</span> montre que le service Traefik
est effectivement déployé sur le manager.</p>
        </div>
        <div class="sect3" id="refTitle37">
          <h3 class="title">d. Correction de la grammaire sur les labels</h3>
          <p class="defaut">Nous ne sommes toutefois pas au bout de nos
peines, car l’appel de la page d’accueil de l’application exemple
Middle Office se solde encore une fois par une erreur 404. Par contre,
Traefik fonctionne correctement, et en consultant son écran
de contrôle que nous avons exposé sur le port
88 (il tourne d’origine sur le 8080), nous voyons bien le problème, à savoir
qu’aucune règle de frontend n’est passée&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP28a.png" title="images/06EP28a.png" src="IMAGES/06EP28a.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Cette fois, il s’agit d’une simple erreur
de grammaire, qu’on peut diagnostiquer en comparant la sortie d’un <span class="courier11">docker service inspect</span> sur un service
qui fonctionne correctement (lancé en ligne de commande)
et un service posant problème (décrit dans le
fichier <span class="courier11">docker-compose.yml</span>)&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP29.png" title="images/06EP29.png" src="IMAGES/06EP29.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">Le problème vient des labels qui
ne sont pas au bon endroit&nbsp;: ils sont pris sur le conteneur
et non pas sur le déploiement. La grammaire Docker Compose
a évolué sur ce point en version 3 et nous ne
l’avions pas suivie lors de notre passage en version supérieure.
La correction consiste à placer les contenus <span class="courier11">labels</span> dans une section <span class="courier11">deploy</span> de niveau supérieur,
en réalisant bien sûr cette commande sur tous
les services, même si la grammaire n’est spécifiée
ci-dessous que sur un d’entre eux qui nous sert d’exemple&nbsp;:</p>
          <pre class="programlisting"><code class="hljs javascript">&nbsp;&nbsp;mo-parametrage:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;image: middleoffice/parametrage&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;build: ./parametrage<b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;deploy:</b>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;labels:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.frontend.rule: <span class="hljs-string">"PathPrefixStrip: /parametrage"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traefik.port: <span class="hljs-string">"80"</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;environment:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- URL_SRV_DB_PARAM=mongodb:<span class="hljs-comment">//mo-database:27017</span></code></pre>
          <p class="defaut">En relançant la commande, tous les
services se mettent à jour&nbsp;:</p>
          <pre class="programlisting"><code class="hljs css"><span class="hljs-selector-tag">azureuser</span>@<span class="hljs-keyword">ClearDockerENI</span>~/<span class="hljs-keyword">middleoffice</span>-<span class="hljs-keyword">microservices</span>-<span class="hljs-keyword">v2</span> $ docker &nbsp;
stack deploy -c ./docker-compose.yml mastack&nbsp;
Ignoring unsupported options: build&nbsp;
&nbsp;
Updating service mastack_mo-database (id: uuk8mfysk12037hdxllc5ywt9)&nbsp;
Updating service mastack_mo-decisions (id: lyo2kk3kifpukjlpxz4n7nh6d)&nbsp;
Updating service mastack_mo-demande-creer (id: <span class="hljs-number">6</span>eap96b2q3cijnf8nuwerdcdu)&nbsp;
Updating service mastack_mo-demande-remplir (id: ilpwegq92jwdycibw445tddnh)&nbsp;
Updating service mastack_mo-demandes-liste (id: qe7hpmd0v3p8smbp6jmh5slku)&nbsp;
Updating service mastack_mo-parametrage (id: <span class="hljs-number">0</span>ich6gh0l7mkoz4icea7u49lz)&nbsp;
Updating service mastack_mo-demandes-bo (id: knnya1vp7l8dnx3ys2caws5cm)&nbsp;
Updating service mastack_mo-decisions-bo (id: t9df7uzidqshh8nrbzlj3k27y)&nbsp;
Updating service mastack_traefik (id: txn8yjuhee97f04mbexgpdeho)&nbsp;
Updating service mastack_mo-welcome (id: cl4rg4gpxw7mequw7d95vntzo)</code></pre>
          <p class="defaut">Et après quelques secondes d’attente,
l’affichage du dashboard Traefik montre que la situation est revenue à la
normale sur les règles de distribution&nbsp;:</p>
          <div class="image">
            <div class="mediaobject"><img class="imagedata picturebox" alt="images/06EP30.png" title="images/06EP30.png" src="IMAGES/06EP30.png?id=AAEAAAD%2f%2f%2f%2f%2fAQAAAAAAAAAMAgAAAE1FbmkuRWRpdGlvbnMuTWVkaWFwbHVzLCBWZXJzaW9uPTEuMC4wLjAsIEN1bHR1cmU9bmV1dHJhbCwgUHVibGljS2V5VG9rZW49bnVsbAUBAAAAJ0VuaS5FZGl0aW9ucy5NZWRpYXBsdXMuQ29tbW9uLldhdGVybWFyawIAAAAHcGlzVGV4dAlwaWR0ZURhdGUBAA0CAAAABgMAAAAyTGF2b2NvIEVuem8gLSBiNGFhNGUzYy01ODBkLTQyNWQtOWMwOC1mNDBjMjRlNTY0ZmOOE6Gvy7jYiAs%3d"></div>
          </div>
          <p class="defaut">On notera au passage que les adresses IP des
backends sont différentes, ce qui montre bien qu’on se
trouve en mode Swarm, avec des conteneurs répartis sur des
nodes différents du cluster.</p>
          <div class="note">
            <div class="remarkimg"><span class="icon-note"></span></div>
            <div class="divinline">
              <p class="remarque">Attention à bien attendre
quelques secondes de plus même lorsque ces règles
sont affichées&nbsp;pour tester l’application. En effet,
certains conteneurs peuvent être lancés mais pas
encore réactifs. De plus, comme nous n’avons plus la gestion
des dépendances, il n’est pas impossible qu’un conteneur,
ne voyant pas une dépendance dont il a besoin, décide
de se relancer pour revenir plus tard sous une autre instance. Ce
démarrage&nbsp;progressif est aussi un gage de plus
grande solidité une fois le système bien en place.</p>
            </div>
          </div>
          <p class="defaut">Pour finir de tester l’application, il convient
de déployer les types de demandes, avec Postman par exemple,
puis de tester un scénario complet de création
et de validation d’une demande, mais ceci a déjà été montré précédemment
et nous ne reviendrons pas sur les actions précises à réaliser.</p>
        </div>
        <div class="sect3" id="refTitle38">
          <h3 class="title">e. Note sur Traefik V2</h3>
          <p class="defaut">Il y aurait encore énormément
de fonctionnalités de Traefik à montrer, comme
le support HTTPS avec Let’s Encrypt, l’utilisation de fichiers de
paramétrages TOML, le branchement sur d’autres orchestrateurs
que Docker Swarm, les règles complexes de liaison entre
frontends et backends, la gestion de la robustesse, de l’affinité,
etc.</p>
          <p class="defaut">Dans le log un peu plus haut, il était
indiqué également que le mode "web" utilisé était
désormais déprécié et qu’il
convenait de le remplacer par une option particulière parmi
celles proposées&nbsp;:</p>
          <pre class="programlisting"><code class="hljs sql">level=warning msg="web provider configuration is deprecated, &nbsp;
you should <span class="hljs-keyword">use</span> these options&nbsp;: api, rest provider, ping <span class="hljs-keyword">and</span> metrics<span class="hljs-string">"</span></code></pre>
          <p class="defaut">Et si on considère la version 2,
il conviendrait de se pencher sur les middlewares, la gestion du
routage et d’autres fonctionnalités encore…</p>
          <p class="defaut">Bref, il y aurait de quoi écrire
un livre complet sur Traefik. Or, notre but dans ce chapitre&nbsp;est
de montrer les interactions (fortes) qu’ont les orchestrateurs avec
Docker. Parler de Traefik semblait nécessaire pour montrer
une façon propre et efficace de gérer&nbsp;le
problème de l’exposition des services, mais afin de ne
pas surcharger cet ouvrage,&nbsp;il a été décidé de
se restreindre aux fonctionnalités montrées jusqu’ici.
Le reste n’apportera pas grand-chose de plus sur la compréhension
de Docker, qui doit rester notre fil rouge.</p>
        </div>
      </div>
    </div></div></div></div></app-page-content><!----><!----><!----></div></kendo-pdf-export>